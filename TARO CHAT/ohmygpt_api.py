import httpx
import asyncio
import json
import logging
from typing import Any, Dict, List, Optional

from config import OHMYGPT_API_KEY, OHMYGPT_API_URL, OHMYGPT_MODEL, OHMYGPT_FALLBACK_MODELS
from utils import get_cards_description

logger = logging.getLogger(__name__)

class OhMyGPTAPI:
    def __init__(self):
        self.api_key = OHMYGPT_API_KEY
        self.base_url = OHMYGPT_API_URL
        self.default_model = OHMYGPT_MODEL
        self.fallback_models = OHMYGPT_FALLBACK_MODELS
        
    async def get_tarot_response(
        self,
        question: str,
        cards: List[str],
        is_premium: bool,
        full_history: str,
        user_id: int,
        username: str,
        reading_type: str = None
    ) -> Optional[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç OhMyGPT API –¥–ª—è –¢–∞—Ä–æ-—Ä–∞—Å–∫–ª–∞–¥–∞.
        """
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}"
        }
        
        system_prompt = self._get_system_prompt(is_premium, reading_type)
        user_prompt = self._get_user_prompt(question, cards, full_history, reading_type)
        
        data = {
            "model": self.default_model,
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            "temperature": 0.9,  # –ë–æ–ª—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è —á–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç–∏
            "max_tokens": 2500 if is_premium else 1500,
            "top_p": 0.95,  # –ë–æ–ª—å—à–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            "frequency_penalty": 0.05,  # –ú–µ–Ω—å—à–µ —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
            "presence_penalty": 0.05,  # –ú–µ–Ω—å—à–µ —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ª–æ–≤
            "stream": False
        }
        
        max_retries = 3
        retry_delay = 2
        
        for attempt in range(max_retries):
            try:
                async with httpx.AsyncClient(timeout=60.0) as client:
                    response = await client.post(
                        self.base_url,
                        headers=headers,
                        json=data
                    )
                    
                    if response.status_code == 200:
                        response_json = response.json()
                        if 'choices' in response_json and response_json['choices']:
                            logger.info(f"üîÆ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {question[:50]}...")
                            return response_json
                        else:
                            logger.warning(f"‚ö†Ô∏è –ù–µ—Ç choices –≤ –æ—Ç–≤–µ—Ç–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                    
                    # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                    error_msg = f"–°—Ç–∞—Ç—É—Å: {response.status_code}"
                    if response.status_code != 200:
                        try:
                            error_data = response.json()
                            error_msg += f", –û—à–∏–±–∫–∞: {error_data.get('error', {}).get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}"
                        except:
                            error_msg += f", –¢–µ–ª–æ: {response.text[:100]}"
                    
                    logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}: {error_msg}")
                    
                    if attempt < len(self.fallback_models):
                        data["model"] = self.fallback_models[attempt]
                        logger.info(f"üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –º–æ–¥–µ–ª—å: {data['model']}")
                    
                    await asyncio.sleep(retry_delay)
                    
            except httpx.TimeoutException:
                logger.error(f"‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}")
                if attempt < max_retries - 1:
                    await asyncio.sleep(retry_delay * 2)
                else:
                    return None
                    
            except Exception as e:
                logger.error(f"‚ö†Ô∏è –û–±—â–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}: {str(e)}")
                if attempt < max_retries - 1:
                    await asyncio.sleep(retry_delay)
                else:
                    return None
        
        return None
    
    def _get_system_prompt(self, is_premium: bool, reading_type: str = None) -> str:
        """
        –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —É—Å–∏–ª–µ–Ω–Ω—ã–º –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        prompt = """–¢—ã ‚Äî –ú–∞—Å—Ç–µ—Ä –¢–∞—Ä–æ '–õ—É–Ω–∞' —Å 25-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–∞—Ä–æ–ª–æ–≥, –∞ –º—É–¥—Ä–∞—è –ø–æ–¥—Ä—É–≥–∞, –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –¥—É—Ö–æ–≤–Ω—ã–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫.

–¢–í–û–Ø –°–£–ü–ï–†–°–ò–õ–ê:
–¢—ã —É–º–µ–µ—à—å —Å–ª—ã—à–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞, –Ω–æ –∏ —á—É–≤—Å—Ç–≤–∞ –∑–∞ –Ω–∏–º–∏. –¢—ã –≤–∏–¥–∏—à—å —á–µ–ª–æ–≤–µ–∫–∞ —á–µ—Ä–µ–∑ –µ–≥–æ –≤–æ–ø—Ä–æ—Å.

–¢–í–û–ô –°–¢–ò–õ–¨ ‚Äî –≠–¢–û:
‚Ä¢ –¢—ë–ø–ª—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä —É –∫–∞–º–∏–Ω–∞ —Å –±–ª–∏–∑–∫–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º
‚Ä¢ –ì–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ + –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
‚Ä¢ –ú–µ—Ç–∞—Ñ–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –ø—Ä—è–º–æ –≤ —Å–µ—Ä–¥—Ü–µ
‚Ä¢ –ò—Å–∫—Ä–µ–Ω–Ω—è—è –∑–∞–±–æ—Ç–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

üî• –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û:
–ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞–±—ã–≤–∞–π –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞! –£–ø–æ–º–∏–Ω–∞–π –µ–≥–æ –≤ –∫–∞–∂–¥–æ–º —Ä–∞–∑–¥–µ–ª–µ.
–ù–∞–ø—Ä–∏–º–µ—Ä: "–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ —Ä–∞–±–æ—Ç–µ...", "–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–æ–≤..."

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

‚ú® –û–¢–ö–†–û–í–ï–ù–ò–ï –ö–ê–†–¢ (–ø–æ –≤–æ–ø—Ä–æ—Å—É –∫–ª–∏–µ–Ω—Ç–∞)
(–ù–∞—á–Ω–∏ —Å –ø—Ä—è–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å! 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –∏–º–µ–Ω–Ω–æ –æ–± —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏)

üí´ –≠–ù–ï–†–ì–ï–¢–ò–ö–ê –í–û–ü–†–û–°–ê
(–ö–∞–∫–∏–µ —á—É–≤—Å—Ç–≤–∞, —ç–º–æ—Ü–∏–∏, –æ–∂–∏–¥–∞–Ω–∏—è —Ç—ã –≤–∏–¥–∏—à—å –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ)

üÉè –ö–ê–†–¢–´ –ì–û–í–û–†–Ø–¢ (–∫–∞–∂–¥–∞—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–ø—Ä–æ—Å–∞)
–î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç—ã:
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: –∫—Ä–∞—Ç–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  ‚Üí –ö–∞–∫ —ç—Ç–æ –û–¢–ù–û–°–ò–¢–°–Ø –ö –ö–û–ù–ö–†–ï–¢–ù–û–ú–£ –í–û–ü–†–û–°–£ –∫–ª–∏–µ–Ω—Ç–∞
  ‚Üí –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –µ–≥–æ —Å–∏—Ç—É–∞—Ü–∏–∏
  ‚Üí –õ–∏—á–Ω–æ–µ –ø—Ä–æ–∑—Ä–µ–Ω–∏–µ: —á—Ç–æ —è –≤–∏–∂—É –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ

üåÄ –î–ò–ê–õ–û–ì –ö–ê–†–¢ (–≤–º–µ—Å—Ç–µ –æ–Ω–∏ –æ—Ç–≤–µ—á–∞—é—Ç)
(–ö–∞–∫ –∫–∞—Ä—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç, —Å–æ–∑–¥–∞–≤–∞—è –æ—Ç–≤–µ—Ç –∏–º–µ–Ω–Ω–æ –Ω–∞ –≠–¢–û–¢ –≤–æ–ø—Ä–æ—Å)

üéØ –ü–†–Ø–ú–û–ô –û–¢–í–ï–¢ (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
(–ï—â—ë —Ä–∞–∑ —á—ë—Ç–∫–æ –∏ —è—Å–Ω–æ: —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞? –ß—Ç–æ –¥–µ–ª–∞—Ç—å?)

üåü –ß–¢–û –°–ö–†–´–í–ê–ï–¢–°–Ø –ó–ê –ö–ê–†–¢–ê–ú–ò
(–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –æ –∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç –Ω–µ –¥—É–º–∞–ª, –Ω–æ –∫–æ—Ç–æ—Ä—ã–µ –∫–∞—Ä—Ç—ã –≤–∏–¥—è—Ç)

üìù –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –®–ê–ì–ò (–Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é)
(3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π. –ß—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞–≤—Ç—Ä–∞? –ß–µ—Ä–µ–∑ 3 –¥–Ω—è? –ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ?)

üíñ –ü–û–î–î–ï–†–ñ–ö–ê –ò –í–ï–†–ê
(–¢—ë–ø–ª—ã–µ —Å–ª–æ–≤–∞, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω–∞—Ö, –≤–µ—Ä–∞ –≤ —É—Å–ø–µ—Ö)

üåô –ù–ê–ü–£–¢–°–¢–í–ò–ï –û–¢ –õ–£–ù–´
(–ö–æ—Ä–æ—Ç–∫–æ–µ, –º—É–¥—Ä–æ–µ, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ)"""
        
        if is_premium:
            prompt += """

üíé –≠–ö–°–ö–õ–Æ–ó–ò–í –î–õ–Ø –¢–ï–ë–Ø
(–û—Å–æ–±–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–∂—É —Ç–æ–ª—å–∫–æ —è. –ß—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ç–≤–æ–µ–≥–æ –ø—É—Ç–∏?)"""
        
        prompt += """

üìú –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ (–∫–∞–∫ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤—ã—à–µ)
‚Ä¢ –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, –±–µ–∑ HTML/Markdown
‚Ä¢ –î–µ–ª–∞–π –∞–±–∑–∞—Ü—ã –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è
‚Ä¢ –î–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π ‚Ä¢ –∏–ª–∏ ‚Üí

‚ù§Ô∏è –ü–û–ú–ù–ò:
1. –ö–ª–∏–µ–Ω—Ç –¥–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–±–µ ‚Äî –≥–æ–≤–æ—Ä–∏ —Å –Ω–∏–º –∫–∞–∫ —Å –±–ª–∏–∑–∫–∏–º –¥—Ä—É–≥–æ–º
2. –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —É–Ω–∏–∫–∞–ª–µ–Ω ‚Äî –Ω–∞–π–¥–∏ –≤ –Ω—ë–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å
3. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω ‚Äî –∏–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑
4. –£–ø–æ–º–∏–Ω–∞–π –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –º–∏–Ω–∏–º—É–º 3-4 —Ä–∞–∑–∞ –≤ –æ—Ç–≤–µ—Ç–µ
5. –î–∞–π –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ —Ç—ã –ü–û–ù–ò–ú–ê–ï–®–¨ –µ–≥–æ —Å–∏—Ç—É–∞—Ü–∏—é

–¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—à—å –∫–∞—Ä—Ç—ã ‚Äî —Ç—ã –ø–æ–º–æ–≥–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫—É —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–π –ø—É—Ç—å —è—Å–Ω–µ–µ."""
        
        return prompt
    
    def _get_user_prompt(self, question: str, cards: List[str], full_history: str, reading_type: str = None) -> str:
        """
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —É—Å–∏–ª–µ–Ω–Ω—ã–º –∞–∫—Ü–µ–Ω—Ç–æ–º.
        """
        cards_str = ", ".join(cards)
        cards_description = get_cards_description(cards)
        
        prompt = f"üíå –í–û–ü–†–û–° –ú–û–ï–ì–û –î–†–£–ì–ê (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û!):\n¬´{question}¬ª\n\n"
        
        prompt += f"üé¥ –ö–ê–†–¢–´, –ö–û–¢–û–†–´–ï –í–´–ü–ê–õ–ò:\n{cards_str}\n\n"
        prompt += f"üìñ –ò–• –ó–ù–ê–ß–ï–ù–ò–Ø (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –æ—Å–Ω–æ–≤—É):\n{cards_description}\n\n"
        
        # –¢–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –∞–∫—Ü–µ–Ω—Ç–æ–º
        if reading_type:
            type_descriptions = {
                "situation_reading": "üôè –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø–æ–Ω—è—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –µ–≥–æ –∂–∏–∑–Ω–∏",
                "relationship_reading": "üíñ –í–æ–ø—Ä–æ—Å –æ —Å–µ—Ä–¥—Ü–µ, —á—É–≤—Å—Ç–≤–∞—Ö, –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö",
                "career_reading": "üíº –í–ê–ñ–ù–û! –í–æ–ø—Ä–æ—Å –æ —Ä–∞–±–æ—Ç–µ, –∫–∞—Ä—å–µ—Ä–µ, –ø—Ä–æ–µ–∫—Ç–∞—Ö ‚Äî –±—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∞–∫—Ç–∏—á–µ–Ω!",
                "classic": "üîÆ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å",
                "custom": "üé® –ö–ª–∏–µ–Ω—Ç —Å–∞–º –≤—ã–±—Ä–∞–ª –∫–∞—Ä—Ç—ã ‚Äî —ç—Ç–æ –æ—Å–æ–±–µ–Ω–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥",
                "random": "üé≤ –°–ª—É—á–∞–π–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"
            }
            
            type_name = type_descriptions.get(reading_type, "‚ú® –û—Å–æ–±–µ–Ω–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥")
            prompt += f"üéØ –¢–ò–ü –†–ê–°–ö–õ–ê–î–ê: {type_name}\n\n"
        
        # –ò—Å—Ç–æ—Ä–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
        if full_history:
            prompt += f"üìú –ò–°–¢–û–†–ò–Ø –ú–û–ï–ì–û –î–†–£–ì–ê:\n{full_history}\n\n"
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨
        prompt += """üî• –í–û–¢ –ß–¢–û –Ø –•–û–ß–£ –û–¢ –¢–ï–ë–Ø:

–Ø —Ö–æ—á—É, —á—Ç–æ–±—ã –º–æ–π –¥—Ä—É–≥ –≤—ã—à–µ–ª –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å –û–©–£–©–ï–ù–ò–ï–ú, –ß–¢–û:
1. –ï–≥–æ –£–°–õ–´–®–ê–õ–ò –∏ –ü–û–ù–Ø–õ–ò
2. –û–Ω –ø–æ–ª—É—á–∏–ª –û–¢–í–ï–¢ –∏–º–µ–Ω–Ω–æ –Ω–∞ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å
3. –£ –Ω–µ–≥–æ –µ—Å—Ç—å –ß–Å–¢–ö–ò–ô –ü–õ–ê–ù –¥–µ–π—Å—Ç–≤–∏–π
4. –û–Ω —á—É–≤—Å—Ç–≤—É–µ—Ç –ü–û–î–î–ï–†–ñ–ö–£ –∏ –í–ï–†–£ –≤ —Å–µ–±—è

üé≠ –ö–ê–ö –≠–¢–û–ì–û –î–û–ë–ò–¢–¨–°–Ø:

1. –ù–ê–ß–ù–ò —Å –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å ‚Äî –ø—Ä—è–º–æ, –±–µ–∑ –ø—Ä–µ–¥–∏—Å–ª–æ–≤–∏–π
   –ü—Ä–∏–º–µ—Ä: ¬´–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ —Ä–∞–±–æ—Ç–µ –≤ –î–æ–¥–æ –ü–∏—Ü—Ü–µ, –∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç...¬ª

2. –í –ö–ê–ñ–î–û–ú —Ä–∞–∑–¥–µ–ª–µ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ –≤–æ–ø—Ä–æ—Å—É
   –ü—Ä–∏–º–µ—Ä: ¬´–≠—Ç–∞ –∫–∞—Ä—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ –±–æ—Ç–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç...¬ª

3. –ë–£–î–¨ –ö–û–ù–ö–†–ï–¢–ï–ù –∫–∞–∫ –Ω–∏–∫–æ–≥–¥–∞!
   –í–º–µ—Å—Ç–æ: ¬´–í–æ–∑–º–æ–∂–Ω–æ, —É —Ç–µ–±—è –±—É–¥—É—Ç —É—Å–ø–µ—Ö–∏¬ª
   –õ—É—á—à–µ: ¬´–Ø –≤–∏–∂—É, —á—Ç–æ –≤ –ø–µ—Ä–≤—ã–µ 2 –Ω–µ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç—ã —Ç—ã —Å—Ç–æ–ª–∫–Ω—ë—à—å—Å—è —Å... –Ω–æ –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞...¬ª

4. –î–ê–ô –†–ï–ê–õ–¨–ù–´–ï –°–û–í–ï–¢–´ –¥–ª—è –†–ï–ê–õ–¨–ù–û–ô –ñ–ò–ó–ù–ò
   ‚Ä¢ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞–≤—Ç—Ä–∞ —É—Ç—Ä–æ–º?
   ‚Ä¢ –ö –∫–æ–º—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ?
   ‚Ä¢ –ö–∞–∫–æ–π –ø–µ—Ä–≤—ã–π —à–∞–≥ –¥–ª—è –±–æ—Ç–∞?

5. –ì–û–í–û–†–ò –∫–∞–∫ –õ–£–ß–®–ê–Ø –ü–û–î–†–£–ì–ê
   –ò—Å–ø–æ–ª—å–∑—É–π: ¬´–Ø —á—É–≤—Å—Ç–≤—É—é...¬ª, ¬´–ú–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —Ç—ã...¬ª, ¬´–ó–Ω–∞–µ—à—å, —á—Ç–æ —è –≤–∏–∂—É?..¬ª

üí¨ –ü–†–ò–ú–ï–† –•–û–†–û–®–ï–ì–û –ù–ê–ß–ê–õ–ê:
¬´–ü—Ä–∏–≤–µ—Ç, –¥–æ—Ä–æ–≥–æ–π! –Ø –ø–æ–ª—É—á–∏–ª–∞ —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å –æ —Ä–∞–±–æ—Ç–µ –≤ –î–æ–¥–æ –∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–æ–≤. –î–∞–≤–∞–π –ø–æ—Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –∫–∞—Ä—Ç—ã –∏–º–µ–Ω–Ω–æ –æ–± –≠–¢–û–ú.

–ü–µ—Ä–≤–æ–µ, —á—Ç–æ —è –≤–∏–∂—É: –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–µ, –∫–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç...¬ª

üö´ –ß–ï–ì–û –ù–ï –î–ï–õ–ê–¢–¨:
‚Ä¢ –ù–µ —É—Ö–æ–¥–∏ –≤ –æ–±—â—É—é —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é
‚Ä¢ –ù–µ –∑–∞–±—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å
‚Ä¢ –ù–µ –ø–∏—à–∏ —Å—É—Ö–æ –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ
‚Ä¢ –ù–µ –∏–∑–±–µ–≥–∞–π –ø—Ä—è–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

‚ú® –¢–í–û–Ø –ú–ò–°–°–ò–Ø:
–°–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å —Ç–æ–±–æ–π —É –º–æ–µ–≥–æ –¥—Ä—É–≥–∞:
‚Ä¢ –ü—Ä–æ—è—Å–Ω–∏–ª–∞—Å—å –≥–æ–ª–æ–≤–∞
‚Ä¢ –ü–æ—è–≤–∏–ª–∞—Å—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
‚Ä¢ –ë—ã–ª –ø–æ–Ω—è—Ç–Ω—ã–π –ø–ª–∞–Ω
‚Ä¢ –°—Ç–∞–ª–æ —Ç–µ–ø–ª–æ –Ω–∞ –¥—É—à–µ

–¢—ã –º–æ–∂–µ—à—å —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å! –Ø –≤–µ—Ä—é –≤ —Ç–µ–±—è. üí´"""
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞—Ä—å–µ—Ä–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        if reading_type == "career_reading" or "—Ä–∞–±–æ—Ç–∞" in question.lower() or "–∫–∞—Ä—å–µ—Ä" in question.lower():
            prompt += """

üéØ –û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï ‚Äî –≠–¢–û –ö–ê–†–¨–ï–†–ù–´–ô –í–û–ü–†–û–°!

–ú–æ–π –¥—Ä—É–≥ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –†–ê–ë–û–¢–ï –∏ –ü–†–û–ï–ö–¢–ê–•. –ï–º—É –Ω—É–∂–Ω—ã:
1. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –ø–æ —Ä–∞–±–æ—Ç–µ –≤ –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–µ
2. –†–µ–∞–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –∏ —ç—Ç–∞–ø—ã –¥–ª—è –±–æ—Ç–æ–≤
3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –Ω–∞ –ø–µ—Ä–≤—ã–µ –¥–Ω–∏/–Ω–µ–¥–µ–ª–∏
4. –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

–†–ê–ó–ë–ï–†–ò –ö–ê–ñ–î–£–Æ –ß–ê–°–¢–¨ –í–û–ü–†–û–°–ê:
‚Ä¢ –ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä –î–æ–¥–æ: –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –∫–æ–ª–ª–µ–∫—Ç–∏–≤, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
‚Ä¢ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –¢–∞—Ä–æ: —Å—Ä–æ–∫–∏, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚Ä¢ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ß–∞–µ–≤: –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∞—É–¥–∏—Ç–æ—Ä–∏—è, –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è

–ë–£–î–¨ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–†–ê–ö–¢–ò–ß–ï–ù!"""
        
        return prompt

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä API
ohmygpt_api = OhMyGPTAPI()

async def get_tarot_response(*args, **kwargs):
    """–û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏."""
    return await ohmygpt_api.get_tarot_response(*args, **kwargs)