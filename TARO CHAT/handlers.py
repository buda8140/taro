"""
handlers.py
–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏ –∏ –Ω–æ–≤—ã–º–∏ —Ñ–∏—á–∞–º–∏.
"""

from datetime import datetime, timedelta
import sqlite3
from pytz import timezone
import logging
import asyncio
import random
from aiogram import Router, Bot, F
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.exceptions import TelegramBadRequest
from typing import Any, Dict, List, Optional

from config import (
    ADMIN_ID, CARD_NUMBER, INITIAL_FREE_REQUESTS,
    INITIAL_PREMIUM_REQUESTS, FREE_REQUEST_INTERVAL,
    MAX_CARDS, FORBIDDEN_KEYWORDS, MAX_FORBIDDEN_ATTEMPTS,
    BOT_USERNAME, MAX_QUESTION_LENGTH, BAN_DURATION_HOURS,
    TIMEZONE, PAYMENT_OPTIONS, TAROT_READER_NAME
)
from keyboards import (
    achievements_progress_keyboard, examples_category_keyboard, feedback_keyboard, main_menu_keyboard, readings_submenu_keyboard,
    profile_submenu_keyboard, support_submenu_keyboard,
    payment_options_keyboard, cards_number_keyboard,
    reading_type_keyboard, history_pagination_keyboard,
    confirmation_keyboard, referral_keyboard,
    examples_keyboard, achievements_keyboard, user_stats_keyboard, achievements_bonus_keyboard
)
from utils import (
    generate_tarot_cards, get_all_tarot_cards_list,
    send_admin_notification, check_free_request_interval,
    parse_custom_cards, format_datetime, get_random_advice,
    get_random_quote, get_referral_link, format_tarot_response,
    get_user_achievements, get_user_level  # –î–æ–±–∞–≤–∏–º —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏
)
from database import db
from ohmygpt_api import get_tarot_response
from yoomoney import yoomoney_payment

router = Router()
logger = logging.getLogger(__name__)

# ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ë–ï–ó–û–ü–ê–°–ù–û–ì–û CALLBACK.ANSWER() ====================

async def safe_answer(callback: CallbackQuery, text: Optional[str] = None, show_alert: bool = False) -> bool:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è callback.answer(), –∫–æ—Ç–æ—Ä–∞—è –ª–æ–≤–∏—Ç –æ—à–∏–±–∫–∏ "query is too old".
    
    Args:
        callback: CallbackQuery –æ–±—ä–µ–∫—Ç
        text: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        show_alert: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ alert
        
    Returns:
        True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, False –µ—Å–ª–∏ callback —É—Å—Ç–∞—Ä–µ–ª
    """
    try:
        await callback.answer(text=text, show_alert=show_alert)
        return True
    except TelegramBadRequest as e:
        error_msg = str(e).lower()
        if "query is too old" in error_msg or "response timeout expired" in error_msg or "query id is invalid" in error_msg:
            print(f"WARNING: Old callback_query ignored: {callback.data} (user {callback.from_user.id})")
            return False
        else:
            print(f"ERROR in safe_answer: {str(e)}")
            return False
    except Exception as e:
        # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–æ–≥ –±–µ–∑ traceback –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–∫—É—Ä—Å–∏–∏
        print(f"‚ö†Ô∏è Unexpected error in safe_answer: {str(e)}")
        return False

# ==================== –ö–û–ù–ï–¶ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ô –§–£–ù–ö–¶–ò–ò ====================


class UserState(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    awaiting_question = State()
    awaiting_cards_number = State()
    awaiting_custom_cards = State()
    awaiting_feedback = State()
    awaiting_reading_type = State()

# –°–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ —Ä–∞—Å–∫–ª–∞–¥–æ–≤
READING_TYPES = {
    "situation_reading": {
        "name": "–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é",
        "default_question": "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ —Å–µ–π—á–∞—Å?",
        "cards_count": 3,
        "emoji": "üé≠",
        "description": "–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è, –ø–æ–∏—Å–∫ —Å–∫—Ä—ã—Ç—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π"
    },
    "relationship_reading": {
        "name": "–Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
        "default_question": "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –º–æ–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
        "cards_count": 3,
        "emoji": "üíñ",
        "description": "–õ—é–±–æ–≤—å, –¥—Ä—É–∂–±–∞, —Å–µ–º—å—è, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏"
    },
    "career_reading": {
        "name": "–Ω–∞ –∫–∞—Ä—å–µ—Ä—É",
        "default_question": "–ß—Ç–æ –º–µ–Ω—è –∂–¥—ë—Ç –≤ –∫–∞—Ä—å–µ—Ä–µ?",
        "cards_count": 3,
        "emoji": "üíº",
        "description": "–†–∞–±–æ—Ç–∞, —Ñ–∏–Ω–∞–Ω—Å—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç, –ø—Ä–æ–µ–∫—Ç—ã"
    }
}

# –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
GOOD_QUESTIONS_EXAMPLES = {
    "relationship": [
        "–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –Ω–∞—à–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è?",
        "–ß—Ç–æ —è –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –±—ã—Ç—å –ª—É—á—à–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º?",
        "–ö–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–æ—Å—Ç–∞ –µ—Å—Ç—å –≤ –Ω–∞—à–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
        "–ö–∞–∫ –Ω–∞–º –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞?"
    ],
    "career": [
        "–ö–∞–∫—É—é –∫–∞—Ä—å–µ—Ä–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –º–Ω–µ –≤—ã–±—Ä–∞—Ç—å?",
        "–ß—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ –¥–æ—Å—Ç–∏—á—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π?",
        "–ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –±—É–¥–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º?",
        "–ù–∞ –∫–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–Ω–µ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ?"
    ],
    "personal": [
        "–ö–∞–∫ –º–Ω–µ —Å—Ç–∞—Ç—å –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è?",
        "–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞?",
        "–ö–∞–∫–∏–µ —Å–∫—Ä—ã—Ç—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã —É –º–µ–Ω—è –µ—Å—Ç—å?",
        "–ö–∞–∫ –Ω–∞–π—Ç–∏ –±–∞–ª–∞–Ω—Å –≤ –∂–∏–∑–Ω–∏?"
    ],
    "general": [
        "–ß—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–µ–Ω—è —Å–µ–π—á–∞—Å?",
        "–ö–∞–∫–∏–µ —É—Ä–æ–∫–∏ —è –º–æ–≥—É –∏–∑–≤–ª–µ—á—å –∏–∑ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?",
        "–ö–∞–∫–æ–π –ø—É—Ç—å –±—É–¥–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–º?",
        "–ß—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—É—Å—Ç–∏—Ç—å, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä–µ–¥?"
    ]
}

@router.message(Command("start"))
async def start_handler(message: Message, state: FSMContext, bot: Bot) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    await state.clear()
    
    # –ü–∞—Ä—Å–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π ID
    referrer_id = None
    if len(message.text.split()) > 1:
        try:
            referrer_id = int(message.text.split()[1])
        except ValueError:
            pass
    
    user_id = message.from_user.id
    username = message.from_user.username or "user"
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = await db.get_user(user_id)
    
    if not user_data:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        await db.add_user(
            user_id=user_id,
            username=username,
            first_name=message.from_user.first_name or "",
            last_name=message.from_user.last_name or "",
            referral_id=referrer_id
        )
        user_data = await db.get_user(user_id)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—É
        if referrer_id and referrer_id != user_id:
            try:
                await bot.send_message(
                    referrer_id,
                    f"üéâ‚ú® <b>–ù–æ–≤—ã–π –¥—Ä—É–≥ –≤ –º–∏—Ä–µ –¢–∞—Ä–æ!</b>\n\n"
                    f"–ö—Ç–æ-—Ç–æ –ø–µ—Ä–µ—à—ë–ª –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–≤–æ—ë –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ. "
                    f"–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å! üí´\n\n"
                    f"<i>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–µ–π –º—É–¥—Ä–æ—Å—Ç—å—é!</i>",
                    parse_mode='HTML'
                )
            except:
                pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω
    if user_data.get("is_banned"):
        ban_expires = user_data.get("ban_expires")
        if ban_expires:
            try:
                ban_time = datetime.strptime(ban_expires, '%Y-%m-%d %H:%M:%S').replace(tzinfo=timezone(TIMEZONE))
                if datetime.now(timezone(TIMEZONE)) < ban_time:
                    await message.answer(
                        f"üö´‚ö†Ô∏è <b>–î–æ—Å—Ç—É–ø –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</b>\n\n"
                        f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à –¥–æ—Å—Ç—É–ø –∫ –∫–∞—Ä—Ç–∞–º –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ:\n"
                        f"<b>{format_datetime(ban_expires)}</b>\n\n"
                        f"üìû <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å?</b>\n"
                        f"‚Ä¢ –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏–π\n"
                        f"‚Ä¢ –ò–∑—É—á–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞\n"
                        f"‚Ä¢ –ü–æ–¥–æ–∂–¥–∏—Ç–µ –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã\n\n"
                        f"<i>–ú—ã –≤–µ—Ä–∏–º –≤ –≤–∞—à—É –º—É–¥—Ä–æ—Å—Ç—å –∏ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!</i>",
                        parse_mode='HTML'
                    )
                    return
                else:
                    await db.ban_user(user_id, False)
            except:
                pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
    if not user_data.get("agreed_rules", False):
        await message.answer(
            f"üåô‚ú® <b>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º —Ç–µ–±—è –≤ –º–∏—Ä–µ –¢–∞—Ä–æ, {message.from_user.first_name}!</b>\n\n"
            
            f"üÉè <b>–Ø ‚Äî {TAROT_READER_NAME}</b>, —Ç–≤–æ–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –≤ –º–∏—Ä –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è.\n"
            f"–ó–¥–µ—Å—å –∫–∞—Ä—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∑–µ—Ä–∫–∞–ª–æ–º —Ç–≤–æ–µ–π –¥—É—à–∏.\n\n"
            
            f"üåà <b>–ß—Ç–æ —è –º–æ–≥—É –¥–ª—è —Ç–µ–±—è —Å–¥–µ–ª–∞—Ç—å:</b>\n"
            f"‚Ä¢ üé≠ <b>–ì–ª—É–±–æ–∫–∏–µ —Ä–∞—Å–∫–ª–∞–¥—ã</b> –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n"
            f"‚Ä¢ üí´ <b>–ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–π</b> —Å —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∫—É—Ä—Å–æ–≤\n"
            f"‚Ä¢ üîÆ <b>–ü–æ–∏—Å–∫ —Å–∫—Ä—ã—Ç—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π</b>\n"
            f"‚Ä¢ üå± <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–æ—Å—Ç–∞</b> –∏ —Ä–∞–∑–≤–∏—Ç–∏—è\n\n"
            
            f"üéÅ <b>–¢–≤–æ–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä:</b>\n"
            f"‚Ä¢ üÜì <b>{user_data['requests_left']} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞</b> - –ø–æ–ø—Ä–æ–±—É–π –∏ –ø–æ—á—É–≤—Å—Ç–≤—É–π —ç–Ω–µ—Ä–≥–∏—é –∫–∞—Ä—Ç\n"
            f"‚Ä¢ üíé <b>{user_data['premium_requests']} –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å</b> - –¥–ª—è —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n"
            f"‚Ä¢ ‚≠ê <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b> - –ø—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã\n\n"
            
            f"üìú <b>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å –≤–∞–∂–Ω—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏:</b>\n"
            f"1. üß† <b>–¢–∞—Ä–æ ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π</b>, –∞ –Ω–µ –≥–∞–¥–∞–Ω–∏–µ. –ö–∞—Ä—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç —É–≤–∏–¥–µ—Ç—å —Ç–æ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ —Ç–≤–æ—ë–º —Å–µ—Ä–¥—Ü–µ.\n"
            f"2. üåü <b>–£–≤–∞–∂–∞–π –∫–∞—Ä—Ç—ã –∏ –∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è</b> - –æ–Ω–∏ –≥–æ–≤–æ—Ä—è—Ç —Å —Ç–æ–±–æ–π –Ω–∞ —è–∑—ã–∫–µ —Å–∏–º–≤–æ–ª–æ–≤.\n"
            f"3. ‚öïÔ∏è <b>–ò–∑–±–µ–≥–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –±–æ–ª–µ–∑–Ω—è—Ö –∏ —Å–º–µ—Ä—Ç–∏</b> - —ç—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º.\n"
            f"4. ü§ù <b>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Ä–µ—à–µ–Ω–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞ —Ç–æ–±–æ–π</b> - –∫–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã, –≤—ã–±–æ—Ä –∑–∞ —Ç–æ–±–æ–π.\n"
            f"5. üé≠ <b>–í—Å–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è ‚Äî —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ</b> –∏ –Ω–µ –∏–º–µ—é—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Å–∏–ª—ã.\n\n"
            
            f"üìÑ <b>–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ:</b>\n"
            f"<a href='https://telegra.ph/Polzovatelskoe-soglashenie-12-09-32'>üìñ –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è</a>\n\n"
            
            f"üëÅÔ∏è‚Äçüó®Ô∏è <b>–¢–≤–æ–∏ –ø—Ä–∞–≤–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
            f"‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤\n"
            f"‚Ä¢ üíé –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å—ã\n"
            f"‚Ä¢ üìú –î–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏ –≤—Å–µ—Ö —Ç–≤–æ–∏—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
            f"‚Ä¢ ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –±–æ–Ω—É—Å–∞–º–∏\n"
            f"‚Ä¢ üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –ø–æ–º–æ—â—å 24/7\n"
            f"‚Ä¢ ‚≠ê –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ —É—Ä–æ–≤–Ω–µ–π\n"
            f"‚Ä¢ üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤\n\n"
            
            f"‚ö†Ô∏è <b>–í–∞–∂–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</b>\n"
            f"<i>–ù–∞–∂–∏–º–∞—è '‚úÖ –ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞', —Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å, —á—Ç–æ:</i>\n"
            f"‚Ä¢ –¢–µ–±–µ –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 18 –ª–µ—Ç\n"
            f"‚Ä¢ –¢—ã –ø—Ä–æ—á–∏—Ç–∞–ª(–∞) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ\n"
            f"‚Ä¢ –ü–æ–Ω–∏–º–∞–µ—à—å —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –±–æ—Ç–∞\n"
            f"‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞–µ—à—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è\n\n"
            
            f"üåô <i>–ì–æ—Ç–æ–≤(–∞) –Ω–∞—á–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –º–∏—Ä –¢–∞—Ä–æ?</i>",
            reply_markup=InlineKeyboardBuilder()
                .button(text="‚úÖ –ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∏ –Ω–∞—á–∞—Ç—å", callback_data="agree_rules")
                .button(text="üìñ –û—Ç–∫—Ä—ã—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", url="https://telegra.ph/Polzovatelskoe-soglashenie-12-09-32")
                .button(text="üìö –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤", callback_data="examples")
                .adjust(1)
                .as_markup(),
            parse_mode='HTML',
            disable_web_page_preview=True
        )
        return
    
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    user_level = await get_user_level(user_id)
    achievements = await get_user_achievements(user_id)
    
    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    welcome_text = (
        f"‚ú®üåô <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {message.from_user.first_name}!</b>\n\n"
        
        f"üîÆ <b>–ö–∞—Ä—Ç—ã —á—É–≤—Å—Ç–≤—É—é—Ç —Ç–≤–æ—é —ç–Ω–µ—Ä–≥–∏—é</b> –∏ –≥–æ—Ç–æ–≤—ã –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–µ –≥—Ä–∞–Ω–∏ —Ç–≤–æ–µ–≥–æ –ø—É—Ç–∏.\n"
        f"–û–Ω–∏ –∂–¥—É—Ç, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ —É–≤–∏–¥–µ—Ç—å —Ç–æ, —á—Ç–æ —Å–∫—Ä—ã—Ç–æ –æ—Ç –≥–ª–∞–∑.\n\n"
        
        f"üí´ <b>–ß—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å:</b>\n"
        f"‚Ä¢ üîÆ <b>–†–∞—Å–∫–ª–∞–¥—ã</b> - –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã\n"
        f"‚Ä¢ üìä <b>–ò—Å—Ç–æ—Ä–∏—è</b> - —Ç–≤–æ–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∏–∞–ª–æ–≥–∏ —Å –∫–∞—Ä—Ç–∞–º–∏\n"
        f"‚Ä¢ üèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b> - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å\n"
        f"‚Ä¢ ü§ù <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b> - –¥–µ–ª–∏—Å—å –º—É–¥—Ä–æ—Å—Ç—å—é –∏ –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã\n\n"
        
        f"üéÅ <b>–¢–≤–æ–∏ —Ç–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã:</b>\n"
        f"‚Ä¢ üÜì <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ:</b> {user_data['requests_left']}\n"
        f"‚Ä¢ üíé <b>–ü—Ä–µ–º–∏—É–º:</b> {user_data['premium_requests']}\n"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Ä–æ–≤–Ω–µ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö
    if user_level > 1:
        welcome_text += f"\nüéØ <b>–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</b> {user_level}"
        if achievements:
            welcome_text += f"\nüèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {', '.join(achievements[:3])}"
            if len(achievements) > 3:
                welcome_text += f" –∏ –µ—â—ë {len(achievements) - 3}..."
    
    welcome_text += (
        f"\n\nüî• <b>–•–æ—á–µ—à—å –µ—â—ë –±–æ–ª–µ–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã?</b>\n"
        f"–ü–µ—Ä–µ—Ö–æ–¥–∏ –≤ –Ω–∞—à–µ–≥–æ –≤—Ç–æ—Ä–æ–≥–æ –±–æ—Ç–∞: @EroticMoonBot üíã\n\n"
        f"üåü <i>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –º–µ–Ω—é –Ω–∏–∂–µ üëá</i>"
    )
    
    await message.answer(
        welcome_text,
        reply_markup=await main_menu_keyboard(user_data),
        parse_mode='HTML'
    )

@router.callback_query(F.data == "agree_rules")
async def agree_rules_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–≥–ª–∞—Å–∏—è —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏."""
    user_id = callback.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–≥–ª–∞—Å–∏—è
    with sqlite3.connect(str(db.db_path)) as conn:
        cursor = conn.cursor()
        cursor.execute(
            "UPDATE users SET agreed_rules = TRUE WHERE user_id = ?",
            (user_id,)
        )
        conn.commit()
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_data = await db.get_user(user_id)
    
    await callback.message.edit_text(
        f"‚ú®üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, {callback.from_user.first_name}!</b>\n\n"
        
        f"üåü <b>–¢—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Å—Ç–∞–ª(–∞) —á–∞—Å—Ç—å—é –Ω–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞!</b>\n"
        f"–¢–µ–ø–µ—Ä—å –∫–∞—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è —Ç–µ–±—è, –∏ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å–≤–æ—ë –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ.\n\n"
        
        f"üìã <b>–ß—Ç–æ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ:</b>\n"
        f"‚Ä¢ üîÆ <b>–î–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥—ã</b> - –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∞–π –æ—Ç–≤–µ—Ç—ã\n"
        f"‚Ä¢ üìä <b>–°–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</b> - –≤—Å–µ —Ç–≤–æ–∏ —Ä–∞—Å–∫–ª–∞–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è\n"
        f"‚Ä¢ ü§ù <b>–ü—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π</b> - –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã\n"
        f"‚Ä¢ üíé <b>–ü–æ–∫—É–ø–∞—Ç—å –ø—Ä–µ–º–∏—É–º</b> - –¥–ª—è –æ—Å–æ–±–æ –≤–∞–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n"
        f"‚Ä¢ ‚≠ê <b>–û—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤—ã</b> - –ø–æ–º–æ–≥–∞—Ç—å –Ω–∞–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ª—É—á—à–µ\n"
        f"‚Ä¢ üèÜ <b>–ü–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b> - –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –º—É–¥—Ä–æ—Å—Ç—å\n"
        f"‚Ä¢ üìö <b>–ò–∑—É—á–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã</b> - –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å—Å—è –≤–æ–ø—Ä–æ—Å–∞–º–∏ –¥—Ä—É–≥–∏—Ö\n\n"
        
        f"üéÅ <b>–¢–≤–æ–∏ —Ç–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã:</b>\n"
        f"‚Ä¢ üÜì <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:</b> {user_data['requests_left']}\n"
        f"‚Ä¢ üíé <b>–ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–æ–≤:</b> {user_data['premium_requests']}\n\n"
        
        f"üí´ <b>–ö–∞–∫ –Ω–∞—á–∞—Ç—å:</b>\n"
        f"1. –ù–∞–∂–º–∏ 'üîÆ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é\n"
        f"2. –í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º 3)\n"
        f"3. –ó–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å\n"
        f"4. –ü–æ–ª—É—á–∏ –º—É–¥—Ä—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç!\n\n"
        
        f"üåô <b>–ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è –ø–µ—Ä–≤—ã—Ö —à–∞–≥–æ–≤:</b>\n"
        f"‚Ä¢ üéØ <b>–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω</b> - —á—ë—Ç–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–∞—é—Ç —è—Å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã\n"
        f"‚Ä¢ üí≠ <b>–î–∞–π –∫–∞—Ä—Ç–∞–º –≤—Ä–µ–º—è</b> - –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ '–ø–æ–∂–∏—Ç—å' —Å –æ—Ç–≤–µ—Ç–æ–º\n"
        f"‚Ä¢ üìù <b>–ó–∞–ø–∏—Å—ã–≤–∞–π –≤–∞–∂–Ω–æ–µ</b> - –∏–Ω—Å–∞–π—Ç—ã –º–æ–≥—É—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –ø–æ–∑–∂–µ\n"
        f"‚Ä¢ üîÑ <b>–í–æ–∑–≤—Ä–∞—â–∞–π—Å—è</b> - –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–π —Ä–∞—Å–∫–ª–∞–¥—ã —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è\n"
        f"‚Ä¢ ‚ù§Ô∏è <b>–ë—É–¥—å –æ—Ç–∫—Ä—ã—Ç</b> - –∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –Ω–∞ —è–∑—ã–∫–µ —Å–µ—Ä–¥—Ü–∞\n\n"
        
        f"üåü <b>–ë–æ–Ω—É—Å –¥–ª—è –Ω–æ–≤–∏—á–∫–∞:</b>\n"
        f"<i>–¢–≤–æ–π –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ –æ—Å–æ–±–µ–Ω–Ω—ã–π - –∫–∞—Ä—Ç—ã –≤—Å–µ–≥–¥–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –∫ –ø–µ—Ä–≤—ã–º –≤–æ–ø—Ä–æ—Å–∞–º!</i>\n\n"
        
        f"<i>–ö–∞—Ä—Ç—ã —É–∂–µ –∂–¥—É—Ç —Ç–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞...</i>\n\n"
        f"<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –¢–∞—Ä–æ! üåü‚ú®</b>\n\n"
        f"–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –º–µ–Ω—é –Ω–∏–∂–µ üëá",
        reply_markup=await main_menu_keyboard(user_data),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "main_menu")
async def main_menu_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    await state.clear()
    user_id = callback.from_user.id
    user_data = await db.get_user(user_id)
    
    menu_messages = [
        "‚ú®üåô <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–ö–∞—Ä—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ. –ß—Ç–æ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å? üîÆ",
        "üåü‚ú® <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–ö—É–¥–∞ –Ω–∞–ø—Ä–∞–≤–∏–º –Ω–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è? üé≠",
        "üí´üåô <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–ì–æ—Ç–æ–≤(–∞) –∫ –Ω–æ–≤—ã–º –æ—Ç–∫—Ä—ã—Ç–∏—è–º? –í—ã–±–∏—Ä–∞–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ! üîÆ"
    ]
    
    menu_text = random.choice(menu_messages)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–Ω–¥–æ–º–Ω—ã–π —Å–æ–≤–µ—Ç –∏–ª–∏ —Ü–∏—Ç–∞—Ç—É
    if random.random() < 0.3:  # 30% chance
        advice = get_random_advice()
        menu_text += f"\n\nüí≠ <i>–°–æ–≤–µ—Ç –∫–∞—Ä—Ç:</i> {advice}"
    
    try:
        await callback.message.edit_text(
            menu_text,
            reply_markup=await main_menu_keyboard(user_data),
            parse_mode='HTML'
        )
    except TelegramBadRequest:
        await safe_answer(callback, "üîÑ –ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ!")
    await safe_answer(callback)

@router.callback_query(F.data == "readings_submenu")
async def readings_submenu_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é —Ä–∞—Å–∫–ª–∞–¥–æ–≤."""
    await callback.message.edit_text(
        "üîÆüåô <b>–í—ã–±–µ—Ä–∏ —Ç–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞:</b>\n\n"
        
        f"{READING_TYPES['situation_reading']['emoji']} <b>–ù–∞ —Å–∏—Ç—É–∞—Ü–∏—é</b>\n"
        f"<i>{READING_TYPES['situation_reading']['description']}</i>\n\n"
        
        f"{READING_TYPES['relationship_reading']['emoji']} <b>–ù–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è</b>\n"
        f"<i>{READING_TYPES['relationship_reading']['description']}</i>\n\n"
        
        f"{READING_TYPES['career_reading']['emoji']} <b>–ù–∞ –∫–∞—Ä—å–µ—Ä—É</b>\n"
        f"<i>{READING_TYPES['career_reading']['description']}</i>\n\n"
        
        "üÉè‚ú® <b>–î—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:</b>\n"
        "‚Ä¢ üîÆ <b>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</b> ‚Äî –ª—é–±–æ–π —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å\n"
        "‚Ä¢ üé® <b>–°–≤–æ–∏ –∫–∞—Ä—Ç—ã</b> ‚Äî —Å–∞–º –≤—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç—ã\n"
        "‚Ä¢ üé≤ <b>–°–ª—É—á–∞–π–Ω—ã–π</b> ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n\n"
        
        "üí° <i>–ö–∞–∂–¥—ã–π —Ç–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞ –∏–º–µ–µ—Ç —Å–≤–æ—é –æ—Å–æ–±—É—é —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫—É –∏ —Ñ–æ–∫—É—Å.</i>",
        reply_markup=readings_submenu_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data.in_(READING_TYPES.keys()))
async def special_reading_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–≤."""
    reading_type = READING_TYPES[callback.data]
    
    await state.update_data({
        "reading_type": callback.data,
        "default_question": reading_type["default_question"],
        "cards_count": reading_type["cards_count"]
    })
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
    examples_key = "general"
    if callback.data == "relationship_reading":
        examples_key = "relationship"
    elif callback.data == "career_reading":
        examples_key = "career"
    
    examples = GOOD_QUESTIONS_EXAMPLES.get(examples_key, [])
    
    examples_text = ""
    if examples:
        examples_text = "\n\nüí° <b>–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:</b>\n"
        for i, example in enumerate(examples[:3], 1):
            examples_text += f"{i}. {example}\n"
    
    await callback.message.edit_text(
        f"{reading_type['emoji']}‚ú® <b>–†–∞—Å–∫–ª–∞–¥ {reading_type['name']}</b>\n\n"
        f"<i>{reading_type['description']}</i>\n\n"
        f"–ö–∞—Ä—Ç—ã –≥–æ—Ç–æ–≤—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. "
        f"–ú–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π:\n\n"
        f"üìù <b>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å:</b>\n"
        f"<i>{reading_type['default_question']}</i>\n\n"
        f"{examples_text}\n"
        f"‚úçÔ∏è <b>–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å</b> –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å '–¥–∞–ª—å—à–µ' –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ:",
        parse_mode='HTML'
    )
    
    await state.set_state(UserState.awaiting_question)
    await safe_answer(callback)

@router.callback_query(F.data == "new_reading")
async def new_reading_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞."""
    user_id = callback.from_user.id
    user_data = await db.get_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
    if user_data["requests_left"] <= 0 and user_data["premium_requests"] <= 0:
        user_level = await get_user_level(user_id)
        
        await callback.message.edit_text(
            f"‚ö†Ô∏èüîÆ <b>–ó–∞–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!</b>\n\n"
            f"–ù–æ –Ω–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è, –µ—Å—Ç—å –º–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å:\n\n"
            f"üíé <b>1. –ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å—ã</b>\n"
            f"‚Ä¢ –ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–µ –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã\n"
            f"‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ —Å–æ–≤–µ—Ç—ã\n"
            f"‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤\n\n"
            f"ü§ù <b>2. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n"
            f"‚Ä¢ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ ‚Äî –ø–æ–ª—É—á–∏ +1 –∑–∞–ø—Ä–æ—Å\n"
            f"‚Ä¢ –î—Ä—É–≥ —Ç–æ–∂–µ –ø–æ–ª—É—á–∏—Ç –±–æ–Ω—É—Å—ã\n"
            f"‚Ä¢ –ü–æ–º–æ–≥–∏ –¥—Ä—É–≥–∏–º –æ—Ç–∫—Ä—ã—Ç—å –º–∏—Ä –¢–∞—Ä–æ\n\n"
            f"‚è≥ <b>3. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</b>\n"
            f"‚Ä¢ –ö–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤ ‚Äî –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å\n"
            f"‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π\n"
            f"‚Ä¢ –£—á–∏—Å—å —Å–ª—ã—à–∞—Ç—å –∫–∞—Ä—Ç—ã –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ\n\n"
            f"‚≠ê <b>4. –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b> (—É—Ä–æ–≤–µ–Ω—å {user_level})\n"
            f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω–æ—Å–∏—Ç –±–æ–Ω—É—Å—ã\n"
            f"‚Ä¢ –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–∞—ë—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞\n"
            f"‚Ä¢ –°–ª–µ–¥–∏ –∑–∞ —Å–≤–æ–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º\n\n"
            f"üîó <b>–¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</b>\n"
            f"<code>{get_referral_link(user_id)}</code>\n\n"
            f"<i>–í—ã–±–∏—Ä–∞–π —Å–ø–æ—Å–æ–± –∏ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ –∫–∞—Ä—Ç–∞–º! üåô</i>",
            reply_markup=await payment_options_keyboard(),
            parse_mode='HTML'
        )
        await safe_answer(callback)
        return
    
    await callback.message.edit_text(
        "üÉè‚ú® <b>–°–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç –≤—ã—Ç–∞—â–∏–º?</b>\n\n"
        "–ö–∞–∂–¥–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–º–µ–µ—Ç —Å–≤–æ—é –º–∞–≥–∏—é:\n\n"
        f"üÉè <b>1 –∫–∞—Ä—Ç–∞</b> ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º\n"
        f"<i>–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç, –∫–ª—é—á–µ–≤–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ, —è—Å–Ω–æ—Å—Ç—å</i>\n\n"
        f"üÉèüÉèüÉè <b>3 –∫–∞—Ä—Ç—ã</b> ‚Äî –∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞ üåü\n"
        f"<i>–ü—Ä–æ—à–ª–æ–µ-–ù–∞—Å—Ç–æ—è—â–µ–µ-–ë—É–¥—É—â–µ–µ, –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –±–∞–ª–∞–Ω—Å</i>\n\n"
        f"üÉèüÉèüÉèüÉèüÉè <b>5 –∫–∞—Ä—Ç</b> ‚Äî –≥–ª—É–±–æ–∫–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ\n"
        f"<i>–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞, —Å–∫—Ä—ã—Ç—ã–µ —Å–≤—è–∑–∏, –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω</i>\n\n"
        "üí° <i>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å —Å 3 –∫–∞—Ä—Ç ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –≥–ª—É–±–∏–Ω—ã –∏ —è—Å–Ω–æ—Å—Ç–∏.</i>",
        reply_markup=cards_number_keyboard(),
        parse_mode='HTML'
    )
    
    await state.set_state(UserState.awaiting_cards_number)
    await safe_answer(callback)

@router.callback_query(F.data.startswith("cards_"))
async def cards_number_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç."""
    num_cards = int(callback.data.split("_")[1])
    
    await state.update_data({"num_cards": num_cards})
    
    # –†–∞–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç
    advice_by_cards = {
        1: "üéØ <b>–°–æ–≤–µ—Ç –¥–ª—è 1 –∫–∞—Ä—Ç—ã:</b> –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–∞–º–æ–º –≤–∞–∂–Ω–æ–º. –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –±–µ—Å–ø–æ–∫–æ–∏—Ç —Ç–µ–±—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ.",
        3: "üåü <b>–°–æ–≤–µ—Ç –¥–ª—è 3 –∫–∞—Ä—Ç:</b> –ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∂—É—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É. –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–π –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.",
        5: "üåä <b>–°–æ–≤–µ—Ç –¥–ª—è 5 –∫–∞—Ä—Ç:</b> –ë—É–¥—å –≥–æ—Ç–æ–≤ –∫ –≥–ª—É–±–æ–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É. –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–µ—Ç–∞–ª–∏."
    }
    
    advice = advice_by_cards.get(num_cards, "–ö–∞—Ä—Ç—ã –∂–¥—É—Ç —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.")
    
    await callback.message.edit_text(
        f"‚ú®üÉè <b>–û—Ç–ª–∏—á–Ω–æ! {num_cards} –∫–∞—Ä—Ç{'–∞' if num_cards == 1 else '—ã'}.</b>\n\n"
        f"{advice}\n\n"
        f"üìù <b>–¢–µ–ø–µ—Ä—å –∑–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å:</b>\n"
        f"–ö–∞—Ä—Ç—ã –ª—é–±—è—Ç —á—ë—Ç–∫–∏–µ –∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã.\n\n"
        f"üí° <b>–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:</b>\n"
        f"‚Ä¢ –ß—Ç–æ –º–Ω–µ –¥–µ–ª–∞—Ç—å –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?\n"
        f"‚Ä¢ –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å...?\n"
        f"‚Ä¢ –ß—Ç–æ –∂–¥—ë—Ç –º–µ–Ω—è –≤ –∫–∞—Ä—å–µ—Ä–µ –≤ –±–ª–∏–∂–∞–π—à–∏–µ –º–µ—Å—è—Ü—ã?\n"
        f"‚Ä¢ –ö–∞–∫–æ–π –≤—ã–±–æ—Ä –±—É–¥–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–º?\n"
        f"‚Ä¢ –ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞?\n\n"
        f"‚ùå <b>–ò–∑–±–µ–≥–∞–π:</b>\n"
        f"‚Ä¢ –í–æ–ø—Ä–æ—Å–æ–≤ –æ –±–æ–ª–µ–∑–Ω—è—Ö –∏ —Å–º–µ—Ä—Ç–∏\n"
        f"‚Ä¢ –°–ª–∏—à–∫–æ–º –æ–±—â–∏—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫\n"
        f"‚Ä¢ –ó–∞–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–¥–∞/–Ω–µ—Ç)\n\n"
        f"üìè <b>–ú–∞–∫—Å–∏–º—É–º {MAX_QUESTION_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤.</b>\n\n"
        f"<i>–ö–∞—Ä—Ç—ã –≥–æ—Ç–æ–≤—ã —É—Å–ª—ã—à–∞—Ç—å —Ç–µ–±—è...</i>",
        parse_mode='HTML'
    )
    
    await state.set_state(UserState.awaiting_question)
    await safe_answer(callback)

@router.message(StateFilter(UserState.awaiting_question))
async def process_question(message: Message, state: FSMContext, bot: Bot) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∞."""
    user_id = message.from_user.id
    user_data = await db.get_user(user_id)
    
    if not user_data:
        await message.answer(
            "‚ö†Ô∏è <b>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</b>\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏ —Å /start",
            parse_mode='HTML'
        )
        await state.clear()
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –≤–æ–ø—Ä–æ—Å
    question = message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    if question.lower() in ["–¥–∞–ª—å—à–µ", "next", "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"]:
        state_data = await state.get_data()
        question = state_data.get("default_question", "–ß—Ç–æ –∫–∞—Ä—Ç—ã —Ö–æ—Ç—è—Ç –º–Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å?")
        await message.answer(f"‚ú® –ò—Å–ø–æ–ª—å–∑—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å: <i>{question}</i>", parse_mode='HTML')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –≤–æ–ø—Ä–æ—Å–∞
    if len(question) > MAX_QUESTION_LENGTH:
        await message.answer(
            f"‚ö†Ô∏èüìè <b>–í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π</b>\n\n"
            f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {MAX_QUESTION_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤\n"
            f"–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å: {len(question)} —Å–∏–º–≤–æ–ª–æ–≤\n\n"
            f"üí° <b>–ö–∞–∫ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å:</b>\n"
            f"‚Ä¢ –£–±–µ—Ä–∏ –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏\n"
            f"‚Ä¢ –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º\n"
            f"‚Ä¢ –†–∞–∑–¥–µ–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ\n"
            f"‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞\n\n"
            f"<i>–ü–æ–ø—Ä–æ–±—É–π —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–æ—á–µ!</i>",
            parse_mode='HTML'
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ç–µ–º—ã
    if FORBIDDEN_KEYWORDS.search(question):
        await db.increment_forbidden_attempts(user_id)
        user_data = await db.get_user(user_id)
        
        attempts_left = MAX_FORBIDDEN_ATTEMPTS - user_data["forbidden_attempts"]
        
        if attempts_left <= 0:
            # –ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            ban_expires = (datetime.now(timezone(TIMEZONE)) + 
                          timedelta(hours=BAN_DURATION_HOURS)).strftime('%Y-%m-%d %H:%M:%S')
            await db.ban_user(user_id, True, ban_expires)
            
            await message.answer(
                f"üö´üîí <b>–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!</b>\n\n"
                f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç—ã –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–π –ø—Ä–∞–≤–∏–ª.\n"
                f"–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: <b>{format_datetime(ban_expires)}</b>\n\n"
                f"üìû <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å?</b>\n"
                f"1. –û–±—Ä–∞—Ç–∏—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n"
                f"2. –û–±—ä—è—Å–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏—é\n"
                f"3. –ü–æ–¥–æ–∂–¥–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è\n\n"
                f"<i>–ú—ã –∑–∞–±–æ—Ç–∏–º—Å—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</i>",
                parse_mode='HTML'
            )
            return
        else:
            await message.answer(
                f"‚ö†Ô∏è‚ù§Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ, –∑–∞–±–æ—Ç–∞ –æ —Ç–µ–±–µ!</b>\n\n"
                f"–¢–∞—Ä–æ —Å–æ–∑–¥–∞–Ω–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è, –∞ –Ω–µ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:\n"
                f"‚Ä¢ –û –±–æ–ª–µ–∑–Ω—è—Ö –∏ –∑–¥–æ—Ä–æ–≤—å–µ\n"
                f"‚Ä¢ –û —Å–º–µ—Ä—Ç–∏ –∏ –Ω–∞—Å–∏–ª–∏–∏\n"
                f"‚Ä¢ –û —Å—É–¥–∞—Ö –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö\n"
                f"‚Ä¢ –û –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞—Ö –∏ –Ω–µ—Å—á–∞—Å—Ç–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö\n\n"
                f"‚öñÔ∏è <b>–ü–æ—á–µ–º—É —Ç–∞–∫?</b>\n"
                f"‚Ä¢ –≠—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º\n"
                f"‚Ä¢ –ú—ã —Ö–æ—Ç–∏–º –ø—Ä–∏–Ω–æ—Å–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑—É\n"
                f"‚Ä¢ –ö–∞—Ä—Ç—ã –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ —Ä–æ—Å—Ç–∞\n\n"
                f"üìà <b>–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫:</b> {attempts_left}\n"
                f"üí° <b>–õ—É—á—à–µ —Å–ø—Ä–æ—Å–∏ –æ:</b>\n"
                f"‚Ä¢ –õ–∏—á–Ω–æ—Å—Ç–Ω–æ–º —Ä–æ—Å—Ç–µ\n"
                f"‚Ä¢ –û—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ –æ–±—â–µ–Ω–∏–∏\n"
                f"‚Ä¢ –ö–∞—Ä—å–µ—Ä–µ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ\n"
                f"‚Ä¢ –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≥–∞—Ä–º–æ–Ω–∏–∏\n\n"
                f"<i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å.</i>",
                parse_mode='HTML'
            )
            return
    
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    state_data = await state.get_data()
    num_cards = state_data.get("num_cards", 3)
    reading_type = state_data.get("reading_type", "classic")
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—ã
    cards = generate_tarot_cards(num_cards)
    
    # ---- –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ó–ê–ü–†–û–°–û–í ----
    use_premium = False
    
    # –ï—Å–ª–∏ –Ω–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö, –Ω–æ –µ—Å—Ç—å –ø—Ä–µ–º–∏—É–º - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–º–∏—É–º
    if user_data["requests_left"] <= 0 and user_data["premium_requests"] > 0:
        use_premium = True
        logger.info(f"üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å) –¥–ª—è user {user_id}")
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ, –∏ –ø—Ä–µ–º–∏—É–º - 30% —à–∞–Ω—Å –Ω–∞ –ø—Ä–µ–º–∏—É–º
    elif user_data["requests_left"] > 0 and user_data["premium_requests"] > 0:
        if random.random() < 0.3:  # 30% —à–∞–Ω—Å
            use_premium = True
            logger.info(f"üé≤ –í—ã–ø–∞–ª —à–∞–Ω—Å 30% - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å –¥–ª—è user {user_id}")
        else:
            use_premium = False
            logger.info(f"üé≤ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è user {user_id}")
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    elif user_data["requests_left"] > 0:
        use_premium = False
        logger.info(f"üìä –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–ø—Ä–µ–º–∏—É–º–æ–≤ –Ω–µ—Ç) –¥–ª—è user {user_id}")
    
    # –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏—á–µ–≥–æ - use_premium –æ—Å—Ç–∞—ë—Ç—Å—è False, –Ω–æ use_request –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø—Ä–æ—Å (—Ñ—É–Ω–∫—Ü–∏—è use_request —Ç–æ–∂–µ —É–º–Ω–∞—è –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)
    success = await db.use_request(user_id, use_premium)
    
    if not success:
        await message.answer(
            "‚ùåüîÆ <b>–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å!</b>\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.\n\n"
            "üí° <b>–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:</b>\n"
            f"‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ: {user_data['requests_left']}\n"
            f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º: {user_data['premium_requests']}\n\n"
            "<i>–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî –æ–±—Ä–∞—Ç–∏—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!</i>",
            reply_markup=await main_menu_keyboard(user_data),
            parse_mode='HTML'
        )
        await state.clear()
        return
    
    # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Å —ç–º–æ–¥–∑–∏
    cards_with_emoji = []
    card_emojis = ["üÉè", "‚ú®", "üåü", "üí´", "üåô"]
    for i, card in enumerate(cards):
        emoji = card_emojis[i % len(card_emojis)]
        cards_with_emoji.append(f"{emoji} {card}")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–∏
    thinking_msgs = [
        f"üîÆüåô <b>{TAROT_READER_NAME} —Ä–∞–∑–º—ã—à–ª—è–µ—Ç...</b>\n\n"
        f"<i>–ö–∞—Ä—Ç—ã —Ç–∏—Ö–æ —à–µ–ø—á—É—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º...</i>\n\n"
        f"üÉè –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã:\n" + "\n".join(cards_with_emoji),
        
        f"üåüüîÆ <b>–ö–∞—Ä—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ...</b>\n\n"
        f"<i>{TAROT_READER_NAME} —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—ã —Å –æ—Å–æ–±—ã–º –≤–Ω–∏–º–∞–Ω–∏–µ–º...</i>\n\n"
        f"üé¥ –í—ã–ø–∞–≤—à–∏–µ –∫–∞—Ä—Ç—ã:\n" + "\n".join(cards_with_emoji),
        
        f"üí´üÉè <b>–ú–∞–≥–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</b>\n\n"
        f"<i>–ö–∞—Ä—Ç—ã –Ω–∞—á–∏–Ω–∞—é—Ç —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Å–≤–æ–∏ —Ç–∞–π–Ω—ã...</i>\n\n"
        f"‚ú® –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∫–∞—Ä—Ç—ã:\n" + "\n".join(cards_with_emoji)
    ]
    
    thinking_msg = await message.answer(
        random.choice(thinking_msgs),
        parse_mode='HTML'
    )
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        history = await db.get_history(user_id, limit=3)
        full_history = ""
        
        if history:
            full_history = "üìú –ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–∞—Å–∫–ª–∞–¥—ã —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
            for record in history:
                full_history += f"‚ùì –í–æ–ø—Ä–æ—Å: {record['question'][:80]}...\n"
                full_history += f"üÉè –ö–∞—Ä—Ç—ã: {record['cards']}\n"
                full_history += f"üí´ –¢–∏–ø: {record.get('reading_type', '–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π')}\n\n"
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
        response_data = await get_tarot_response(
            question=question,
            cards=cards,
            is_premium=use_premium,
            full_history=full_history,
            user_id=user_id,
            username=message.from_user.username or "user"
        )
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–∏
        await bot.delete_message(message.chat.id, thinking_msg.message_id)
        
        if response_data and 'choices' in response_data:
            answer = response_data['choices'][0]['message']['content']
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            await db.add_history(
                user_id=user_id,
                question=question,
                cards=", ".join(cards),
                response=answer,
                reading_type=reading_type,
                is_premium=use_premium
            )
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            formatted_messages = format_tarot_response(
                answer=answer,
                question=question,
                cards=cards,
                is_premium=use_premium,
                reader_name=TAROT_READER_NAME
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –æ—á–µ—Ä–µ–¥–∏
            for i, msg in enumerate(formatted_messages):
                # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ)
                if i > 0:
                    await asyncio.sleep(0.5)  # –£–≤–µ–ª–∏—á–∏–ª –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
                
                # –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –¥–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é
                if i == len(formatted_messages) - 1:
                    final_text = f"{msg}\n\n"
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    final_text += f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–∫–ª–∞–¥–∞:</b>\n"
                    final_text += f"‚Ä¢ üÉè –ö–∞—Ä—Ç: {num_cards}\n"
                    final_text += f"‚Ä¢ üí´ –¢–∏–ø: {reading_type}\n"
                    final_text += f"‚Ä¢ üíé –†–µ–∂–∏–º: {'–ü—Ä–µ–º–∏—É–º' if use_premium else '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}\n"
                    final_text += f"‚Ä¢ üìÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏—é\n\n"
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–≤–µ—Ç
                    final_text += f"üí° <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ä–∞—Å–∫–ª–∞–¥–æ–º:</b>\n"
                    final_text += f"‚Ä¢ üìù –ó–∞–ø–∏—à–∏ –≤–∞–∂–Ω—ã–µ –º—ã—Å–ª–∏\n"
                    final_text += f"‚Ä¢ üîÑ –í–µ—Ä–Ω–∏—Å—å –∫ –Ω–µ–º—É —á–µ—Ä–µ–∑ –¥–µ–Ω—å\n"
                    final_text += f"‚Ä¢ ‚ù§Ô∏è –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ —á—É–≤—Å—Ç–≤–∞–º\n"
                    final_text += f"‚Ä¢ üå± –í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω —à–∞–≥ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π\n\n"
                    
                    final_text += f"\nüíé <i>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî —Ö–æ—Ä–æ—à–æ, –Ω–æ –ø—Ä–µ–º–∏—É–º –¥–∞—ë—Ç –≥–ª—É–±–æ–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã. –ö—É–ø–∏ —Å–µ–π—á–∞—Å!</i>\n"
                    final_text += f"üéÅ <b>–°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:</b> –ö—É–ø–∏ –ø—Ä–µ–º–∏—É–º —Å–µ–≥–æ–¥–Ω—è –∏ –Ω–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @katya_katerina_bu, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥! ‚ú®\n"
                    final_text += f"üî• <b>–•–æ—á–µ—à—å –µ—â—ë –±–æ–ª–µ–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã?</b> –ü–µ—Ä–µ—Ö–æ–¥–∏ –≤ @EroticMoonBot\n\n"
                    final_text += f"<i>–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –¥–æ–≤–µ—Ä–∏–µ –∫ –∫–∞—Ä—Ç–∞–º! üåô</i>"
                    
                    await message.answer(
                        final_text,
                        reply_markup=await main_menu_keyboard(await db.get_user(user_id)),
                        parse_mode='HTML'
                    )
                else:
                    await message.answer(msg, parse_mode='HTML')
            
            # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥
            logger.info(f"üîÆ Reading completed for user {user_id}: {question[:50]}...")
            
        else:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
            await db.update_user_requests(user_id, 
                free_requests=1 if not use_premium else 0,
                premium_requests=1 if use_premium else 0
            )
            
            await message.answer(
                "‚ùåüåô <b>–ö–∞—Ä—Ç—ã —Å–µ–≥–æ–¥–Ω—è –æ—Ç–¥—ã—Ö–∞—é—Ç...</b>\n\n"
                "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –Ω–æ –Ω–µ –≤–æ–ª–Ω—É–π—Å—è:\n"
                "‚Ä¢ üîÑ –¢–≤–æ–π –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â—ë–Ω\n"
                "‚Ä¢ ‚è≥ –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç\n"
                "‚Ä¢ üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è ‚Äî –Ω–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n\n"
                "<i>–ò–Ω–æ–≥–¥–∞ –∫–∞—Ä—Ç–∞–º –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ —Ç–∏—à–∏–Ω—ã...</i>",
                reply_markup=await main_menu_keyboard(user_data),
                parse_mode='HTML'
            )
    
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Error in reading process: {e}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ
        await db.update_user_requests(user_id,
            free_requests=1 if not use_premium else 0,
            premium_requests=1 if use_premium else 0
        )
        
        await message.answer(
            "‚ö†Ô∏èüîÆ <b>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞!</b>\n\n"
            "–ù–æ –º—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –µ—ë —Ä–µ—à–µ–Ω–∏–µ–º:\n"
            "‚Ä¢ üîÑ –¢–≤–æ–π –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â—ë–Ω\n"
            "‚Ä¢ üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞\n"
            "‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω\n\n"
            "üí° <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</b>\n"
            "1. –ü–æ–¥–æ–∂–¥–∏ 15-20 –º–∏–Ω—É—Ç\n"
            "2. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞\n"
            "3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è ‚Äî –Ω–∞–ø–∏—à–∏ /help\n\n"
            "<i>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ! –ö–∞—Ä—Ç—ã —Å–∫–æ—Ä–æ –≤–µ—Ä–Ω—É—Ç—Å—è.</i>",
            reply_markup=await main_menu_keyboard(user_data),
            parse_mode='HTML'
        )
    
    await state.clear()

# –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å, –Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –ø–æ–∫–∞–∂—É –∫–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

@router.callback_query(F.data == "profile_submenu")
async def profile_submenu_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è."""
    user_id = callback.from_user.id
    
    try:
        user_data = await db.get_user(user_id)
        
        if not user_data:
            # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            await db.add_user(
                user_id=user_id,
                username=callback.from_user.username or "user",
                first_name=callback.from_user.first_name or "",
                last_name=callback.from_user.last_name or ""
            )
            user_data = await db.get_user(user_id)
        
        if not user_data:
            await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞! –ù–∞—á–Ω–∏ —Å /start", show_alert=True)
            return
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
        ref_stats = await db.get_referral_stats(user_id)
        
        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        user_level = await get_user_level(user_id)
        achievements = await get_user_achievements(user_id)
        
        profile_text = (
            f"üë§üåü <b>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>\n\n"
            
            f"üÜî <b>ID:</b> <code>{user_id}</code>\n"
            f"üëÅÔ∏è‚Äçüó®Ô∏è <b>–ò–º—è:</b> {callback.from_user.first_name or '–ê–Ω–æ–Ω–∏–º'}\n"
            f"üìÖ <b>–° –Ω–∞–º–∏ —Å:</b> {format_datetime(user_data.get('created_at'))}\n\n"
            
            f"üéØ <b>–£—Ä–æ–≤–µ–Ω—å:</b> {user_level}\n"
        )
        
        if achievements:
            profile_text += f"üèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {', '.join(achievements[:5])}\n"
            if len(achievements) > 5:
                profile_text += f"<i>–∏ –µ—â—ë {len(achievements) - 5}...</i>\n"
        profile_text += "\n"
        
        profile_text += (
            f"üîÆ <b>–¢–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã:</b>\n"
            f"‚Ä¢ üÜì <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö:</b> {user_data['requests_left']}\n"
            f"‚Ä¢ üíé <b>–ü—Ä–µ–º–∏—É–º:</b> {user_data['premium_requests']}\n\n"
            
            f"ü§ù <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞:</b>\n"
            f"‚Ä¢ üë• <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ:</b> {ref_stats['referrals_count']}\n"
            f"‚Ä¢ ‚≠ê <b>–ê–∫—Ç–∏–≤–Ω—ã—Ö:</b> {ref_stats['active_referrals']}\n"
            f"‚Ä¢ üéÅ <b>–ë–æ–Ω—É—Å–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ:</b> {ref_stats['total_bonuses']}\n\n"
            
            f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</b>\n"
            f"‚Ä¢ üîÆ –†–∞—Å–∫–ª–∞–¥–æ–≤ —Å–¥–µ–ª–∞–Ω–æ: {await db.get_total_history_count(user_id)}\n"
            f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥–æ–≤: {await db.get_premium_history_count(user_id)}\n"
            f"‚Ä¢ ‚è±Ô∏è –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: {format_datetime(user_data.get('last_activity', ''))}\n\n"
            
            f"üí° <i>–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π +1 –∑–∞–ø—Ä–æ—Å –∑–∞ –∫–∞–∂–¥–æ–≥–æ! üåü</i>"
        )
        
        await callback.message.edit_text(
            profile_text,
            reply_markup=profile_submenu_keyboard(),
            parse_mode='HTML'
        )
        await safe_answer(callback)
    
    except Exception as e:
        logger.error(f"Error in profile_submenu_handler: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è", show_alert=True)
    
    except Exception as e:
        logger.error(f"Error in profile_submenu_handler: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è", show_alert=True)

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏—á

@router.callback_query(F.data == "examples")
async def examples_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤."""
    await callback.message.edit_text(
        "üìöüåü <b>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤</b>\n\n"
        
        "üí° <b>–ö–∞–∫ –∑–∞–¥–∞–≤–∞—Ç—å —Ö–æ—Ä–æ—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã:</b>\n"
        "1. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω, –Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π\n"
        "2. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–µ–±–µ –∏ —Å–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö\n"
        "3. –ò–∑–±–µ–≥–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤ '–¥–∞/–Ω–µ—Ç'\n"
        "4. –ë—É–¥—å –æ—Ç–∫—Ä—ã—Ç –∫ —Ä–∞–∑–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º\n\n"
        
        "üíñ <b>–í–æ–ø—Ä–æ—Å—ã –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö:</b>\n"
        "‚Ä¢ –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –Ω–∞—à–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è?\n"
        "‚Ä¢ –ß—Ç–æ —è –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏?\n"
        "‚Ä¢ –ö–∞–∫–∏–µ —É—Ä–æ–∫–∏ —è –∏–∑–≤–ª–µ–∫–∞—é –∏–∑ —ç—Ç–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π?\n"
        "‚Ä¢ –ö–∞–∫ –º–Ω–µ –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞?\n\n"
        
        "üíº <b>–í–æ–ø—Ä–æ—Å—ã –æ –∫–∞—Ä—å–µ—Ä–µ:</b>\n"
        "‚Ä¢ –ö–∞–∫—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã–±—Ä–∞—Ç—å –¥–ª—è —Ä–æ—Å—Ç–∞?\n"
        "‚Ä¢ –ù–∞ –∫–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ?\n"
        "‚Ä¢ –ö–∞–∫ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Ç–µ–∫—É—â–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏?\n"
        "‚Ä¢ –í –∫–∞–∫–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è?\n\n"
        
        "üå± <b>–í–æ–ø—Ä–æ—Å—ã –æ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º —Ä–æ—Å—Ç–µ:</b>\n"
        "‚Ä¢ –ö–∞–∫ —Å—Ç–∞—Ç—å –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è?\n"
        "‚Ä¢ –ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è?\n"
        "‚Ä¢ –ö–∞–∫–∏–µ —Ç–∞–ª–∞–Ω—Ç—ã –º–Ω–µ —Ä–∞—Å–∫—Ä—ã—Ç—å?\n"
        "‚Ä¢ –ö–∞–∫ –Ω–∞–π—Ç–∏ –±–∞–ª–∞–Ω—Å –≤ –∂–∏–∑–Ω–∏?\n\n"
        
        "üé≠ <b>–í–æ–ø—Ä–æ—Å—ã –æ —Å–∏—Ç—É–∞—Ü–∏—è—Ö:</b>\n"
        "‚Ä¢ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?\n"
        "‚Ä¢ –ö–∞–∫–∏–µ —Å–∫—Ä—ã—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –µ—Å—Ç—å?\n"
        "‚Ä¢ –ö–∞–∫–æ–π —É—Ä–æ–∫ —è –º–æ–≥—É –∏–∑–≤–ª–µ—á—å?\n"
        "‚Ä¢ –ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å —Å–µ–π—á–∞—Å?\n\n"
        
        "‚ú® <b>–û–±—â–∏–µ —Ö–æ—Ä–æ—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã:</b>\n"
        "‚Ä¢ –ß—Ç–æ –¥–ª—è –º–µ–Ω—è –≤–∞–∂–Ω–æ —Å–µ–π—á–∞—Å?\n"
        "‚Ä¢ –ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –±—É–¥–µ—Ç –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–º?\n"
        "‚Ä¢ –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –º–Ω–µ —Ä–∞—Å—Ç–∏?\n"
        "‚Ä¢ –ö–∞–∫ –Ω–∞–π—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≥–∞—Ä–º–æ–Ω–∏—é?\n\n"
        
        "‚ùå <b>–ß–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å:</b>\n"
        "‚Ä¢ –ö–æ–≥–¥–∞ —è –≤—Å—Ç—Ä–µ—á—É –ª—é–±–æ–≤—å? (—Å–ª–∏—à–∫–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)\n"
        "‚Ä¢ –ü–æ–ª—É—á—É –ª–∏ —è –ø–æ–≤—ã—à–µ–Ω–∏–µ? (–¥–∞/–Ω–µ—Ç –≤–æ–ø—Ä–æ—Å)\n"
        "‚Ä¢ –ß—Ç–æ –¥—É–º–∞–µ—Ç –æ–±–æ –º–Ω–µ X? (–ø—Ä–æ –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞)\n"
        "‚Ä¢ –°—Ç–æ–∏—Ç –ª–∏ –º–Ω–µ –¥–µ–ª–∞—Ç—å Y? (—Ä–µ—à–µ–Ω–∏–µ –∑–∞ —Ç–µ–±—è)\n\n"
        
        "<i>–ü–æ–º–Ω–∏: –ª—É—á—à–∏–π –≤–æ–ø—Ä–æ—Å ‚Äî —Ç–æ—Ç, —á—Ç–æ –∏–¥—ë—Ç –æ—Ç —Å–µ—Ä–¥—Ü–∞! ‚ù§Ô∏è</i>",
        reply_markup=examples_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "achievements")
async def achievements_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π."""
    user_id = callback.from_user.id
    achievements = await get_user_achievements(user_id)
    user_level = await get_user_level(user_id)
    
    all_achievements = [
        {"name": "üå± –ù–æ–≤–∏—á–æ–∫", "description": "–ü–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥", "emoji": "üå±"},
        {"name": "üîÆ –ò—Å–∫–∞—Ç–µ–ª—å", "description": "5 —Ä–∞—Å–∫–ª–∞–¥–æ–≤", "emoji": "üîÆ"},
        {"name": "üåü –ú—É–¥—Ä–µ—Ü", "description": "10 —Ä–∞—Å–∫–ª–∞–¥–æ–≤", "emoji": "üåü"},
        {"name": "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä", "description": "–ü–µ—Ä–≤—ã–π –ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥", "emoji": "üíé"},
        {"name": "ü§ù –ù–∞—Å—Ç–∞–≤–Ω–∏–∫", "description": "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞", "emoji": "ü§ù"},
        {"name": "üìö –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—Å—Ç", "description": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã —Ä–∞—Å–∫–ª–∞–¥–æ–≤", "emoji": "üìö"},
        {"name": "üí´ –ú–∞–≥", "description": "20 —Ä–∞—Å–∫–ª–∞–¥–æ–≤", "emoji": "üí´"},
        {"name": "üåô –ü—Ä–æ–≤–æ–¥–Ω–∏–∫", "description": "–ü–æ–º–æ—á—å 3 –¥—Ä—É–∑—å—è–º", "emoji": "üåô"},
    ]
    
    achievements_text = f"üèÜüåü <b>–¢–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b>\n\n"
    achievements_text += f"üéØ <b>–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</b> {user_level}\n\n"
    
    if achievements:
        achievements_text += "‚úÖ <b>–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ:</b>\n"
        for achievement in all_achievements:
            if achievement["name"] in achievements:
                achievements_text += f"{achievement['emoji']} <b>{achievement['name']}</b>\n"
                achievements_text += f"<i>{achievement['description']}</i>\n\n"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    achievements_text += "üéØ <b>–ë–ª–∏–∂–∞–π—à–∏–µ —Ü–µ–ª–∏:</b>\n"
    for achievement in all_achievements[:3]:
        if achievement["name"] not in achievements:
            achievements_text += f"üîí {achievement['emoji']} {achievement['name']}\n"
            achievements_text += f"<i>{achievement['description']}</i>\n\n"
    
    achievements_text += "üí° <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n"
    achievements_text += "‚Ä¢ üîÆ –î–µ–ª–∞–π —Ä–∞—Å–∫–ª–∞–¥—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ\n"
    achievements_text += "‚Ä¢ üíé –ü—Ä–æ–±—É–π –ø—Ä–µ–º–∏—É–º-—Ñ–æ—Ä–º–∞—Ç\n"
    achievements_text += "‚Ä¢ ü§ù –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π\n"
    achievements_text += "‚Ä¢ üìö –ò—Å—Å–ª–µ–¥—É–π —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n\n"
    
    achievements_text += "<i>–ö–∞–∂–¥–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏! üåü</i>"
    
    await callback.message.edit_text(
        achievements_text,
        reply_markup=achievements_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "referral")
async def referral_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã."""
    user_id = callback.from_user.id
    referral_link = get_referral_link(user_id)
    
    ref_stats = await db.get_referral_stats(user_id)
    
    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    user_level = await get_user_level(user_id)
    
    referral_text = (
        f"ü§ùüåü <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n\n"
        
        f"üéÅ <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n"
        f"1. üì§ –î–µ–ª–∏—à—å—Å—è —Å–≤–æ–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–≥–æ–º\n"
        f"2. üéØ –î—Ä—É–≥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∏ –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥\n"
        f"3. üéâ –¢—ã –ø–æ–ª—É—á–∞–µ—à—å <b>+1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å</b>!\n"
        f"4. üí´ –î—Ä—É–≥ —Ç–æ–∂–µ –ø–æ–ª—É—á–∞–µ—Ç —Ç—ë–ø–ª—ã–π –ø—Ä–∏—ë–º\n\n"
        
        f"üìä <b>–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
        f"‚Ä¢ üë• <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π:</b> {ref_stats['referrals_count']}\n"
        f"‚Ä¢ ‚≠ê <b>–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥—Ä—É–∑–µ–π:</b> {ref_stats['active_referrals']}\n"
        f"‚Ä¢ üéÅ <b>–ë–æ–Ω—É—Å–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ:</b> {ref_stats['total_bonuses']}\n"
        f"‚Ä¢ üéØ <b>–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</b> {user_level}\n\n"
        
        f"‚ú® <b>–ü–æ—á–µ–º—É —ç—Ç–æ –≤—ã–≥–æ–¥–Ω–æ:</b>\n"
        f"‚Ä¢ üÜì <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</b> –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è\n"
        f"‚Ä¢ ü§ù <b>–ü–æ–º–æ—â—å –¥—Ä—É–∑—å—è–º</b> –æ—Ç–∫—Ä—ã—Ç—å –º–∏—Ä –¢–∞—Ä–æ\n"
        f"‚Ä¢ üèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b> –∏ –æ—Å–æ–±—ã–π —Å—Ç–∞—Ç—É—Å\n"
        f"‚Ä¢ üí´ <b>–û–±—â–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ</b> —Å–æ–æ–±—â–µ—Å—Ç–≤–∞\n\n"
        
        f"üîó <b>–¢–≤–æ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</b>\n"
        f"<code>{referral_link}</code>\n\n"
        
        f"üì§ <b>–ö–∞–∫ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è:</b>\n"
        f"1. –°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –≤—ã—à–µ\n"
        f"2. –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n"
        f"3. –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–≤–æ—ë–º –æ–ø—ã—Ç–µ —Å –∫–∞—Ä—Ç–∞–º–∏\n"
        f"4. –ë—É–¥—å –≥–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n\n"
        
        f"üí° <b>–°–æ–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç:</b>\n"
        f"<i>–î–µ–ª–∏—Ç—å—Å—è –º—É–¥—Ä–æ—Å—Ç—å—é ‚Äî –∑–Ω–∞—á–∏—Ç —É–º–Ω–æ–∂–∞—Ç—å –µ—ë. "
        f"–ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –¥—Ä—É–≥ –≤ –º–∏—Ä–µ –¢–∞—Ä–æ –¥–µ–ª–∞–µ—Ç –Ω–∞—à–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ —Å–∏–ª—å–Ω–µ–µ! üåü</i>"
    )
    
    await callback.message.edit_text(
        referral_text,
        reply_markup=referral_keyboard(referral_link),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "buy_premium")
async def buy_premium_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–æ–≤.
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª –ª–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω –ø–ª–∞—Ç—ë–∂, –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫ –µ—Å–ª–∏ –¥–∞.
    """
    user_id = callback.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º state - –±—ã–ª –ª–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω –ø–ª–∞—Ç—ë–∂
    state_data = await state.get_data()
    payment_checked = state_data.get("payment_checked", False)
    
    if payment_checked:
        # –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –±—ã–ª –ø—Ä–æ–≤–µ—Ä–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫
        await state.update_data({"payment_checked": False})  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
        await purchase_history_handler(callback)
        return
    
    # –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–æ–≤
    user_data = await db.get_user(user_id)
    
    await callback.message.edit_text(
        f"üíé‚ú® <b>–ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å—ã</b>\n\n"
        
        f"üåü <b>–ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–µ–º–∏—É–º:</b>\n"
        f"‚Ä¢ üîç <b>–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑</b> ‚Äî –≤ 2 —Ä–∞–∑–∞ –¥–µ—Ç–∞–ª—å–Ω–µ–µ\n"
        f"‚Ä¢ üéØ <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã</b> ‚Äî –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏\n"
        f"‚Ä¢ üí´ <b>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</b> ‚Äî –æ—Ç–≤–µ—Ç –±—ã—Å—Ç—Ä–µ–µ\n"
        f"‚Ä¢ üìö <b>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</b> ‚Äî –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏\n"
        f"‚Ä¢ üåô <b>–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ</b> {TAROT_READER_NAME}\n\n"
        
        f"üí≥ <b>–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏:</b>\n"
        f"1. üõí –í—ã–±–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–∞–∫–µ—Ç –Ω–∏–∂–µ\n"
        f"2. üí≥ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã –∏ –ø–µ—Ä–µ–≤–µ–¥–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞\n"
        f"3. ‚è≥ –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–æ–±—ã—á–Ω–æ –¥–æ 1 –º–∏–Ω—É—Ç—ã)\n"
        f"4. üéâ –ü–æ–ª—É—á–∏ –∑–∞–ø—Ä–æ—Å—ã –∏ –Ω–∞—á–Ω–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å!\n\n"
        
        f"üõ°Ô∏è <b>–ì–∞—Ä–∞–Ω—Ç–∏–∏:</b>\n"
        f"‚Ä¢ üîí <b>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞</b> ‚Äî —á–µ—Ä–µ–∑ –ÆMoney\n"
        f"‚Ä¢ ‚ö° <b>–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</b> ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ\n"
        f"‚Ä¢ üí¨ <b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7</b> ‚Äî –ø–æ–º–æ—â—å —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏\n"
        f"‚Ä¢ üîÑ <b>–í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö</b> ‚Äî –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫\n\n"
        
        f"üí° <b>–°–æ–≤–µ—Ç:</b>\n"
        f"<i>–ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å—ã –∏–¥–µ–∞–ª—å–Ω—ã –¥–ª—è –≤–∞–∂–Ω—ã—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π, "
        f"—Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –∏–ª–∏ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –æ—Å–æ–±–µ–Ω–Ω–æ –≥–ª—É–±–æ–∫–∏–π –≤–∑–≥–ª—è–¥. "
        f"–ö–∞—Ä—Ç—ã –±—É–¥—É—Ç –æ—Å–æ–±–µ–Ω–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –∫ —Ç–≤–æ–∏–º –≤–æ–ø—Ä–æ—Å–∞–º! üåô</i>",
        reply_markup=await payment_options_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data.startswith("buy_"))
async def process_payment_option(callback: CallbackQuery, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø–∞–∫–µ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤."""
    package_key = callback.data
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–∞—Ä–∏—Ñ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥
    rate = await db.get_rate(package_key)
    
    if rate:
        package = {
            "requests": rate["requests"],
            "price": rate["price"],
            "label": rate.get("label", f"{rate['requests']} –∑–∞–ø—Ä–æ—Å–æ–≤ ({rate['price']} —Ä—É–±.)")
        }
    elif package_key in PAYMENT_OPTIONS:
        package = PAYMENT_OPTIONS[package_key]
    else:
        await safe_answer(callback, "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç!")
        return
    user_id = callback.from_user.id

    label = yoomoney_payment.generate_label(user_id=user_id, package_key=package_key)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    import sqlite3
    from config import DB_PATH
    
    try:
        with sqlite3.connect(str(DB_PATH)) as conn:
            cursor = conn.cursor()
            cursor.execute(
                """
                INSERT INTO payments (user_id, amount, requests, yoomoney_label, status)
                VALUES (?, ?, ?, ?, 'pending')
                """,
                (user_id, package["price"], package["requests"], label)
            )
            payment_id = cursor.lastrowid

            import random
            unique_cents = random.randint(1, 99)
            payable_amount = round(float(package["price"]) + (unique_cents / 100.0), 2)

            cursor.execute(
                "UPDATE payments SET amount = ? WHERE id = ?",
                (payable_amount, payment_id)
            )
            conn.commit()
    except Exception as e:
        logger.error(f"Error saving payment: {e}")
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    payment_url = yoomoney_payment.build_payment_url(amount=payable_amount, label=label)
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –∑–∞ –∑–∞–ø—Ä–æ—Å –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
    price_per_request = package["price"] / package["requests"]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º payment_id –≤ state –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
    await state.update_data({
        "current_payment_id": payment_id,
        "current_payment_label": label,
        "current_package": package,
        "payment_checked": False  # –§–ª–∞–≥, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä–∏–ª –ø–ª–∞—Ç—ë–∂
    })
    
    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –æ–ø–ª–∞—Ç—ã
    keyboard = InlineKeyboardBuilder()
    keyboard.button(
        text=f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å {payable_amount} ‚ÇΩ —á–µ—Ä–µ–∑ –ÆMoney",
        url=payment_url
    )
    keyboard.button(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç—ë–∂", callback_data=f"check_payment_{payment_id}")
    keyboard.button(text="üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫", callback_data="purchase_history")
    keyboard.button(text="üîô –ù–∞–∑–∞–¥", callback_data="buy_premium")
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        f"üõí‚ú® <b>–í—ã–±—Ä–∞–Ω –ø–∞–∫–µ—Ç:</b> {package['label']}\n\n"
        
        f"üí∞ <b>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</b> <code>{payable_amount} —Ä—É–±.</code>\n"
        f"üéÅ <b>–ü–æ–ª—É—á–∏—à—å:</b> <code>{package['requests']}</code> –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–æ–≤\n"
        f"üìä <b>–¶–µ–Ω–∞ –∑–∞ –∑–∞–ø—Ä–æ—Å:</b> <code>{price_per_request:.1f} —Ä—É–±.</code>\n\n"
        
        f"üíé <b>–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç:</b>\n"
        f"‚Ä¢ {package['requests']} –≥–ª—É–±–æ–∫–∏—Ö –ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
        f"‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏\n"
        f"‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n"
        f"‚Ä¢ –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –æ—Ç {TAROT_READER_NAME}\n\n"
        
        f"üí≥ <b>–û–ø–ª–∞—Ç–∞:</b>\n"
        f"‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ\n"
        f"‚Ä¢ –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n"
        f"‚Ä¢ –û–±—ã—á–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 1 –º–∏–Ω—É—Ç—ã\n\n"
        
        f"‚è≥ <b>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:</b>\n"
        f"‚Ä¢ –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏\n"
        f"‚Ä¢ –ó–∞–ø—Ä–æ—Å—ã –ø–æ—è–≤—è—Ç—Å—è –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ\n"
        f"‚Ä¢ –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å!\n\n"
        
        f"üí° <b>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:</b>\n"
        f"‚Ä¢ –ù–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç—ë–∂' –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏\n"
        f"‚Ä¢ –ò–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–¥–æ 1 –º–∏–Ω—É—Ç—ã)\n"
        f"‚Ä¢ –°—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫'\n\n"
        
        f"<i>–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ –∫ –∫–∞—Ä—Ç–∞–º –∏ –Ω–∞—à–µ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É! üåü</i>",
        reply_markup=keyboard.as_markup(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data.startswith("check_payment_"))
async def check_payment_handler(callback: CallbackQuery, state: FSMContext, bot: Bot) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞.
    """
    user_id = callback.from_user.id
    
    try:
        payment_id = int(callback.data.replace("check_payment_", ""))
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
        import sqlite3
        from config import DB_PATH
        
        with sqlite3.connect(str(DB_PATH)) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("""
                SELECT p.*, u.username 
                FROM payments p
                LEFT JOIN users u ON p.user_id = u.user_id
                WHERE p.id = ? AND p.user_id = ?
            """, (payment_id, user_id))
            payment = cursor.fetchone()
        
        if not payment:
            await safe_answer(callback, "‚ö†Ô∏è –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
            return
        
        payment_dict = dict(payment)
        status = payment_dict.get("status", "unknown")
        yoomoney_label = payment_dict.get("yoomoney_label", "")
        
        # –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω
        if status == "confirmed":
            requests = payment_dict.get("requests", 0)
            amount = payment_dict.get("amount", 0)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å—ã
            user_data = await db.get_user(user_id)
            current_premium = user_data.get("premium_requests", 0) if user_data else 0
            
            keyboard = InlineKeyboardBuilder()
            keyboard.button(text="üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫", callback_data="purchase_history")
            keyboard.button(text="‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data="main_menu")
            keyboard.adjust(1)
            
            await callback.message.edit_text(
                f"‚úÖ <b>–ü–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!</b> üåô\n\n"
                f"üí∞ –°—É–º–º–∞: {amount} —Ä—É–±.\n"
                f"üîÆ –ù–∞—á–∏—Å–ª–µ–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {requests}\n"
                f"üíé –¢–µ–∫—É—â–∏—Ö –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–æ–≤: {current_premium}\n\n"
                f"<i>–ó–∞–ø—Ä–æ—Å—ã —É–∂–µ –Ω–∞ –≤–∞—à–µ–º —Å—á–µ—Ç—É. –ú–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤!</i>",
                reply_markup=keyboard.as_markup(),
                parse_mode='HTML'
            )
            await safe_answer(callback, "‚úÖ –ü–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!")
            return
        
        # –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ pending, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ YooMoney API
        await safe_answer(callback, "‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –ø–ª–∞—Ç—ë–∂...", show_alert=False)
        
        logger.info(f"Manual payment check: user {user_id}, payment_id {payment_id}, label {yoomoney_label}")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ main.py (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ —Å—É–º–º–µ –∏ –≤—Ä–µ–º–µ–Ω–∏)
        try:
            from main import check_yoomoney_payments
            await check_yoomoney_payments()
        except Exception as e:
            logger.error(f"Error calling check_yoomoney_payments: {e}", exc_info=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        with sqlite3.connect(str(DB_PATH)) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("SELECT status FROM payments WHERE id = ?", (payment_id,))
            result = cursor.fetchone()
            new_status = result[0] if result else status
        
        if new_status == "confirmed":
            # –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω - –ø–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            with sqlite3.connect(str(DB_PATH)) as conn:
                conn.row_factory = sqlite3.Row
                cursor = conn.cursor()
                cursor.execute("SELECT amount, requests FROM payments WHERE id = ?", (payment_id,))
                result = cursor.fetchone()
                if result:
                    amount = result["amount"]
                    requests = result["requests"]
                else:
                    amount = payment_dict.get("amount", 0)
                    requests = payment_dict.get("requests", 0)
            
            user_data = await db.get_user(user_id)
            current_premium = user_data.get("premium_requests", 0) if user_data else 0
            
            keyboard = InlineKeyboardBuilder()
            keyboard.button(text="üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫", callback_data="purchase_history")
            keyboard.button(text="‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data="main_menu")
            keyboard.adjust(1)
            
            await callback.message.edit_text(
                f"‚úÖ <b>–ü–ª–∞—Ç—ë–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!</b> üåô\n\n"
                f"üí∞ –°—É–º–º–∞: {amount} —Ä—É–±.\n"
                f"üîÆ –ù–∞—á–∏—Å–ª–µ–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {requests}\n"
                f"üíé –¢–µ–∫—É—â–∏—Ö –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–æ–≤: {current_premium}\n\n"
                f"<i>–ó–∞–ø—Ä–æ—Å—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ –≤–∞—à —Å—á—ë—Ç! –ú–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤.</i>",
                reply_markup=keyboard.as_markup(),
                parse_mode='HTML'
            )
            await safe_answer(callback, "‚úÖ –ü–ª–∞—Ç—ë–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!")
        else:
            # –ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏
            keyboard = InlineKeyboardBuilder()
            keyboard.button(text="üÜò –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="payment_support")
            keyboard.button(text="üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫", callback_data="purchase_history")
            keyboard.button(text="üîô –ù–∞–∑–∞–¥", callback_data="buy_premium")
            keyboard.adjust(1)
            
            await callback.message.edit_text(
                f"‚è≥ <b>–ü–ª–∞—Ç—ë–∂ –µ—â—ë –Ω–µ –Ω–∞–π–¥–µ–Ω</b> üåô\n\n"
                f"üìã –°—Ç–∞—Ç—É—Å: <code>{status}</code>\n"
                f"üÜî ID –ø–ª–∞—Ç–µ–∂–∞: <code>{payment_id}</code>\n\n"
                f"<i>–ü–ª–∞—Ç—ë–∂ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –¥–æ 2 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.\n"
                f"–ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–ª–∞—Ç—ë–∂ —Ç–æ—á–Ω–æ –ø—Ä–æ—à—ë–ª, "
                f"–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É - –º—ã –ø–æ–º–æ–∂–µ–º!</i>",
                reply_markup=keyboard.as_markup(),
                parse_mode='HTML'
            )
            await safe_answer(callback, "‚è≥ –ü–ª–∞—Ç—ë–∂ –µ—â—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è")
            
    except Exception as e:
        logger.error(f"Error in check_payment: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–ª–∞—Ç–µ–∂–∞", show_alert=True)

@router.callback_query(F.data == "payment_support")
async def payment_support_handler(callback: CallbackQuery, state: FSMContext, bot: Bot) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ –ø–ª–∞—Ç–µ–∂—É.
    """
    user_id = callback.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    import sqlite3
    from config import DB_PATH, ADMIN_ID
    
    try:
        with sqlite3.connect(str(DB_PATH)) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("""
                SELECT id, amount, requests, status, yoomoney_label, timestamp
                FROM payments
                WHERE user_id = ?
                ORDER BY timestamp DESC
                LIMIT 1
            """, (user_id,))
            payment = cursor.fetchone()
        
        if payment:
            payment_dict = dict(payment)
            payment_id = payment_dict["id"]
            amount = payment_dict["amount"]
            requests = payment_dict["requests"]
            status = payment_dict["status"]
            label = payment_dict.get("yoomoney_label", "–Ω–µ—Ç")
            timestamp = payment_dict.get("timestamp", "")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
            support_message = (
                f"üÜò <b>–û–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ –ø–ª–∞—Ç–µ–∂—É</b> üåô\n\n"
                f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {callback.from_user.full_name}\n"
                f"üì± <b>Username:</b> @{callback.from_user.username or '–Ω–µ—Ç'}\n"
                f"üÜî <b>ID:</b> <code>{user_id}</code>\n\n"
                f"üí≥ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ:</b>\n"
                f"‚Ä¢ üÜî ID –ø–ª–∞—Ç–µ–∂–∞: <code>{payment_id}</code>\n"
                f"‚Ä¢ üí∞ –°—É–º–º–∞: {amount} —Ä—É–±.\n"
                f"‚Ä¢ üîÆ –ó–∞–ø—Ä–æ—Å–æ–≤: {requests}\n"
                f"‚Ä¢ üìä –°—Ç–∞—Ç—É—Å: <code>{status}</code>\n"
                f"‚Ä¢ üè∑Ô∏è Label: <code>{label}</code>\n"
                f"‚Ä¢ ‚è∞ –í—Ä–µ–º—è: {format_datetime(timestamp)}\n\n"
                f"<i>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ —Å –ø–ª–∞—Ç–µ–∂–æ–º.</i>"
            )
            
            try:
                await bot.send_message(ADMIN_ID, support_message, parse_mode='HTML')
                logger.info(f"üîÆ Support message sent to admin for payment {payment_id}")
            except Exception as e:
                logger.error(f"Failed to send support message to admin: {e}")
            
            keyboard = InlineKeyboardBuilder()
            keyboard.button(text="‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data="main_menu")
            keyboard.adjust(1)
            
            await callback.message.edit_text(
                f"üìû <b>–û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</b> üåô\n\n"
                f"–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–ª—É—á–µ–Ω–æ.\n\n"
                f"üìã <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ:</b>\n"
                f"‚Ä¢ üÜî ID: <code>{payment_id}</code>\n"
                f"‚Ä¢ üí∞ –°—É–º–º–∞: {amount} —Ä—É–±.\n"
                f"‚Ä¢ üîÆ –ó–∞–ø—Ä–æ—Å–æ–≤: {requests}\n"
                f"‚Ä¢ üìä –°—Ç–∞—Ç—É—Å: <code>{status}</code>\n\n"
                f"<i>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n"
                f"–û–±—ã—á–Ω–æ –æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞.</i>",
                reply_markup=keyboard.as_markup(),
                parse_mode='HTML'
            )
            await safe_answer(callback, "‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
        else:
            keyboard = InlineKeyboardBuilder()
            keyboard.button(text="üîô –ù–∞–∑–∞–¥", callback_data="buy_premium")
            keyboard.adjust(1)
            
            await callback.message.edit_text(
                f"‚ö†Ô∏è <b>–ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω</b> üåô\n\n"
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º –ø–ª–∞—Ç–µ–∂–µ.\n\n"
                f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                f"1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂\n"
                f"2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ–ø–ª–∞—Ç—ã\n"
                f"3. –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —á–µ—Ä–µ–∑ –º–µ–Ω—é",
                reply_markup=keyboard.as_markup(),
                parse_mode='HTML'
            )
            await safe_answer(callback, "‚ö†Ô∏è –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            
    except Exception as e:
        logger.error(f"Error in payment_support: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–±—Ä–∞—â–µ–Ω–∏—è", show_alert=True)

# ==================== –ò–°–¢–û–†–ò–Ø –ü–û–ö–£–ü–û–ö ====================

def purchase_history_pagination_keyboard(page: int, total_pages: int, pending_payment_ids: Optional[List[int]] = None) -> InlineKeyboardBuilder:
    """–°–æ–∑–¥–∞—ë—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫."""
    keyboard = InlineKeyboardBuilder()

    nav_buttons_count = 1

    if page > 0:
        keyboard.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"purchase_history_prev_{page}")
        nav_buttons_count += 1

    keyboard.button(text=f"{page + 1}/{total_pages}", callback_data="purchase_history_page")

    if page < total_pages - 1:
        keyboard.button(text="–í–ø–µ—Ä—ë–¥ ‚û°Ô∏è", callback_data=f"purchase_history_next_{page}")
        nav_buttons_count += 1

    sizes = [nav_buttons_count]

    if pending_payment_ids:
        for pid in pending_payment_ids[:3]:
            keyboard.button(text=f"‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç—ë–∂ #{pid}", callback_data=f"check_payment_{pid}")
            sizes.append(1)

    keyboard.button(text="üîô –í –ø—Ä–æ—Ñ–∏–ª—å", callback_data="profile_submenu")
    sizes.append(1)

    keyboard.adjust(*sizes)
    return keyboard.as_markup()

def get_payment_status_text(status: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Ç–∞–µ–º—ã–π —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º."""
    status_map = {
        "pending": "‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã",
        "confirmed": "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ",
        "rejected": "‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ",
        "manual": "üë§ –ù–∞—á–∏—Å–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é",
        "cancelled": "üö´ –û—Ç–º–µ–Ω–µ–Ω–æ"
    }
    return status_map.get(status, f"‚ùì {status}")

@router.callback_query(F.data == "purchase_history")
async def purchase_history_handler(callback: CallbackQuery) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫.
    """
    user_id = callback.from_user.id
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        payments = await db.get_user_payments(user_id, limit=5, offset=0)
        total_count = await db.get_user_payments_count(user_id)
        total_pages = (total_count + 4) // 5  # –ü–æ 5 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        
        if not payments:
            keyboard = InlineKeyboardBuilder()
            keyboard.button(text="üíé –ö—É–ø–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã", callback_data="buy_premium")
            keyboard.button(text="üîô –í –ø—Ä–æ—Ñ–∏–ª—å", callback_data="profile_submenu")
            keyboard.adjust(1)
            
            await callback.message.edit_text(
                "üí≥ <b>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</b> üåô\n\n"
                "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫.\n\n"
                "üí° <b>–•–æ—Ç–∏—Ç–µ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã?</b>\n"
                "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ!",
                reply_markup=keyboard.as_markup(),
                parse_mode='HTML'
            )
            await safe_answer(callback)
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏
        history_text = "üí≥ <b>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</b> üåô\n\n"

        pending_payment_ids = []
        
        for i, payment in enumerate(payments, 1):
            payment_id = payment.get("id", 0)
            amount = payment.get("amount", 0)
            requests = payment.get("requests", 0)
            status = payment.get("status", "unknown")
            timestamp = payment.get("timestamp", "")
            tariff_name = payment.get("tariff_name", f"{requests} –∑–∞–ø—Ä–æ—Å–æ–≤")

            if status == "pending" and payment_id:
                pending_payment_ids.append(payment_id)
            
            status_text = get_payment_status_text(status)
            date_text = format_datetime(timestamp)
            
            history_text += (
                f"üì¶ <b>–ü–æ–∫—É–ø–∫–∞ #{payment_id}</b>\n"
                f"üìÖ {date_text}\n"
                f"üíé –¢–∞—Ä–∏—Ñ: {tariff_name}\n"
                f"üí∞ –°—É–º–º–∞: {amount} —Ä—É–±.\n"
                f"üìä –°—Ç–∞—Ç—É—Å: {status_text}\n\n"
            )
        
        if total_pages > 1:
            history_text += f"<i>–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ {total_pages}</i>\n"
        
        markup = purchase_history_pagination_keyboard(0, total_pages, pending_payment_ids=pending_payment_ids)

        await callback.message.edit_text(
            history_text,
            reply_markup=markup,
            parse_mode='HTML'
        )
        await safe_answer(callback)
        
    except Exception as e:
        logger.error(f"Error in purchase_history: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏", show_alert=True)

@router.callback_query(F.data.startswith("purchase_history_"))
async def purchase_history_pagination_handler(callback: CallbackQuery) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫.
    """
    user_id = callback.from_user.id
    
    try:
        data = callback.data
        if data.startswith("purchase_history_prev_"):
            page = int(data.replace("purchase_history_prev_", ""))
        elif data.startswith("purchase_history_next_"):
            page = int(data.replace("purchase_history_next_", ""))
        elif data == "purchase_history_page":
            # –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            await safe_answer(callback)
            return
        else:
            await safe_answer(callback, "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        limit = 5
        offset = page * limit
        payments = await db.get_user_payments(user_id, limit=limit, offset=offset)
        total_count = await db.get_user_payments_count(user_id)
        total_pages = (total_count + limit - 1) // limit
        
        if not payments and page > 0:
            # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—É—Å—Ç–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é
            page = 0
            offset = 0
            payments = await db.get_user_payments(user_id, limit=limit, offset=offset)
        
        if not payments:
            await safe_answer(callback, "‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏
        history_text = "üí≥ <b>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</b> üåô\n\n"
        
        for i, payment in enumerate(payments, 1):
            payment_id = payment.get("id", 0)
            amount = payment.get("amount", 0)
            requests = payment.get("requests", 0)
            status = payment.get("status", "unknown")
            timestamp = payment.get("timestamp", "")
            tariff_name = payment.get("tariff_name", f"{requests} –∑–∞–ø—Ä–æ—Å–æ–≤")
            
            status_text = get_payment_status_text(status)
            date_text = format_datetime(timestamp)
            
            history_text += (
                f"üì¶ <b>–ü–æ–∫—É–ø–∫–∞ #{payment_id}</b>\n"
                f"üìÖ {date_text}\n"
                f"üíé –¢–∞—Ä–∏—Ñ: {tariff_name}\n"
                f"üí∞ –°—É–º–º–∞: {amount} —Ä—É–±.\n"
                f"üìä –°—Ç–∞—Ç—É—Å: {status_text}\n\n"
            )
        
        if total_pages > 1:
            history_text += f"<i>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {total_pages}</i>\n"
        
        markup = purchase_history_pagination_keyboard(page, total_pages, pending_payment_ids=pending_payment_ids)

        await callback.message.edit_text(
            history_text,
            reply_markup=markup,
            parse_mode='HTML'
        )
        await safe_answer(callback)
        
    except Exception as e:
        logger.error(f"Error in purchase_history_pagination: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã", show_alert=True)

@router.callback_query(F.data == "history")
async def history_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å–∫–ª–∞–¥–æ–≤."""
    user_id = callback.from_user.id
    
    try:
        history = await db.get_history(user_id, limit=5, offset=0)
        total_count = await db.get_total_history_count(user_id)
        total_pages = (total_count + 4) // 5  # –ü–æ 5 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        
        if not history:
            keyboard = InlineKeyboardBuilder()
            keyboard.button(text="üîô –í –ø—Ä–æ—Ñ–∏–ª—å", callback_data="profile_submenu")
            keyboard.adjust(1)
            
            await callback.message.edit_text(
                "üìú <b>–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å–∫–ª–∞–¥–æ–≤</b> üåô\n\n"
                "–¢–≤–æ–∏ —Ä–∞—Å–∫–ª–∞–¥—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.\n\n"
                "üí° <b>–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é:</b>\n"
                "‚Ä¢ –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä—ã–º –æ—Ç–≤–µ—Ç–∞–º\n"
                "‚Ä¢ –í–∏–¥–∏—à—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è\n"
                "‚Ä¢ –ó–∞–º–µ—á–∞–µ—à—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã\n"
                "‚Ä¢ –°–æ–∑–¥–∞—ë—à—å –ª–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ —á—É–≤—Å—Ç–≤\n\n"
                "<i>–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ ‚Äî –∏ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–≤–æ—è –ø–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å! üí´</i>",
                reply_markup=keyboard.as_markup(),
                parse_mode='HTML'
            )
            await safe_answer(callback)
            return
        
        history_text = "üìú <b>–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤</b> üåô\n\n"
        
        for i, record in enumerate(history, 1):
            question = record.get('question', '–ë–µ–∑ –≤–æ–ø—Ä–æ—Å–∞')
            if len(question) > 50:
                question = question[:50] + "..."
            
            cards = record.get('cards', '')
            if len(cards) > 30:
                cards = cards[:30] + "..."
            
            date = format_datetime(record.get('timestamp', ''))
            
            history_text += (
                f"{i}. <b>#{record['id']}</b>\n"
                f"‚ùì {question}\n"
                f"üÉè {cards}\n"
                f"üìÖ {date}\n"
                f"{'üíé –ü—Ä–µ–º–∏—É–º' if record.get('is_premium') else 'üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}\n\n"
            )
        
        history_text += f"<i>–í—Å–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤: {total_count}</i>"
        
        if total_pages > 1:
            history_text += f"\n<i>–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ {total_pages}</i>"
        
        await callback.message.edit_text(
            history_text,
            reply_markup=history_pagination_keyboard(0, total_pages),
            parse_mode='HTML'
        )
        await safe_answer(callback)
        
    except Exception as e:
        logger.error(f"Error in history handler: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏", show_alert=True)

@router.callback_query(F.data.startswith("history_"))
async def history_pagination_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å–∫–ª–∞–¥–æ–≤."""
    user_id = callback.from_user.id
    
    try:
        data = callback.data
        
        if data.startswith("history_prev_"):
            page = int(data.replace("history_prev_", ""))
            new_page = max(0, page - 1)
        elif data.startswith("history_next_"):
            page = int(data.replace("history_next_", ""))
            total_count = await db.get_total_history_count(user_id)
            total_pages = (total_count + 4) // 5
            new_page = min(total_pages - 1, page + 1)
        else:
            new_page = 0
        
        offset = new_page * 5
        history = await db.get_history(user_id, limit=5, offset=offset)
        total_count = await db.get_total_history_count(user_id)
        total_pages = (total_count + 4) // 5
        
        if not history:
            await safe_answer(callback, "‚ö†Ô∏è –ë–æ–ª—å—à–µ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π")
            return
        
        history_text = "üìú <b>–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤</b> üåô\n\n"
        
        for i, record in enumerate(history, 1):
            question = record.get('question', '–ë–µ–∑ –≤–æ–ø—Ä–æ—Å–∞')
            if len(question) > 50:
                question = question[:50] + "..."
            
            cards = record.get('cards', '')
            if len(cards) > 30:
                cards = cards[:30] + "..."
            
            date = format_datetime(record.get('timestamp', ''))
            
            history_text += (
                f"{offset + i}. <b>#{record['id']}</b>\n"
                f"‚ùì {question}\n"
                f"üÉè {cards}\n"
                f"üìÖ {date}\n"
                f"{'üíé –ü—Ä–µ–º–∏—É–º' if record.get('is_premium') else 'üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}\n\n"
            )
        
        history_text += f"<i>–í—Å–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤: {total_count}</i>"
        
        if total_pages > 1:
            history_text += f"\n<i>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {new_page + 1} –∏–∑ {total_pages}</i>"
        
        await callback.message.edit_text(
            history_text,
            reply_markup=history_pagination_keyboard(new_page, total_pages),
            parse_mode='HTML'
        )
        await safe_answer(callback)
        
    except Exception as e:
        logger.error(f"Error in history pagination: {e}", exc_info=True)
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã", show_alert=True)

@router.callback_query(F.data == "support_submenu")
async def support_submenu_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏."""
    await callback.message.edit_text(
        f"‚≠êü§ù <b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –ø–æ–º–æ—â—å</b>\n\n"
        
        f"üåô <b>–ú—ã –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å!</b>\n"
        f"–í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:\n\n"
        
        f"üíå <b>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</b>\n"
        f"<i>–ü–æ–¥–µ–ª–∏—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏, –ø—Ä–µ–¥–ª–æ–∂–∏ —É–ª—É—á—à–µ–Ω–∏—è</i>\n\n"
        
        f"üìö <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</b>\n"
        f"<i>–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —Å–æ–≤–µ—Ç—ã, –ø—Ä–∏–º–µ—Ä—ã</i>\n\n"
        
        f"‚öñÔ∏è <b>–ü—Ä–∞–≤–∏–ª–∞ –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</b>\n"
        f"<i>–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –≤–∞—à–∏ –ø—Ä–∞–≤–∞</i>\n\n"
        
        f"‚ùì <b>–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)</b>\n"
        f"<i>–û—Ç–≤–µ—Ç—ã –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</i>\n\n"
        
        f"üõ†Ô∏è <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å</b>\n"
        f"<i>–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</i>\n\n"
        
        f"üíé <b>–í–æ–ø—Ä–æ—Å—ã –æ–± –æ–ø–ª–∞—Ç–µ</b>\n"
        f"<i>–ü–ª–∞—Ç–µ–∂–∏, –≤–æ–∑–≤—Ä–∞—Ç—ã, –ø—Ä–æ–±–ª–µ–º—ã</i>\n\n"
        
        f"üåü <b>–ù–∞—à–∞ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è:</b>\n"
        f"<i>–ú—ã –≤–µ—Ä–∏–º, —á—Ç–æ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –≤–∞–∂–µ–Ω, "
        f"–∫–∞–∂–¥–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–∞–µ–º–∞, –∞ –∫–∞–∂–¥–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å "
        f"–¥–µ–ª–∞–µ—Ç –Ω–∞—à–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –ª—É—á—à–µ. –ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –æ–±—Ä–∞—â–∞—Ç—å—Å—è! ‚ù§Ô∏è</i>",
        reply_markup=support_submenu_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "feedback")
async def feedback_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞."""
    await callback.message.edit_text(
        f"üíåüåü <b>–¢–≤–æ–π –æ—Ç–∑—ã–≤ –±–µ—Å—Ü–µ–Ω–µ–Ω!</b>\n\n"
        
        f"üéØ <b>–ü–æ—á–µ–º—É —Ç–≤–æ—ë –º–Ω–µ–Ω–∏–µ –≤–∞–∂–Ω–æ:</b>\n"
        f"‚Ä¢ üìà –ü–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º —Ä–∞—Å—Ç–∏ –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è\n"
        f"‚Ä¢ üîß –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å\n"
        f"‚Ä¢ ‚ù§Ô∏è –í–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –Ω–∞ –Ω–æ–≤—ã–µ –∏–¥–µ–∏\n"
        f"‚Ä¢ üåü –î–µ–ª–∞–µ—Ç –±–æ—Ç–∞ –ª—É—á—à–µ –¥–ª—è –≤—Å–µ—Ö\n\n"
        
        f"üí° <b>–û —á—ë–º –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å:</b>\n"
        f"‚Ä¢ –ß—Ç–æ —Ç–µ–±–µ –æ—Å–æ–±–µ–Ω–Ω–æ –Ω—Ä–∞–≤–∏—Ç—Å—è –≤ –±–æ—Ç–µ?\n"
        f"‚Ä¢ –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å?\n"
        f"‚Ä¢ –ë—ã–ª–∏ –ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã?\n"
        f"‚Ä¢ –ö–∞–∫–æ–π –æ–ø—ã—Ç —Ç—ã –ø–æ–ª—É—á–∏–ª(–∞) –æ—Ç —Ä–∞—Å–∫–ª–∞–¥–æ–≤?\n"
        f"‚Ä¢ –ö–∞–∫–∏–µ —ç–º–æ—Ü–∏–∏ –≤—ã–∑—ã–≤–∞—é—Ç –∫–∞—Ä—Ç—ã?\n"
        f"‚Ä¢ –ß—Ç–æ –±—ã —Ç—ã –ø–æ–∂–µ–ª–∞–ª(–∞) –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?\n\n"
        
        f"‚ú® <b>–ö–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–∑—ã–≤—ã:</b>\n"
        f"1. üìã –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n"
        f"2. üéØ –í—ã—è–≤–ª—è–µ–º –æ–±—â–∏–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è\n"
        f"3. üîß –ü–ª–∞–Ω–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–∏—è –∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
        f"4. üöÄ –í–Ω–µ–¥—Ä—è–µ–º –ª—É—á—à–∏–µ –∏–¥–µ–∏ –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö\n"
        f"5. üí´ –î–µ–ª–∏–º—Å—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º–∏ –∏—Å—Ç–æ—Ä–∏—è–º–∏\n\n"
        
        f"üìù <b>–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –æ—Ç–∑—ã–≤:</b>\n"
        f"<i>–ë—É–¥—å –∏—Å–∫—Ä–µ–Ω–Ω–∏–º ‚Äî –∫–∞–∂–¥–∞—è –º—ã—Å–ª—å –≤–∞–∂–Ω–∞! "
        f"–ú–æ–∂–µ—à—å –ø–∏—Å–∞—Ç—å —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ —Ö–æ—á–µ—à—å. üåô</i>",
        parse_mode='HTML'
    )
    
    await state.set_state(UserState.awaiting_feedback)
    await safe_answer(callback)

@router.message(StateFilter(UserState.awaiting_feedback))
async def process_feedback(message: Message, state: FSMContext, bot: Bot) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞."""
    user_id = message.from_user.id
    feedback_text = message.text.strip()
    
    if len(feedback_text) < 5:
        await message.answer(
            f"‚ö†Ô∏èüìù <b>–û—Ç–∑—ã–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π</b>\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–Ω—è—Ç—å:\n"
            f"‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –∏–ª–∏ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å?\n"
            f"‚Ä¢ –ö–∞–∫–∏–µ —ç–º–æ—Ü–∏–∏ —Ç—ã –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å?\n"
            f"‚Ä¢ –ß—Ç–æ –±—ã —Ç—ã –∏–∑–º–µ–Ω–∏–ª(–∞)?\n\n"
            f"üí° <b>–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ –æ—Ç–∑—ã–≤–∞:</b>\n"
            f"<i>\"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, –∫–∞–∫ –∫–∞—Ä—Ç—ã –¥–∞—é—Ç –≥–ª—É–±–æ–∫–∏–µ –æ—Ç–≤–µ—Ç—ã. "
            f"–û—Å–æ–±–µ–Ω–Ω–æ —Ü–µ–Ω—é –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã. "
            f"–•–æ—Ç–µ–ª–æ—Å—å –±—ã –≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤.\"</i>\n\n"
            f"<i>–ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞! üåü</i>",
            parse_mode='HTML'
        )
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤
    await db.add_feedback(user_id, feedback_text)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    await send_admin_notification(
        bot,
        f"üåüüíå <b>–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤!</b>\n\n"
        f"üë§ <b>–û—Ç:</b> {message.from_user.full_name}\n"
        f"üì± <b>Username:</b> @{message.from_user.username or '–Ω–µ—Ç'}\n"
        f"üÜî <b>ID:</b> <code>{user_id}</code>\n"
        f"üí¨ <b>–û—Ç–∑—ã–≤:</b>\n{feedback_text[:300]}...\n\n"
        f"‚è∞ <b>–í—Ä–µ–º—è:</b> {datetime.now(timezone(TIMEZONE)).strftime('%H:%M %d.%m.%Y')}\n"
        f"üìè <b>–î–ª–∏–Ω–∞:</b> {len(feedback_text)} —Å–∏–º–≤–æ–ª–æ–≤"
    )
    
    await message.answer(
        f"‚ú®üíå <b>–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–≤–æ–π –æ—Ç–∑—ã–≤!</b>\n\n"
        
        f"üéØ <b>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å —Ç–≤–æ–∏–º –æ—Ç–∑—ã–≤–æ–º:</b>\n"
        f"1. üì• –û–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –Ω–∞—à–µ–π –±–∞–∑–µ –æ—Ç–∑—ã–≤–æ–≤\n"
        f"2. üëÅÔ∏è –ö–æ–º–∞–Ω–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–µ—Ç –µ–≥–æ\n"
        f"3. üí° –ú—ã —É—á—Ç—ë–º —Ç–≤–æ–∏ –º—ã—Å–ª–∏ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏\n"
        f"4. üöÄ –õ—É—á—à–∏–µ –∏–¥–µ–∏ —Å—Ç–∞–Ω—É—Ç —á–∞—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π\n"
        f"5. ‚ù§Ô∏è –¢–≤–æ—ë –º–Ω–µ–Ω–∏–µ –¥–µ–ª–∞–µ—Ç –±–æ—Ç–∞ –ª—É—á—à–µ –¥–ª—è –≤—Å–µ—Ö\n\n"
        
        f"üåü <b>–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –Ω–∞–º:</b>\n"
        f"‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
        f"‚Ä¢ –£–ª—É—á—à–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
        f"‚Ä¢ –î–µ–ª–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–¥–æ–±–Ω–µ–µ\n"
        f"‚Ä¢ –†–∞—Å—Ç–∏ –∫–∞–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ\n\n"
        
        f"üìä <b>–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç:</b>\n"
        f"<i>–ö–∞–∂–¥—ã–π 10-–π –æ—Ç–∑–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ "
        f"–∏–ª–∏ —É–ª—É—á—à–µ–Ω–∏—è. –¢–≤–æ–π –≤–∫–ª–∞–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–µ–Ω! üåô</i>\n\n"
        
        f"üí´ <b>–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–æ, —á—Ç–æ –¥–µ–ª–∏—à—å—Å—è —Å–≤–æ–µ–π –º—É–¥—Ä–æ—Å—Ç—å—é!</b>\n"
        f"<i>–° –ª—é–±–æ–≤—å—é –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é, –∫–æ–º–∞–Ω–¥–∞ –¢–∞—Ä–æ-–±–æ—Ç–∞ ‚ú®</i>",
        reply_markup=await main_menu_keyboard(await db.get_user(user_id)),
        parse_mode='HTML'
    )
    
    await state.clear()

@router.callback_query(F.data == "how_to_use")
async def how_to_use_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é."""
    instructions = (
        f"üìöüåü <b>–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞</b>\n\n"
        
        f"üéØ <b>1. –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥:</b>\n"
        f"‚Ä¢ –ù–∞–∂–º–∏ 'üîÆ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é\n"
        f"‚Ä¢ –í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º 3)\n"
        f"‚Ä¢ –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –∫–∞—Ä—Ç–∞–º\n"
        f"‚Ä¢ –ü–æ–ª—É—á–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç!\n\n"
        
        f"üíé <b>2. –ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å—ã:</b>\n"
        f"‚Ä¢ –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏ –≥–ª—É–±–æ–∫–∏–µ –æ—Ç–≤–µ—Ç—ã\n"
        f"‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n"
        f"‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤\n"
        f"‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π\n\n"
        
        f"ü§ù <b>3. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞:</b>\n"
        f"‚Ä¢ –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –ø–æ —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–µ\n"
        f"‚Ä¢ –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ –ø–æ–ª—É—á–∞–π +1 –∑–∞–ø—Ä–æ—Å\n"
        f"‚Ä¢ –î—Ä—É–∑—å—è —Ç–æ–∂–µ –ø–æ–ª—É—á–∞—é—Ç —Ç—ë–ø–ª—ã–π –ø—Ä–∏—ë–º\n"
        f"‚Ä¢ –°—Ç—Ä–æ–π—Ç–µ —Å–≤–æ—ë —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –º—É–¥—Ä–æ—Å—Ç–∏\n\n"
        
        f"üìú <b>4. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤:</b>\n"
        f"‚Ä¢ –í—Å–µ —Ç–≤–æ–∏ —Ä–∞—Å–∫–ª–∞–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è\n"
        f"‚Ä¢ –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ö –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è\n"
        f"‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π —Å–≤–æ–π –¥—É—Ö–æ–≤–Ω—ã–π –ø—É—Ç—å\n"
        f"‚Ä¢ –ó–∞–º–µ—á–∞–π –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã\n\n"
        
        f"üèÜ <b>5. –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —É—Ä–æ–≤–Ω–∏:</b>\n"
        f"‚Ä¢ –ü–æ–ª—É—á–∞–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å\n"
        f"‚Ä¢ –ü–æ–≤—ã—à–∞–π —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å\n"
        f"‚Ä¢ –û—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n"
        f"‚Ä¢ –ì–æ—Ä–¥–∏—Å—å —Å–≤–æ–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º\n\n"
        
        f"üìö <b>6. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–Ω–∞–Ω–∏–π:</b>\n"
        f"‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n"
        f"‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º\n"
        f"‚Ä¢ –§–∏–ª–æ—Å–æ—Ñ–∏—è –¢–∞—Ä–æ\n"
        f"‚Ä¢ –ò—Å—Ç–æ—Ä–∏–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n"
        
        f"üí° <b>7. –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</b>\n"
        f"‚Ä¢ üéØ –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö\n"
        f"‚Ä¢ ‚ù§Ô∏è –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –æ—Ç —Å–µ—Ä–¥—Ü–∞\n"
        f"‚Ä¢ ‚è≥ –î–∞–π –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π\n"
        f"‚Ä¢ üìù –ó–∞–ø–∏—Å—ã–≤–∞–π –≤–∞–∂–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã\n"
        f"‚Ä¢ üîÑ –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ —Å—Ç–∞—Ä—ã–º —Ä–∞—Å–∫–ª–∞–¥–∞–º\n"
        f"‚Ä¢ üåô –î–æ–≤–µ—Ä—è–π —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏\n\n"
        
        f"üõ°Ô∏è <b>8. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–≤–∏–ª–∞:</b>\n"
        f"‚Ä¢ –ò–∑–±–µ–≥–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –±–æ–ª–µ–∑–Ω—è—Ö –∏ —Å–º–µ—Ä—Ç–∏\n"
        f"‚Ä¢ –ü–æ–º–Ω–∏ –æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ\n"
        f"‚Ä¢ –ù–µ—Å–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è\n"
        f"‚Ä¢ –£–≤–∞–∂–∞–π –∫–∞—Ä—Ç—ã –∏ –∏—Ö –ø–æ—Å–ª–∞–Ω–∏—è\n\n"
        
        f"üåü <b>–ì–ª–∞–≤–Ω—ã–π —Å–µ–∫—Ä–µ—Ç:</b>\n"
        f"<i>–õ—É—á—à–∏–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –∫ —Ç–µ–º, –∫—Ç–æ –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã "
        f"—Å –æ—Ç–∫—Ä—ã—Ç—ã–º —Å–µ—Ä–¥—Ü–µ–º –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å—é —É—Å–ª—ã—à–∞—Ç—å. "
        f"–ö–∞—Ä—Ç—ã ‚Äî —ç—Ç–æ –∑–µ—Ä–∫–∞–ª–æ —Ç–≤–æ–µ–π –¥—É—à–∏. üåô</i>"
    )
    
    await callback.message.edit_text(
        instructions,
        reply_markup=support_submenu_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.message(Command("help"))
async def help_command(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help."""
    help_text = (
        f"üîÆüåü <b>–ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º</b>\n\n"
        
        f"üìã <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        f"‚Ä¢ /start ‚Äî –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
        f"‚Ä¢ /help ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        f"‚Ä¢ /profile ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å\n\n"
        
        f"‚ú® <b>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
        f"‚Ä¢ üîÆ –¢–∞—Ä–æ-—Ä–∞—Å–∫–ª–∞–¥—ã –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n"
        f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥—ã –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π\n"
        f"‚Ä¢ ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –±–æ–Ω—É—Å–∞–º–∏\n"
        f"‚Ä¢ üìú –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ç–≤–æ–∏—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
        f"‚Ä¢ üèÜ –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ —É—Ä–æ–≤–Ω–µ–π\n"
        f"‚Ä¢ üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ —Å–æ–≤–µ—Ç–æ–≤\n"
        f"‚Ä¢ ‚≠ê –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å\n\n"
        
        f"üí° <b>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</b>\n"
        f"1. –ù–∞–ø–∏—à–∏ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n"
        f"2. –ü—Ä–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\n"
        f"3. –ù–∞–∂–º–∏ 'üîÆ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥'\n"
        f"4. –í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç\n"
        f"5. –ó–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å\n"
        f"6. –ü–æ–ª—É—á–∏ –º—É–¥—Ä—ã–π –æ—Ç–≤–µ—Ç!\n\n"
        
        f"üìû <b>–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?</b>\n"
        f"‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—é '‚≠ê –ü–æ–¥–¥–µ—Ä–∂–∫–∞'\n"
        f"‚Ä¢ –ü–∏—à–∏ –æ—Ç–∑—ã–≤—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n"
        f"‚Ä¢ –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å\n\n"
        
        f"üåü <b>–ù–∞—à–∞ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è:</b>\n"
        f"<i>–ú—ã —Å–æ–∑–¥–∞–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –∏—â–µ—Ç –º—É–¥—Ä–æ—Å—Ç—å, "
        f"—Ö–æ—á–µ—Ç –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–µ–±—è –∏ –æ–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä. "
        f"–ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –≤–∞–∂–µ–Ω, –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç ‚Äî —à–∞–≥ –∫ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏. üåô</i>\n\n"
        
        f"<i>–î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é! –û–Ω–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Å–∫–∞–∂—É—Ç, "
        f"–∫—É–¥–∞ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ. üí´</i>"
    )
    
    await message.answer(help_text, parse_mode='HTML')

@router.message(Command("profile"))
async def profile_command(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /profile."""
    user_id = message.from_user.id
    user_data = await db.get_user(user_id)
    
    if not user_data:
        await message.answer(
            f"‚ö†Ô∏è <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</b>\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏ —Å /start",
            parse_mode='HTML'
        )
        return
    
    ref_stats = await db.get_referral_stats(user_id)
    user_level = await get_user_level(user_id)
    achievements = await get_user_achievements(user_id)
    
    profile_text = (
        f"üë§üåü <b>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>\n\n"
        
        f"üÜî <b>ID:</b> <code>{user_id}</code>\n"
        f"üëÅÔ∏è‚Äçüó®Ô∏è <b>–ò–º—è:</b> {message.from_user.first_name or '–ê–Ω–æ–Ω–∏–º'}\n\n"
        
        f"üéØ <b>–£—Ä–æ–≤–µ–Ω—å:</b> {user_level}\n"
    )
    
    if achievements:
        profile_text += f"üèÜ <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {', '.join(achievements[:3])}\n\n"
    
    profile_text += (
        f"üîÆ <b>–¢–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã:</b>\n"
        f"‚Ä¢ üÜì <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö:</b> {user_data['requests_left']}\n"
        f"‚Ä¢ üíé <b>–ü—Ä–µ–º–∏—É–º:</b> {user_data['premium_requests']}\n\n"
        
        f"ü§ù <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞:</b>\n"
        f"‚Ä¢ üë• <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ:</b> {ref_stats['referrals_count']}\n"
        f"‚Ä¢ üéÅ <b>–ë–æ–Ω—É—Å–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ:</b> {ref_stats['total_bonuses']}\n\n"
        
        f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
        f"‚Ä¢ üîÆ –í—Å–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤: {await db.get_total_history_count(user_id)}\n"
        f"‚Ä¢ üìÖ –° –Ω–∞–º–∏ —Å: {format_datetime(user_data.get('created_at'))}\n\n"
        
        f"üí° <b>–°–æ–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç:</b>\n"
        f"<i>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è —Å –∫–∞—Ä—Ç–∞–º–∏ –ø–æ–º–æ–≥–∞—é—Ç –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —Å–µ–±—è "
        f"–∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –≥–∞—Ä–º–æ–Ω–∏—é –≤ –∂–∏–∑–Ω–∏. –ù–µ –∑–∞–±—ã–≤–∞–π –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–≤–æ–∏–º "
        f"—Å—Ç–∞—Ä—ã–º —Ä–∞—Å–∫–ª–∞–¥–∞–º ‚Äî –æ–Ω–∏ –º–æ–≥—É—Ç –æ—Ç–∫—Ä—ã—Ç—å—Å—è —Å –Ω–æ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã! üåô</i>\n\n"
        
        f"<i>–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º! üí´</i>"
    )
    
    await message.answer(
        profile_text,
        reply_markup=profile_submenu_keyboard(),
        parse_mode='HTML'
    )

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è FAQ
@router.callback_query(F.data == "faq")
async def faq_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ FAQ."""
    faq_text = (
        f"‚ùìüåü <b>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)</b>\n\n"
        
        f"üîÆ <b>1. –ö–∞–∫ —á–∞—Å—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥—ã?</b>\n"
        f"‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤\n"
        f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å—ã: –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏\n"
        f"‚Ä¢ ü§ù –ë–æ–Ω—É—Å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: –∑–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π\n\n"
        
        f"üíé <b>2. –ß–µ–º –ø—Ä–µ–º–∏—É–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ?</b>\n"
        f"‚Ä¢ üîç –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–≤ 2 —Ä–∞–∑–∞ –¥–ª–∏–Ω–Ω–µ–µ)\n"
        f"‚Ä¢ üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n"
        f"‚Ä¢ ‚è±Ô∏è –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞\n"
        f"‚Ä¢ üìö –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏\n\n"
        
        f"ü§ù <b>3. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞?</b>\n"
        f"‚Ä¢ üì§ –î–µ–ª–∏—à—å—Å—è —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–≥–æ–º\n"
        f"‚Ä¢ üéØ –î—Ä—É–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∏ –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥\n"
        f"‚Ä¢ üéâ –¢—ã –ø–æ–ª—É—á–∞–µ—à—å +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å\n"
        f"‚Ä¢ üí´ –î—Ä—É–≥ —Ç–æ–∂–µ —á—É–≤—Å—Ç–≤—É–µ—Ç –Ω–∞—à—É –∑–∞–±–æ—Ç—É\n\n"
        
        f"üí≥ <b>4. –ö–∞–∫ –∫—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å—ã?</b>\n"
        f"‚Ä¢ –í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç –≤ –º–µ–Ω—é –ø–æ–∫—É–ø–∫–∏\n"
        f"‚Ä¢ –û–ø–ª–∞—Ç–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É\n"
        f"‚Ä¢ –û—Ç–ø—Ä–∞–≤—å —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞\n"
        f"‚Ä¢ –ñ–¥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–æ 1 —á–∞—Å–∞)\n\n"
        
        f"üìú <b>5. –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–∏ –º–æ–∏ —Ä–∞—Å–∫–ª–∞–¥—ã?</b>\n"
        f"‚Ä¢ ‚úÖ –î–∞, –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è\n"
        f"‚Ä¢ üîí –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ç–µ–±–µ\n"
        f"‚Ä¢ üìä –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è\n"
        f"‚Ä¢ üíæ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏\n\n"
        
        f"‚öñÔ∏è <b>6. –ü–æ—á–µ–º—É –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã?</b>\n"
        f"‚Ä¢ ‚ù§Ô∏è –ú—ã –∑–∞–±–æ—Ç–∏–º—Å—è –æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –∫–æ–º—Ñ–æ—Ä—Ç–µ\n"
        f"‚Ä¢ ‚öïÔ∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–º—ã —Ç—Ä–µ–±—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤\n"
        f"‚Ä¢ üåü –§–æ–∫—É—Å –Ω–∞ —Ä–æ—Å—Ç–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–∏\n"
        f"‚Ä¢ üé≠ –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –±–æ—Ç–∞\n\n"
        
        f"üõ°Ô∏è <b>7. –ë–µ–∑–æ–ø–∞—Å–Ω—ã –ª–∏ –º–æ–∏ –¥–∞–Ω–Ω—ã–µ?</b>\n"
        f"‚Ä¢ üîí –ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º\n"
        f"‚Ä¢ üìä –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞\n"
        f"‚Ä¢ üí≥ –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã\n"
        f"‚Ä¢ üéØ –§–æ–∫—É—Å –Ω–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏ –∏ –∫–æ–º—Ñ–æ—Ä—Ç–µ\n\n"
        
        f"üìû <b>8. –ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π?</b>\n"
        f"‚Ä¢ –ß–µ—Ä–µ–∑ –º–µ–Ω—é '‚≠ê –ü–æ–¥–¥–µ—Ä–∂–∫–∞'\n"
        f"‚Ä¢ –û—Ç–ø—Ä–∞–≤—å –æ—Ç–∑—ã–≤ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å\n"
        f"‚Ä¢ –£–∫–∞–∂–∏ ID –∏ –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã\n"
        f"‚Ä¢ –ú—ã –æ—Ç–≤–µ—Ç–∏–º –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ\n\n"
        
        f"üåü <b>9. –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π?</b>\n"
        f"‚Ä¢ üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å\n"
        f"‚Ä¢ üìà –£—Ä–æ–≤–Ω–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
        f"‚Ä¢ üéÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö\n"
        f"‚Ä¢ üí´ –ü—Ä–∏–∑–Ω–∞–Ω–∏–µ —Ç–≤–æ–µ–≥–æ –¥—É—Ö–æ–≤–Ω–æ–≥–æ –ø—É—Ç–∏\n\n"
        
        f"üí° <b>10. –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –ª—É—á—à–∏–µ –æ—Ç–≤–µ—Ç—ã?</b>\n"
        f"‚Ä¢ üéØ –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö\n"
        f"‚Ä¢ ‚ù§Ô∏è –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –æ—Ç —Å–µ—Ä–¥—Ü–∞\n"
        f"‚Ä¢ ‚è≥ –î–∞–π –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è\n"
        f"‚Ä¢ üìù –î–µ–ª–∞–π –∑–∞–º–µ—Ç–∫–∏ –ø–æ—Å–ª–µ —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n\n"
        
        f"<i>–ù–µ –Ω–∞—à–µ–ª –æ—Ç–≤–µ—Ç –Ω–∞ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å? –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî "
        f"–º—ã –≤—Å–µ–≥–¥–∞ —Ä–∞–¥—ã –ø–æ–º–æ—á—å! üåô</i>"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîô –ù–∞–∑–∞–¥", callback_data="support_submenu")
    keyboard.button(text="üíå –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É", callback_data="feedback")
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        faq_text,
        reply_markup=keyboard.as_markup(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–º–æ—â–∏
@router.callback_query(F.data == "tech_help")
async def tech_help_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–º–æ—â–∏."""
    tech_text = (
        f"üõ†Ô∏èüåü <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å</b>\n\n"
        
        f"‚ö†Ô∏è <b>–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n\n"
        
        f"üîß <b>1. –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:</b>\n"
        f"‚Ä¢ üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start\n"
        f"‚Ä¢ üì± –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º\n"
        f"‚Ä¢ ‚è≥ –ü–æ–¥–æ–∂–¥–∏ 5-10 –º–∏–Ω—É—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞\n"
        f"‚Ä¢ üóëÔ∏è –û—á–∏—Å—Ç–∏ –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Telegram\n\n"
        
        f"üì∏ <b>2. –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π:</b>\n"
        f"‚Ä¢ üí≥ –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤\n"
        f"‚Ä¢ üì± –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ—à—ë–ª\n"
        f"‚Ä¢ ‚è∞ –ü–æ–¥–æ–∂–¥–∏ –¥–æ 1 —á–∞—Å–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏\n"
        f"‚Ä¢ üìû –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å ID –ø–ª–∞—Ç–µ–∂–∞\n\n"
        
        f"üîÆ <b>3. –†–∞—Å–∫–ª–∞–¥ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç:</b>\n"
        f"‚Ä¢ ‚è≥ –ò–Ω–æ–≥–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 5 –º–∏–Ω—É—Ç\n"
        f"‚Ä¢ üîÑ –ü–æ–ø—Ä–æ–±—É–π —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥ —Å–Ω–æ–≤–∞\n"
        f"‚Ä¢ üìù –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ –¥–ª–∏–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å\n"
        f"‚Ä¢ üéØ –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤–æ–ø—Ä–æ—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º\n\n"
        
        f"üìä <b>4. –ü—Ä–æ–ø–∞–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏—è:</b>\n"
        f"‚Ä¢ üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start\n"
        f"‚Ä¢ üìã –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ /profile\n"
        f"‚Ä¢ üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n"
        f"‚Ä¢ üìû –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å —Ç–≤–æ–∏–º ID\n\n"
        
        f"ü§ñ <b>5. –î—Ä—É–≥–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</b>\n"
        f"‚Ä¢ üì± –û–±–Ω–æ–≤–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram\n"
        f"‚Ä¢ üîÑ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n"
        f"‚Ä¢ üåê –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n"
        f"‚Ä¢ ‚è∞ –ü–æ–¥–æ–∂–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞\n\n"
        
        f"üìã <b>–ß—Ç–æ —Å–æ–æ–±—â–∏—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É:</b>\n"
        f"1. üÜî –¢–≤–æ–π ID: <code>{callback.from_user.id}</code>\n"
        f"2. üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –û–°\n"
        f"3. ‚è∞ –í—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã\n"
        f"4. üîÑ –ß—Ç–æ —Ç—ã –¥–µ–ª–∞–ª(–∞) –ø–µ—Ä–µ–¥ –ø—Ä–æ–±–ª–µ–º–æ–π\n"
        f"5. üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)\n\n"
        
        f"‚ö° <b>–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å:</b>\n"
        f"‚Ä¢ –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è\n"
        f"‚Ä¢ –ï—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã –¥–µ–Ω—å–≥–∏\n"
        f"‚Ä¢ –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—Ä–æ—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ\n"
        f"‚Ä¢ –ù–∞–ø–∏—à–∏ '–°–†–û–ß–ù–û' –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n\n"
        
        f"üåü <b>–ù–∞—à–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è:</b>\n"
        f"<i>–ú—ã –¥–µ–ª–∞–µ–º –≤—Å—ë –≤–æ–∑–º–æ–∂–Ω–æ–µ, —á—Ç–æ–±—ã –±–æ—Ç —Ä–∞–±–æ—Ç–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω–æ. "
        f"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏ –±—ã–≤–∞—é—Ç —Ä–µ–¥–∫–æ, –Ω–æ –µ—Å–ª–∏ –æ–Ω–∏ —Å–ª—É—á–∞—é—Ç—Å—è ‚Äî "
        f"–º—ã –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –∏—Ö –∏—Å–ø—Ä–∞–≤–ª—è–µ–º. –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ! üí´</i>"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîô –ù–∞–∑–∞–¥", callback_data="support_submenu")
    keyboard.button(text="üíå –ù–∞–ø–∏—Å–∞—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ", callback_data="feedback")
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        tech_text,
        reply_markup=keyboard.as_markup(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "rules")
async def rules_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."""
    rules_text = (
        f"‚öñÔ∏èüåü <b>–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</b>\n\n"
        
        f"üìú <b>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:</b>\n\n"
        
        f"1. üß† <b>–¢–∞—Ä–æ ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π</b>\n"
        f"‚Ä¢ –ö–∞—Ä—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç —É–≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã\n"
        f"‚Ä¢ –≠—Ç–æ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –±—É–¥—É—â–µ–≥–æ\n"
        f"‚Ä¢ –§–æ–∫—É—Å –Ω–∞ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏–∏ –∏ —Ä–æ—Å—Ç–µ\n"
        f"‚Ä¢ –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä\n\n"
        
        f"2. ‚ù§Ô∏è <b>–£–≤–∞–∂–µ–Ω–∏–µ –∏ –∑–∞–±–æ—Ç–∞</b>\n"
        f"‚Ä¢ –£–≤–∞–∂–∞–π –∫–∞—Ä—Ç—ã –∏ –∏—Ö –ø–æ—Å–ª–∞–Ω–∏—è\n"
        f"‚Ä¢ –ë—É–¥—å –≤–µ–∂–ª–∏–≤ –≤ –æ–±—â–µ–Ω–∏–∏\n"
        f"‚Ä¢ –ü–æ–º–Ω–∏ –æ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö\n"
        f"‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É\n\n"
        
        f"3. ‚öïÔ∏è <b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ</b>\n"
        f"‚Ä¢ –ò–∑–±–µ–≥–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –±–æ–ª–µ–∑–Ω—è—Ö\n"
        f"‚Ä¢ –ù–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ —Å–º–µ—Ä—Ç–∏ –∏ –Ω–∞—Å–∏–ª–∏–∏\n"
        f"‚Ä¢ –û–±—Ä–∞—â–∞–π—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n"
        f"‚Ä¢ –ó–∞–±–æ—Ç—å—Å—è –æ —Å–≤–æ—ë–º –ø—Å–∏—Ö–∏—á–µ—Å–∫–æ–º –∑–¥–æ—Ä–æ–≤—å–µ\n\n"
        
        f"4. ü§ù <b>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</b>\n"
        f"‚Ä¢ –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –∑–∞ —Å–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è\n"
        f"‚Ä¢ –ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã\n"
        f"‚Ä¢ –í—ã–±–æ—Ä –≤—Å–µ–≥–¥–∞ –∑–∞ —Ç–æ–±–æ–π\n"
        f"‚Ä¢ –î–æ–≤–µ—Ä—è–π —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏\n\n"
        
        f"5. üîí <b>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</b>\n"
        f"‚Ä¢ –ú—ã —Ö—Ä–∞–Ω–∏–º —Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n"
        f"‚Ä¢ –ù–µ –ø–µ—Ä–µ–¥–∞—ë–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º\n"
        f"‚Ä¢ –£–≤–∞–∂–∞–µ–º —Ç–≤–æ—é –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å\n"
        f"‚Ä¢ –ú–æ–∂–µ—à—å —É–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ –∑–∞–ø—Ä–æ—Å—É\n\n"
        
        f"6. üí≥ <b>–ü–ª–∞—Ç–µ–∂–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç—ã</b>\n"
        f"‚Ä¢ –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ\n"
        f"‚Ä¢ –í–æ–∑–≤—Ä–∞—Ç—ã –ø—Ä–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö\n"
        f"‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤ —Å–æ–≥–ª–∞—à–µ–Ω–∏–∏\n"
        f"‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º\n\n"
        
        f"7. üö´ <b>–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</b>\n"
        f"‚Ä¢ –ù–∞—Ä—É—à–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞\n"
        f"‚Ä¢ –û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –∞–≥—Ä–µ—Å—Å–∏—è\n"
        f"‚Ä¢ –°–ø–∞–º –∏ –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç—å\n"
        f"‚Ä¢ –ü–æ–ø—ã—Ç–∫–∏ –≤–∑–ª–æ–º–∞ –∏–ª–∏ –æ–±–º–∞–Ω–∞\n\n"
        
        f"üìÑ <b>–ü–æ–ª–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ:</b>\n"
        f"<a href='https://telegra.ph/Polzovatelskoe-soglashenie-12-09-32'>üìñ –û—Ç–∫—Ä—ã—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>\n\n"
        
        f"üåü <b>–ù–∞—à–∞ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è:</b>\n"
        f"<i>–ú—ã —Å–æ–∑–¥–∞–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º—É–¥—Ä–æ—Å—Ç–∏, "
        f"—Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–æ—Å—Ç–∞. –ö–∞–∂–¥–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–æ–¥–∏–∫—Ç–æ–≤–∞–Ω–æ "
        f"–∑–∞–±–æ—Ç–æ–π –æ —Ç–µ–±–µ –∏ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ. –°–æ–±–ª—é–¥–∞—è –∏—Ö, —Ç—ã –ø–æ–º–æ–≥–∞–µ—à—å "
        f"—Å–æ–∑–¥–∞–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â—É—é —Å—Ä–µ–¥—É –¥–ª—è –≤—Å–µ—Ö. üåô</i>\n\n"
        
        f"üí° <b>–í–∞–∂–Ω–æ:</b>\n"
        f"<i>–ò—Å–ø–æ–ª—å–∑—É—è –±–æ—Ç–∞, —Ç—ã —Å–æ–≥–ª–∞—à–∞–µ—à—å—Å—è —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏. "
        f"–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ!</i>"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîô –ù–∞–∑–∞–¥", callback_data="support_submenu")
    keyboard.button(text="üìñ –û—Ç–∫—Ä—ã—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", url="https://telegra.ph/Polzovatelskoe-soglashenie-12-09-32")
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        rules_text,
        reply_markup=keyboard.as_markup(),
        parse_mode='HTML',
        disable_web_page_preview=True
    )
    await safe_answer(callback)


@router.callback_query(F.data == "payment_help")
async def payment_help_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–º–æ—â–∏ —Å –æ–ø–ª–∞—Ç–æ–π."""
    payment_help_text = (
        f"üíéüåü <b>–ü–æ–º–æ—â—å —Å –æ–ø–ª–∞—Ç–æ–π</b>\n\n"
        
        f"üí∞ <b>–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ–± –æ–ø–ª–∞—Ç–µ:</b>\n\n"
        
        f"1. üí≥ <b>–ö–∞–∫ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É?</b>\n"
        f"‚Ä¢ –í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç –≤ –º–µ–Ω—é –ø–æ–∫—É–ø–∫–∏\n"
        f"‚Ä¢ –ü–µ—Ä–µ–≤–µ–¥–∏ —Å—É–º–º—É –Ω–∞ –∫–∞—Ä—Ç—É: <code>{CARD_NUMBER}</code>\n"
        f"‚Ä¢ –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏ ID: <code>{callback.from_user.id}</code>\n"
        f"‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ —á–µ–∫\n"
        f"‚Ä¢ –û—Ç–ø—Ä–∞–≤—å —Å–∫—Ä–∏–Ω—à–æ—Ç –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º\n\n"
        
        f"2. ‚è∞ <b>–°–∫–æ–ª—å–∫–æ –∂–¥–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è?</b>\n"
        f"‚Ä¢ –û–±—ã—á–Ω–æ –¥–æ 1 —á–∞—Å–∞ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è\n"
        f"‚Ä¢ –í –≤—ã—Ö–æ–¥–Ω—ã–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª—å—à–µ\n"
        f"‚Ä¢ –ù–æ—á—å—é –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è\n"
        f"‚Ä¢ –ú—ã –≤—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–µ–º—Å—è –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ\n\n"
        
        f"3. üîÑ <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è?</b>\n"
        f"‚Ä¢ –ü–æ–¥–æ–∂–¥–∏ –µ—â—ë 1-2 —á–∞—Å–∞\n"
        f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —É–∫–∞–∑–∞–Ω ID –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏\n"
        f"‚Ä¢ –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ—à—ë–ª\n"
        f"‚Ä¢ –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å –¥–µ—Ç–∞–ª—è–º–∏\n\n"
        
        f"4. üö´ <b>–ú–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏?</b>\n"
        f"‚Ä¢ –î–∞, –ø—Ä–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö\n"
        f"‚Ä¢ –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –±—ã–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã\n"
        f"‚Ä¢ –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å –Ω–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã\n"
        f"‚Ä¢ –ü–æ –∑–∞–ø—Ä–æ—Å—É –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n\n"
        
        f"5. üìä <b>–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞?</b>\n"
        f"‚Ä¢ –ß–µ—Ä–µ–∑ –∏—Å—Ç–æ—Ä–∏—é –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏\n"
        f"‚Ä¢ –û–∂–∏–¥–∞–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞\n"
        f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ\n"
        f"‚Ä¢ –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è\n\n"
        
        f"6. üõ°Ô∏è <b>–ë–µ–∑–æ–ø–∞—Å–Ω–∞ –ª–∏ –æ–ø–ª–∞—Ç–∞?</b>\n"
        f"‚Ä¢ ‚úÖ –î–∞, —Ç–æ–ª—å–∫–æ –ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É\n"
        f"‚Ä¢ üîí –ù–∏–∫–∞–∫–∏—Ö —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º\n"
        f"‚Ä¢ üìù –í—Å—è –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è\n"
        f"‚Ä¢ üëÅÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π –ø–ª–∞—Ç—ë–∂\n\n"
        
        f"7. üéÅ <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã?</b>\n"
        f"‚Ä¢ –ñ–¥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏\n"
        f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ\n"
        f"‚Ä¢ –ù–∞—á–Ω–∏ –¥–µ–ª–∞—Ç—å –ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥—ã\n"
        f"‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏ ID –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ –±—É–¥—É—â–µ–µ\n\n"
        
        f"üìã <b>–î–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ –æ–ø–ª–∞—Ç–µ:</b>\n"
        f"1. üÜî –¢–≤–æ–π ID: <code>{callback.from_user.id}</code>\n"
        f"2. üí≥ –°—É–º–º–∞ –∏ –≤—Ä–µ–º—è –ø–ª–∞—Ç–µ–∂–∞\n"
        f"3. üè¶ –ë–∞–Ω–∫-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å\n"
        f"4. üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞\n"
        f"5. üî¢ –ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)\n\n"
        
        f"üåü <b>–ù–∞—à–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è:</b>\n"
        f"<i>–ú—ã —Ü–µ–Ω–∏–º –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–µ–ª–∞–µ–º –≤—Å—ë –≤–æ–∑–º–æ–∂–Ω–æ–µ "
        f"–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π. "
        f"–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –º—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–º–æ–∂–µ–º –∏—Ö —Ä–µ—à–∏—Ç—å. "
        f"–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ! üí´</i>"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîô –ù–∞–∑–∞–¥", callback_data="support_submenu")
    keyboard.button(text="üí≥ –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º", callback_data="buy_premium")
    keyboard.button(text="üíå –ù–∞–ø–∏—Å–∞—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ", callback_data="feedback")
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        payment_help_text,
        reply_markup=keyboard.as_markup(),
        parse_mode='HTML'
    )
    await safe_answer(callback)        

# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ handlers.py –ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö

@router.callback_query(F.data == "my_feedback")
async def my_feedback_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∏—Ö –æ—Ç–∑—ã–≤–æ–≤."""
    user_id = callback.from_user.id
    feedback_list = await db.get_user_feedback(user_id)
    
    if not feedback_list:
        await callback.message.edit_text(
            "üí≠ <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</b>\n\n"
            "–í—ã –µ—â—ë –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤—ã –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞.\n\n"
            "üí° <b>–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤:</b>\n"
            "‚Ä¢ –ü–æ–º–æ–≥–∞–µ—Ç–µ –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ\n"
            "‚Ä¢ –ü–æ–ª—É—á–∞–µ—Ç–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ '–ö—Ä–∏—Ç–∏–∫'\n"
            "‚Ä¢ –î–∞—ë—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\n\n"
            "<i>–ö–∞–∂–¥—ã–π –æ—Ç–∑—ã–≤ –≤–∞–∂–µ–Ω –¥–ª—è –Ω–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞! üåü</i>",
            reply_markup=feedback_keyboard(),
            parse_mode='HTML'
        )
    else:
        feedback_text = "üìù <b>–í–∞—à–∏ –æ—Ç–∑—ã–≤—ã</b>\n\n"
        
        for i, feedback in enumerate(feedback_list[:5], 1):
            feedback_date = format_datetime(feedback.get('timestamp'))
            feedback_content = feedback.get('feedback', '')
            if len(feedback_content) > 100:
                feedback_content = feedback_content[:100] + "..."
            
            rating = feedback.get('rating', 5)
            stars = "‚≠ê" * rating
            
            feedback_text += (
                f"{i}. <b>–û—Ç–∑—ã–≤ #{feedback['id']}</b>\n"
                f"{stars}\n"
                f"üìÖ {feedback_date}\n"
                f"üí¨ {feedback_content}\n\n"
            )
        
        feedback_text += f"<i>–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: {len(feedback_list)}</i>"
        
        await callback.message.edit_text(
            feedback_text,
            reply_markup=feedback_keyboard(),
            parse_mode='HTML'
        )
    
    await safe_answer(callback)

@router.callback_query(F.data == "user_stats")
async def user_stats_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id = callback.from_user.id
    user_data = await db.get_user_with_stats(user_id)
    
    if not user_data:
        await safe_answer(callback, "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = await db.get_user_statistics(user_id)
    level_info = await db.get_user_level_info(user_id)
    achievements = await db.get_user_achievements(user_id)
    
    stats_text = (
        f"üìä <b>–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>\n\n"
        
        f"üéØ <b>–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n"
        f"‚Ä¢ üîÆ –†–∞—Å–∫–ª–∞–¥–æ–≤ —Å–¥–µ–ª–∞–Ω–æ: {stats.get('total_readings', 0)}\n"
        f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥–æ–≤: {level_info.get('premium_readings', 0)}\n"
        f"‚Ä¢ üÉè –ö–∞—Ä—Ç –≤—ã—Ç—è–Ω—É—Ç–æ: {stats.get('total_cards', 0)}\n"
        f"‚Ä¢ üìù –°–ª–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {stats.get('total_words', 0)}\n\n"
        
        f"üåü <b>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</b>\n"
        f"‚Ä¢ üìÖ –î–Ω–µ–π —Å —Ä–∞—Å–∫–ª–∞–¥–∞–º–∏: {stats.get('reading_days_active', 0)}\n"
        f"‚Ä¢ üî• –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π: {stats.get('last_7_days_active', 0)}\n"
        f"‚Ä¢ ‚ö° –¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: {stats.get('streak_days', 0)} –¥–Ω–µ–π\n"
        f"‚Ä¢ üìö –¢–∏–ø–æ–≤ —Ä–∞—Å–∫–ª–∞–¥–æ–≤: {stats.get('reading_types_count', 0)}\n\n"
        
        f"üèÜ <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b>\n"
        f"‚Ä¢ üéØ –£—Ä–æ–≤–µ–Ω—å: {level_info.get('level', 1)}\n"
        f"‚Ä¢ ‚ú® –û–ø—ã—Ç: {level_info.get('experience', 0)}\n"
        f"‚Ä¢ üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {len(achievements)}\n"
        f"‚Ä¢ ü§ù –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: {user_data.get('referrals_count', 0)}\n\n"
        
        f"üìà <b>–°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</b>\n"
        f"‚Ä¢ üÉè –ö–∞—Ä—Ç –Ω–∞ —Ä–∞—Å–∫–ª–∞–¥: {stats.get('avg_cards_per_reading', 0):.1f}\n"
        f"‚Ä¢ üìù –°–ª–æ–≤ –Ω–∞ —Ä–∞—Å–∫–ª–∞–¥: {stats.get('avg_words_per_reading', 0):.1f}\n"
        f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥–æ–≤: {stats.get('premium_percentage', 0):.1f}%\n\n"
    )
    
    if stats.get('favorite_reading_type'):
        stats_text += f"‚ù§Ô∏è <b>–õ—é–±–∏–º—ã–π —Ç–∏–ø:</b> {stats['favorite_reading_type']}\n\n"
    
    stats_text += (
        f"üîí <b>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</b>\n"
        f"<i>–í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ø—Ä–∏–≤–∞—Ç–Ω–æ. "
        f"–ú—ã –Ω–µ –∏–º–µ–µ–º –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –≤–∞—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤. "
        f"–¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å–∫–ª–∞–¥–æ–≤. üåô</i>\n\n"
        
        f"<i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞.</i>"
    )
    
    await callback.message.edit_text(
        stats_text,
        reply_markup=user_stats_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "referral_list")
async def referral_list_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö."""
    user_id = callback.from_user.id
    referrals = await db.get_referrals(user_id)
    
    if not referrals:
        await callback.message.edit_text(
            "üë• <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π</b>\n\n"
            "–í—ã –µ—â—ë –Ω–∏–∫–æ–≥–æ –Ω–µ –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ –≤ –º–∏—Ä –¢–∞—Ä–æ.\n\n"
            "üí° <b>–ö–∞–∫ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π:</b>\n"
            "1. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π\n"
            "2. –î—Ä—É–≥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ\n"
            "3. –û–Ω –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥\n"
            "4. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å!\n\n"
            "ü§ù <b>–ü–ª—é—Å—ã –¥–ª—è –¥—Ä—É–≥–∞:</b>\n"
            "‚Ä¢ –¢—ë–ø–ª—ã–π –ø—Ä–∏—ë–º –æ—Ç –∫–∞—Ä—Ç\n"
            "‚Ä¢ 3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ\n"
            "‚Ä¢ 1 –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å –≤ –ø–æ–¥–∞—Ä–æ–∫\n"
            "‚Ä¢ –í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Å–æ–≤–µ—Ç—ã\n\n"
            "<i>–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ —Ä–∞—Å—Ç–∏—Ç–µ –≤–º–µ—Å—Ç–µ! üåü</i>",
            reply_markup=referral_keyboard(get_referral_link(user_id)),
            parse_mode='HTML'
        )
    else:
        referrals_text = f"üë• <b>–í–∞—à–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ –¥—Ä—É–∑—å—è</b> ({len(referrals)})\n\n"
        
        for i, ref in enumerate(referrals, 1):
            username = ref.get('username', '–ë–µ–∑ username')
            first_name = ref.get('first_name', '–î—Ä—É–≥')
            join_date = format_datetime(ref.get('created_at'))
            readings_count = ref.get('readings_count', 0)
            last_reading = format_datetime(ref.get('last_reading'))
            
            status = "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω" if readings_count > 0 else "‚è≥ –û–∂–∏–¥–∞–µ—Ç"
            
            referrals_text += (
                f"{i}. <b>{first_name}</b> (@{username})\n"
                f"   üìÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: {join_date}\n"
                f"   üîÆ –†–∞—Å–∫–ª–∞–¥–æ–≤: {readings_count}\n"
                f"   üìç –°—Ç–∞—Ç—É—Å: {status}\n"
            )
            
            if readings_count > 0:
                referrals_text += f"   ‚è∞ –ü–æ—Å–ª–µ–¥–Ω–∏–π: {last_reading}\n"
            
            referrals_text += "\n"
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
        ref_stats = await db.get_referral_stats(user_id)
        referrals_text += (
            f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:</b>\n"
            f"‚Ä¢ üë• –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: {ref_stats['referrals_count']}\n"
            f"‚Ä¢ ‚≠ê –ê–∫—Ç–∏–≤–Ω—ã—Ö: {ref_stats['active_referrals']}\n"
            f"‚Ä¢ üíé –° –ø—Ä–µ–º–∏—É–º–æ–º: {ref_stats['premium_referrals']}\n"
            f"‚Ä¢ üîÆ –í—Å–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤: {ref_stats['total_referral_readings']}\n"
            f"‚Ä¢ üéÅ –ü–æ–ª—É—á–µ–Ω–æ –±–æ–Ω—É—Å–æ–≤: {ref_stats['total_bonuses']}\n\n"
            
            f"<i>–ö–∞–∂–¥—ã–π –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–π –¥—Ä—É–≥ –¥–µ–ª–∞–µ—Ç –Ω–∞—à–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ —Å–∏–ª—å–Ω–µ–µ! ‚ù§Ô∏è</i>"
        )
        
        await callback.message.edit_text(
            referrals_text,
            reply_markup=referral_keyboard(get_referral_link(user_id)),
            parse_mode='HTML'
        )
    
    await safe_answer(callback)

@router.callback_query(F.data == "examples_relationships")
async def examples_relationships_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö."""
    await callback.message.edit_text(
        "üíñ <b>–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö</b>\n\n"
        
        "üéØ <b>–•–æ—Ä–æ—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã:</b>\n"
        "1. –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –Ω–∞—à–µ –≤–∑–∞–∏–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–µ?\n"
        "2. –ß—Ç–æ —è –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?\n"
        "3. –ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –Ω–∞—à–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π?\n"
        "4. –ö–∞–∫ –º–Ω–µ –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —á—É–≤—Å—Ç–≤–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞?\n"
        "5. –ö–∞–∫–∏–µ —É—Ä–æ–∫–∏ —è –∏–∑–≤–ª–µ–∫–∞—é –∏–∑ —ç—Ç–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π?\n\n"
        
        "üí° <b>–ß—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å:</b>\n"
        "‚Ä¢ –û –≤–∑–∞–∏–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–∏ –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏\n"
        "‚Ä¢ –û –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ –±–∞–ª–∞–Ω—Å–µ\n"
        "‚Ä¢ –û –ª–∏—á–Ω–æ–º —Ä–æ—Å—Ç–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö\n"
        "‚Ä¢ –û —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –º–µ—á—Ç–∞—Ö\n"
        "‚Ä¢ –û–± —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏\n\n"
        
        "‚ùå <b>–ß—Ç–æ –∏–∑–±–µ–≥–∞—Ç—å:</b>\n"
        "‚Ä¢ '–û–Ω(–∞) –º–µ–Ω—è –ª—é–±–∏—Ç?' (—Å–ª–∏—à–∫–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ —è –≤—Å—Ç—Ä–µ—á—É –ª—é–±–æ–≤—å?' (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç)\n"
        "‚Ä¢ '–ß—Ç–æ –¥—É–º–∞–µ—Ç –æ–±–æ –º–Ω–µ X?' (–ø—Ä–æ –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞)\n"
        "‚Ä¢ '–°—Ç–æ–∏—Ç –ª–∏ –º–Ω–µ —Ä–∞—Å—Å—Ç–∞—Ç—å—Å—è?' (—Ä–µ—à–µ–Ω–∏–µ –∑–∞ –≤–∞—Å)\n\n"
        
        "‚ú® <b>–°–æ–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç:</b>\n"
        "<i>–õ—É—á—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö ‚Äî —Ç–µ, —á—Ç–æ —Ñ–æ–∫—É—Å–∏—Ä—É—é—Ç—Å—è –Ω–∞ –≤–∞—Å –∏ –≤–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö, "
        "–∞ –Ω–µ –Ω–∞ –¥—Ä—É–≥–æ–º —á–µ–ª–æ–≤–µ–∫–µ. –ö–∞—Ä—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç —É–≤–∏–¥–µ—Ç—å –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—É—Ç—å –∫ –≥–∞—Ä–º–æ–Ω–∏–∏. üí´</i>",
        reply_markup=examples_category_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

# –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏–º–µ—Ä–æ–≤:
@router.callback_query(F.data == "examples_career")
async def examples_career_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –∫–∞—Ä—å–µ—Ä–µ."""
    await callback.message.edit_text(
        "üíº <b>–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –∫–∞—Ä—å–µ—Ä–µ</b>\n\n"
        
        "üéØ <b>–•–æ—Ä–æ—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã:</b>\n"
        "1. –ö–∞–∫—É—é –∫–∞—Ä—å–µ—Ä–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã–±—Ä–∞—Ç—å?\n"
        "2. –ß—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ –¥–æ—Å—Ç–∏—á—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π?\n"
        "3. –ù–∞ –∫–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ?\n"
        "4. –ö–∞–∫ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Ç–µ–∫—É—â–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –Ω–∞ —Ä–∞–±–æ—Ç–µ?\n"
        "5. –í –∫–∞–∫–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è?\n\n"
        
        "üí° <b>–ß—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å:</b>\n"
        "‚Ä¢ –û –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ä–æ—Å—Ç–µ\n"
        "‚Ä¢ –û –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö —Ä–∞–∑–≤–∏—Ç–∏—è\n"
        "‚Ä¢ –û –±–∞–ª–∞–Ω—Å–µ —Ä–∞–±–æ—Ç—ã –∏ –∂–∏–∑–Ω–∏\n"
        "‚Ä¢ –û —Ç–≤–æ—Ä—á–µ—Å–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏\n"
        "‚Ä¢ –û —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞—Ö\n\n"
        
        "‚ùå <b>–ß—Ç–æ –∏–∑–±–µ–≥–∞—Ç—å:</b>\n"
        "‚Ä¢ '–ü–æ–ª—É—á—É –ª–∏ —è –ø–æ–≤—ã—à–µ–Ω–∏–µ?' (–¥–∞/–Ω–µ—Ç –≤–æ–ø—Ä–æ—Å)\n"
        "‚Ä¢ '–°–∫–æ–ª—å–∫–æ —è –±—É–¥—É –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å?' (—Å–ª–∏—à–∫–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)\n"
        "‚Ä¢ '–£–≤–æ–ª—é—Ç –ª–∏ –º–µ–Ω—è?' (—Ñ–æ–∫—É—Å –Ω–∞ —Å—Ç—Ä–∞—Ö–µ)\n"
        "‚Ä¢ '–°—Ç–æ–∏—Ç –ª–∏ –º–µ–Ω—è—Ç—å —Ä–∞–±–æ—Ç—É?' (—Ä–µ—à–µ–Ω–∏–µ –∑–∞ –≤–∞—Å)\n\n"
        
        "‚ú® <b>–°–æ–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç:</b>\n"
        "<i>–ö–∞—Ä—Ç—ã –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –≤–∞—à–µ–º —Ä–æ—Å—Ç–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–∏, "
        "–∞ –Ω–µ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è–º–∏. –û–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –≤—ã–±–æ—Ä –∑–∞ –≤–∞–º–∏. üí´</i>",
        reply_markup=examples_category_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "examples_personal")
async def examples_personal_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –ª–∏—á–Ω–æ–º —Ä–æ—Å—Ç–µ."""
    await callback.message.edit_text(
        "üå± <b>–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –ª–∏—á–Ω–æ–º —Ä–æ—Å—Ç–µ</b>\n\n"
        
        "üéØ <b>–•–æ—Ä–æ—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã:</b>\n"
        "1. –ö–∞–∫ —Å—Ç–∞—Ç—å –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è?\n"
        "2. –ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è?\n"
        "3. –ö–∞–∫–∏–µ —Å–∫—Ä—ã—Ç—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã —É –º–µ–Ω—è –µ—Å—Ç—å?\n"
        "4. –ö–∞–∫ –Ω–∞–π—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≥–∞—Ä–º–æ–Ω–∏—é?\n"
        "5. –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –º–Ω–µ —Ä–∞—Å—Ç–∏ –∫–∞–∫ –ª–∏—á–Ω–æ—Å—Ç–∏?\n\n"
        
        "üí° <b>–ß—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å:</b>\n"
        "‚Ä¢ –û —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–∏\n"
        "‚Ä¢ –û –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≥–∞—Ä–º–æ–Ω–∏–∏\n"
        "‚Ä¢ –û —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω–∞—Ö –∏ —Ç–∞–ª–∞–Ω—Ç–∞—Ö\n"
        "‚Ä¢ –û –¥—É—Ö–æ–≤–Ω–æ–º —Ä–æ—Å—Ç–µ\n"
        "‚Ä¢ –û –∂–∏–∑–Ω–µ–Ω–Ω–æ–º –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏\n\n"
        
        "‚ùå <b>–ß—Ç–æ –∏–∑–±–µ–≥–∞—Ç—å:</b>\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ —è —Ä–∞–∑–±–æ–≥–∞—Ç–µ—é?' (–º–∞—Ç–µ—Ä–∏–∞–ª–∏—Å—Ç–∏—á–Ω–æ)\n"
        "‚Ä¢ '–°—Ç–∞–Ω–Ω—É –ª–∏ —è –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–º?' (—ç–≥–æ—Ü–µ–Ω—Ç—Ä–∏—á–Ω–æ)\n"
        "‚Ä¢ '–ü–æ—á–µ–º—É —è –Ω–µ—É–¥–∞—á–Ω–∏–∫?' (–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ–∫—É—Å)\n"
        "‚Ä¢ '–ß—Ç–æ —Å–æ –º–Ω–æ–π –Ω–µ —Ç–∞–∫?' (—Å–∞–º–æ—É–Ω–∏—á–∏–∂–µ–Ω–∏–µ)\n\n"
        
        "‚ú® <b>–°–æ–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç:</b>\n"
        "<i>–õ—É—á—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ ‚Äî —Ç–µ, —á—Ç–æ –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–µ–±—è "
        "–∏ —Å–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∞ –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏. üí´</i>",
        reply_markup=examples_category_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "how_to_formulate")
async def how_to_formulate_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–µ –≤–æ–ø—Ä–æ—Å–æ–≤."""
    await callback.message.edit_text(
        "üìù <b>–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã</b>\n\n"
        
        "üéØ <b>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:</b>\n"
        "1. <b>–§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Å–µ–±–µ</b> ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –æ —Å–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö –∏ —á—É–≤—Å—Ç–≤–∞—Ö\n"
        "2. <b>–ë—É–¥—å—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã</b> ‚Äî –∏–∑–±–µ–≥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å–æ–≤ '–¥–∞/–Ω–µ—Ç'\n"
        "3. <b>–ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã</b> ‚Äî –Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n"
        "4. <b>–§–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ</b> ‚Äî —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ, –∞ –Ω–µ —á–µ–≥–æ –±–æ–∏—Ç–µ—Å—å\n\n"
        
        "‚úÖ <b>–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:</b>\n"
        "<i>'–ö–∞–∫ –º–Ω–µ —É–ª—É—á—à–∏—Ç—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º?'</i>\n\n"
        
        "‚ùå <b>–ü—Ä–∏–º–µ—Ä –ø–ª–æ—Ö–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:</b>\n"
        "<i>'–ü–æ—á–µ–º—É –º—ã –≤—Å–µ–≥–¥–∞ —Å—Å–æ—Ä–∏–º—Å—è?'</i>\n\n"
        
        "üí° <b>–¢–µ—Ö–Ω–∏–∫–∞ '–ö–∞–∫...':</b>\n"
        "‚Ä¢ '–ö–∞–∫ –º–Ω–µ...' –≤–º–µ—Å—Ç–æ '–ü–æ—á–µ–º—É —è...'\n"
        "‚Ä¢ '–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å...' –≤–º–µ—Å—Ç–æ '–ß—Ç–æ –Ω–µ —Ç–∞–∫...'\n"
        "‚Ä¢ '–ö–∞–∫ –Ω–∞–π—Ç–∏...' –≤–º–µ—Å—Ç–æ '–ì–¥–µ –≤–∑—è—Ç—å...'\n\n"
        
        "üåü <b>–ú–µ—Ç–æ–¥ —É—Ç–æ—á–Ω–µ–Ω–∏—è:</b>\n"
        "1. –ó–∞–¥–∞–π—Ç–µ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å\n"
        "2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–∞—Ä—Ç—ã\n"
        "3. –ó–∞–¥–∞–π—Ç–µ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å\n"
        "4. –ü–æ–ª—É—á–∏—Ç–µ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\n\n"
        
        "üîÆ <b>–°–æ–≤–µ—Ç –æ—Ç –õ—É–Ω—ã:</b>\n"
        "<i>–ö–∞—Ä—Ç—ã ‚Äî —ç—Ç–æ –∑–µ—Ä–∫–∞–ª–æ –≤–∞—à–µ–π –¥—É—à–∏. –ß–µ–º –ª—É—á—à–µ –≤—ã —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç–µ –≤–æ–ø—Ä–æ—Å, "
        "—Ç–µ–º —è—Å–Ω–µ–µ –±—É–¥–µ—Ç –æ—Ç–≤–µ—Ç. –ù–µ –±–æ–π—Ç–µ—Å—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, "
        "—É—Ç–æ—á–Ω—è—è –∏ —É–≥–ª—É–±–ª—è—è –∏—Ö. –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî —à–∞–≥ –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é —Å–µ–±—è. üåô</i>",
        reply_markup=examples_category_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data.in_(["achievements_progress", "stats_progress"]))
async def achievements_progress_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π."""
    user_id = callback.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    progress = await db.get_achievement_progress(user_id)
    achievements = await db.get_user_achievements(user_id)
    
    progress_text = "üìà <b>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</b>\n\n"
    
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    categories = {
        "readings": ("üîÆ –†–∞—Å–∫–ª–∞–¥—ã", "—Ä–∞—Å–∫–ª–∞–¥–æ–≤"),
        "premium": ("üíé –ü—Ä–µ–º–∏—É–º", "–ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥–æ–≤"),
        "referrals": ("ü§ù –†–µ—Ñ–µ—Ä–∞–ª—ã", "—Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤"),
        "reading_types": ("üìö –¢–∏–ø—ã —Ä–∞—Å–∫–ª–∞–¥–æ–≤", "—Ç–∏–ø–æ–≤"),
        "streak": ("üî• –°—Ç—Ä–∏–∫", "–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥"),
        "active_days": ("üìÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–Ω–∏", "–¥–Ω–µ–π")
    }
    
    for key, (name, unit) in categories.items():
        if key in progress:
            cat = progress[key]
            current = cat["current"]
            next_target = cat["next"]
            percentage = cat["progress"]
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            bars = 10
            filled = int(percentage / 10)
            progress_bar = "‚ñà" * filled + "‚ñë" * (bars - filled)
            
            progress_text += (
                f"{name}\n"
                f"{progress_bar} {percentage:.0f}%\n"
                f"{current} / {next_target} {unit}\n\n"
            )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    progress_text += "üéØ <b>–ë–ª–∏–∂–∞–π—à–∏–µ —Ü–µ–ª–∏:</b>\n"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –±–ª–∏–∂–µ –≤—Å–µ–≥–æ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é
    nearest = []
    for key, (name, unit) in categories.items():
        if key in progress:
            cat = progress[key]
            if cat["current"] < cat["next"]:
                needed = cat["next"] - cat["current"]
                nearest.append((needed, f"{name}: {needed} {unit}"))
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ç–æ–º—É, —á—Ç–æ –±–ª–∏–∂–µ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é
    nearest.sort()
    for _, goal in nearest[:3]:
        progress_text += f"‚Ä¢ {goal}\n"
    
    progress_text += f"\nüèÜ <b>–ü–æ–ª—É—á–µ–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:</b> {len(achievements)}\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    progress_text += (
        "üéÅ <b>–ù–∞–≥—Ä–∞–¥—ã –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n"
        "‚Ä¢ üÜì +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞ –∫–∞–∂–¥—ã–µ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
        "‚Ä¢ üíé +1 –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å –∑–∞ –∫–∞–∂–¥—ã–µ 10 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
        "‚Ä¢ ‚≠ê –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ\n"
        "‚Ä¢ üåô –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –õ—É–Ω—ã\n\n"
        
        "<i>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –±–æ–Ω—É—Å—ã! ‚ú®</i>"
    )
    
    await callback.message.edit_text(
        progress_text,
        reply_markup=achievements_progress_keyboard(),
        parse_mode='HTML'
    )
    await safe_answer(callback)

@router.callback_query(F.data == "my_achievements")
async def my_achievements_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π."""
    user_id = callback.from_user.id
    achievements = await db.get_user_achievements(user_id)
    
    if not achievements:
        await callback.message.edit_text(
            "üèÜ <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</b>\n\n"
            "–ù–æ –Ω–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ—Å—å! –ö–∞–∂–¥–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ ‚Äî —ç—Ç–æ —à–∞–≥ –≤ –≤–∞—à–µ–º –ø—É—Ç–∏.\n\n"
            "üí° <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n"
            "1. üîÆ –î–µ–ª–∞–π—Ç–µ —Ä–∞—Å–∫–ª–∞–¥—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ\n"
            "2. üíé –ü—Ä–æ–±—É–π—Ç–µ –ø—Ä–µ–º–∏—É–º-—Ñ–æ—Ä–º–∞—Ç\n"
            "3. ü§ù –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π\n"
            "4. üìö –ò—Å—Å–ª–µ–¥—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
            "5. üìù –û—Å—Ç–∞–≤–ª—è–π—Ç–µ –æ—Ç–∑—ã–≤—ã\n\n"
            "üéÅ <b>–ù–∞–≥—Ä–∞–¥—ã –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n"
            "‚Ä¢ +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞ –∫–∞–∂–¥—ã–µ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
            "‚Ä¢ +1 –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å –∑–∞ –∫–∞–∂–¥—ã–µ 10 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
            "‚Ä¢ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ\n\n"
            "<i>–ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ –ø–µ—Ä–≤—ã–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º —É–∂–µ —Å–µ–≥–æ–¥–Ω—è! üåü</i>",
            reply_markup=achievements_keyboard(),
            parse_mode='HTML'
        )
    else:
        achievements_text = f"üèÜ <b>–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b> ({len(achievements)})\n\n"
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        categories = {
            "üå± –ù–∞—á–∞–ª–æ": [],
            "üîÆ –ü—Ä–∞–∫—Ç–∏–∫–∞": [],
            "üíé –ü—Ä–µ–º–∏—É–º": [],
            "ü§ù –°–æ–æ–±—â–µ—Å—Ç–≤–æ": [],
            "‚≠ê –û—Å–æ–±—ã–µ": []
        }
        
        for achievement in achievements:
            name = achievement["achievement_name"]
            emoji = achievement.get("achievement_emoji", "‚≠ê")
            description = achievement.get("description", "")
            date = format_datetime(achievement.get("unlocked_at"))
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            if "–ù–æ–≤–∏—á–æ–∫" in name or "–ò—Å–∫–∞—Ç–µ–ª—å" in name:
                categories["üå± –ù–∞—á–∞–ª–æ"].append((name, emoji, description, date))
            elif "–ú—É–¥—Ä–µ—Ü" in name or "–ú–∞—Å—Ç–µ—Ä" in name or "—Ä–∞—Å–∫–ª–∞–¥" in description:
                categories["üîÆ –ü—Ä–∞–∫—Ç–∏–∫–∞"].append((name, emoji, description, date))
            elif "üíé" in emoji or "–ø—Ä–µ–º–∏—É–º" in description.lower():
                categories["üíé –ü—Ä–µ–º–∏—É–º"].append((name, emoji, description, date))
            elif "–ù–∞—Å—Ç–∞–≤–Ω–∏–∫" in name or "—Ä–µ—Ñ–µ—Ä–∞–ª" in description.lower():
                categories["ü§ù –°–æ–æ–±—â–µ—Å—Ç–≤–æ"].append((name, emoji, description, date))
            else:
                categories["‚≠ê –û—Å–æ–±—ã–µ"].append((name, emoji, description, date))
        
        # –í—ã–≤–æ–¥–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        for category, items in categories.items():
            if items:
                achievements_text += f"{category}:\n"
                for name, emoji, description, date in items[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ 3 –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                    achievements_text += f"  {emoji} <b>{name}</b>\n"
                    achievements_text += f"  <i>{description}</i>\n"
                    achievements_text += f"  üìÖ {date}\n\n"
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–≥—Ä–∞–¥–∞—Ö
        total_achievements = len(achievements)
        free_bonuses = total_achievements // 5  # +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞ –∫–∞–∂–¥—ã–µ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        premium_bonuses = total_achievements // 10  # +1 –ø—Ä–µ–º–∏—É–º –∑–∞ –∫–∞–∂–¥—ã–µ 10
        
        achievements_text += (
            f"üéÅ <b>–í–∞—à–∏ –±–æ–Ω—É—Å—ã:</b>\n"
            f"‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: +{free_bonuses}\n"
            f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–æ–≤: +{premium_bonuses}\n\n"
            
            f"üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b>\n"
            f"‚Ä¢ –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: {5 - (total_achievements % 5)} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
            f"‚Ä¢ –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–∞: {10 - (total_achievements % 10)} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n\n"
            
            f"<i>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã! ‚ú®</i>"
        )
        
        # –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –º–Ω–æ–≥–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ
        if total_achievements > 15:
            achievements_text = f"üèÜ <b>–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b> ({total_achievements})\n\n"
            achievements_text += "<i>–£ –≤–∞—Å —Ç–∞–∫ –º–Ω–æ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, —á—Ç–æ –º—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10!</i>\n\n"
            
            for i, achievement in enumerate(achievements[:10], 1):
                name = achievement["achievement_name"]
                emoji = achievement.get("achievement_emoji", "‚≠ê")
                date = format_datetime(achievement.get("unlocked_at"))
                
                achievements_text += f"{i}. {emoji} <b>{name}</b> - {date}\n"
            
            achievements_text += f"\n<i>–ò –µ—â—ë {total_achievements - 10} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π...</i>\n\n"
            achievements_text += f"üéÅ <b>–ë–æ–Ω—É—Å—ã:</b> +{free_bonuses}üÜì +{premium_bonuses}üíé"
        
        await callback.message.edit_text(
            achievements_text,
            reply_markup=achievements_keyboard(),
            parse_mode='HTML'
        )
    
    await safe_answer(callback)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
@router.callback_query(F.data.in_(["stats_general", "stats_activity", "stats_preferences"]))
async def stats_categories_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏."""
    # –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    await user_stats_handler(callback)    

@router.callback_query(F.data == "claim_achievement_bonus")
async def claim_achievement_bonus_handler(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è."""
    user_id = callback.from_user.id
    achievements = await db.get_user_achievements(user_id)
    
    if not achievements:
        await callback.message.edit_text(
            "‚≠ê <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</b>\n\n"
            "–ù–æ —ç—Ç–æ –ª–µ–≥–∫–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å! –ö–∞–∂–¥–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø—Ä–∏–Ω–æ—Å–∏—Ç –≤–∞–º –±–æ–Ω—É—Å—ã.\n\n"
            "üí° <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n"
            "1. üîÆ –°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ '–ò—Å–∫–∞—Ç–µ–ª—å'\n"
            "2. üìù –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ '–ö—Ä–∏—Ç–∏–∫'\n"
            "3. ü§ù –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ '–ù–∞—Å—Ç–∞–≤–Ω–∏–∫'\n\n"
            "üéÅ <b>–°–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤:</b>\n"
            "‚Ä¢ –ö–∞–∂–¥—ã–µ 5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π = +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å üÜì\n"
            "‚Ä¢ –ö–∞–∂–¥—ã–µ 10 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π = +1 –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å üíé\n\n"
            "<i>–ù–∞—á–Ω–∏—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —É–∂–µ —Å–µ–≥–æ–¥–Ω—è! üåü</i>",
            reply_markup=achievements_keyboard(),
            parse_mode='HTML'
        )
        await safe_answer(callback, "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –¥–ª—è –±–æ–Ω—É—Å–æ–≤")
        return
    
    total_achievements = len(achievements)
    
    # –ü–æ–ª—É—á–∞–µ–º –±–æ–Ω—É—Å—ã —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥
    bonuses = await db.claim_achievement_bonus(user_id)
    free_bonuses = bonuses["free"]
    premium_bonuses = bonuses["premium"]
    
    if free_bonuses > 0 or premium_bonuses > 0:
        # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_data = await db.get_user(user_id)
        
        await callback.message.edit_text(
            f"üéâ <b>–ë–æ–Ω—É—Å—ã –ø–æ–ª—É—á–µ–Ω—ã!</b>\n\n"
            
            f"üåü <b>–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {total_achievements}\n\n"
            
            f"üéÅ <b>–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã:</b>\n"
            f"‚Ä¢ üÜì <b>+{free_bonuses} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</b>\n"
            f"‚Ä¢ üíé <b>+{premium_bonuses} –ø—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å–æ–≤</b>\n\n"
            
            f"üìä <b>–í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:</b>\n"
            f"‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö: {user_data['requests_left']}\n"
            f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º: {user_data['premium_requests']}\n\n"
            
            f"üìà <b>–î–æ —Å–ª–µ–¥—É—é—â–∏—Ö –±–æ–Ω—É—Å–æ–≤:</b>\n"
            f"‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å: —á–µ—Ä–µ–∑ {5 - (total_achievements % 5)} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
            f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å: —á–µ—Ä–µ–∑ {10 - (total_achievements % 10)} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n\n"
            
            f"üí° <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:</b>\n"
            f"1. üîÆ –°–¥–µ–ª–∞–π—Ç–µ {5 - (total_achievements % 5)} —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
            f"2. üíé –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–µ–º–∏—É–º-—Ñ–æ—Ä–º–∞—Ç\n"
            f"3. ü§ù –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π\n"
            f"4. üìö –ò—Å—Å–ª–µ–¥—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
            f"5. üìù –û—Å—Ç–∞–≤–ª—è–π—Ç–µ –æ—Ç–∑—ã–≤—ã\n\n"
            
            f"üîí <b>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</b>\n"
            f"<i>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏–≤–∞—Ç–Ω—ã. –ú—ã –Ω–µ –≤–∏–¥–∏–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–∞—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ "
            f"–∏ –æ—Ç–≤–µ—Ç–æ–≤. –¢–æ–ª—å–∫–æ –≤—ã –∏–º–µ–µ—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å–∫–ª–∞–¥–æ–≤. üåô</i>\n\n"
            
            f"<i>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–≤–æ–π –ø—É—Ç—å! –ö–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –≤–∞—Å –∫ —Å–ª–µ–¥—É—é—â–∏–º –±–æ–Ω—É—Å–∞–º. üåü</i>",
            reply_markup=achievements_bonus_keyboard(),
            parse_mode='HTML'
        )
        await safe_answer(callback, f"üéâ –ü–æ–ª—É—á–µ–Ω–æ: +{free_bonuses}üÜì +{premium_bonuses}üíé")
    else:
        await callback.message.edit_text(
            f"‚è≥ <b>–ë–æ–Ω—É—Å—ã –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã</b>\n\n"
            
            f"üåü <b>–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {total_achievements}\n\n"
            
            f"üìä <b>–î–æ –±–æ–Ω—É—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å:</b>\n"
            f"‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {5 - (total_achievements % 5)} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
            f"‚Ä¢ üíé –ü—Ä–µ–º–∏—É–º-–∑–∞–ø—Ä–æ—Å: {10 - (total_achievements % 10)} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n\n"
            
            f"üí° <b>–ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤:</b>\n"
            f"‚Ä¢ –°–¥–µ–ª–∞–π—Ç–µ –µ—â—ë {5 - (total_achievements % 5)} —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n"
            f"‚Ä¢ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ\n"
            f"‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥\n"
            f"‚Ä¢ –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞\n"
            f"‚Ä¢ –ò—Å—Å–ª–µ–¥—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ä–∞—Å–∫–ª–∞–¥–æ–≤\n\n"
            
            f"üîí <b>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</b>\n"
            f"<i>–ú—ã —É–≤–∞–∂–∞–µ–º –≤–∞—à—É –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å. –í—Å–µ –≤–∞—à–∏ —Ä–∞—Å–∫–ª–∞–¥—ã –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤–∞–º. "
            f"–°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –±–µ–∑ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. ‚ú®</i>\n\n"
            
            f"<i>–í—ã –ø–æ—á—Ç–∏ —É —Ü–µ–ª–∏! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! ‚ú®</i>",
            reply_markup=achievements_bonus_keyboard(),
            parse_mode='HTML'
        )
        await safe_answer(callback, f"‚è≥ –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –¥–ª—è –±–æ–Ω—É—Å–æ–≤")    