"""
utils.py
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–æ—Ç–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ —É—Ä–æ–≤–Ω–µ–π.
"""

import re
import logging
import random
import asyncio
import sqlite3
from aiogram import Bot
from aiogram.types import InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from datetime import datetime, timedelta
from pytz import timezone
from typing import Any, List, Dict, Optional, Tuple, Union
from functools import lru_cache
import difflib
import html

from config import (
    ADMIN_ID, MAX_CARDS, TIMEZONE, FREE_REQUEST_INTERVAL,
    BOT_USERNAME, TAROT_READER_NAME, DB_PATH
)
from database import Database

logger = logging.getLogger(__name__)
db = Database()

@lru_cache(maxsize=1)
def get_tarot_cards() -> Dict[str, Dict[str, str]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –≤—Å–µ—Ö 78 –∫–∞—Ä—Ç –¢–∞—Ä–æ.
    """
    major_arcana = {
        "–®—É—Ç": {"title": "–®—É—Ç", "meaning": "–ù–∞—á–∞–ª–æ –ø—É—Ç–∏, –Ω–µ–≤–∏–Ω–Ω–æ—Å—Ç—å, —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ—Å—Ç—å, –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏."},
        "–ú–∞–≥": {"title": "–ú–∞–≥", "meaning": "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, —Å–∏–ª–∞ –≤–æ–ª–∏, –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ."},
        "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞": {"title": "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞", "meaning": "–ò–Ω—Ç—É–∏—Ü–∏—è, —Ç–∞–π–Ω—ã, –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ, –∂–µ–Ω—Å–∫–∞—è –º—É–¥—Ä–æ—Å—Ç—å."},
        "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞": {"title": "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "meaning": "–ü–ª–æ–¥–æ—Ä–æ–¥–∏–µ, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –º–∞—Ç–µ—Ä–∏–Ω—Å—Ç–≤–æ, –∏–∑–æ–±–∏–ª–∏–µ."},
        "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä": {"title": "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "meaning": "–í–ª–∞—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å, –æ—Ç—Ü–æ–≤—Å—Ç–≤–æ, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å."},
        "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç": {"title": "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç", "meaning": "–¢—Ä–∞–¥–∏—Ü–∏–∏, –¥—É—Ö–æ–≤–Ω–æ–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ, –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã, –º—É–¥—Ä–æ—Å—Ç—å."},
        "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ": {"title": "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "meaning": "–í—ã–±–æ—Ä, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ, –≥–∞—Ä–º–æ–Ω–∏—è, –ª—é–±–æ–≤—å, –µ–¥–∏–Ω—Å—Ç–≤–æ."},
        "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞": {"title": "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "meaning": "–ü–æ–±–µ–¥–∞, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, —Ü–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª–µ–Ω–Ω–æ—Å—Ç—å, –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥."},
        "–°–∏–ª–∞": {"title": "–°–∏–ª–∞", "meaning": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–ª–∞, —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, —Å–º–µ–ª–æ—Å—Ç—å, —Ç–µ—Ä–ø–µ–Ω–∏–µ, –º—è–≥–∫–∞—è –≤–ª–∞—Å—Ç—å."},
        "–û—Ç—à–µ–ª—å–Ω–∏–∫": {"title": "–û—Ç—à–µ–ª—å–Ω–∏–∫", "meaning": "–°–∞–º–æ–∞–Ω–∞–ª–∏–∑, —É–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø–æ–∏—Å–∫ –∏—Å—Ç–∏–Ω—ã, –º—É–¥—Ä–æ—Å—Ç—å, –∏–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü–∏—è."},
        "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã": {"title": "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "meaning": "–¶–∏–∫–ª—ã, —Å—É–¥—å–±–∞, —É–¥–∞—á–∞, –ø–µ—Ä–µ–º–µ–Ω—ã, –∫–∞—Ä–º–∞."},
        "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å": {"title": "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", "meaning": "–ë–∞–ª–∞–Ω—Å, –∫–∞—Ä–º–∞, –ø—Ä–∞–≤–¥–∞, –∑–∞–∫–æ–Ω, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å."},
        "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π": {"title": "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "meaning": "–ù–æ–≤–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞, –ø–∞—É–∑–∞, —Å–∞–º–æ–ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ, –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞."},
        "–°–º–µ—Ä—Ç—å": {"title": "–°–º–µ—Ä—Ç—å", "meaning": "–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –æ–∫–æ–Ω—á–∞–Ω–∏–µ, –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥."},
        "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": {"title": "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "meaning": "–†–∞–≤–Ω–æ–≤–µ—Å–∏–µ, —Ç–µ—Ä–ø–µ–Ω–∏–µ, –≥–∞—Ä–º–æ–Ω–∏—è, –∏—Å—Ü–µ–ª–µ–Ω–∏–µ, –±–∞–ª–∞–Ω—Å."},
        "–î—å—è–≤–æ–ª": {"title": "–î—å—è–≤–æ–ª", "meaning": "–ü—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å, –∏—Å–∫—É—à–µ–Ω–∏–µ, –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–º, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, —Ç–µ–Ω–∏."},
        "–ë–∞—à–Ω—è": {"title": "–ë–∞—à–Ω—è", "meaning": "–í–Ω–µ–∑–∞–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã, —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ, –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ, –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ, —à–æ–∫."},
        "–ó–≤–µ–∑–¥–∞": {"title": "–ó–≤–µ–∑–¥–∞", "meaning": "–ù–∞–¥–µ–∂–¥–∞, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, –±–µ–∑–º—è—Ç–µ–∂–Ω–æ—Å—Ç—å, –≤–µ—Ä–∞, –∏—Å—Ü–µ–ª–µ–Ω–∏–µ."},
        "–õ—É–Ω–∞": {"title": "–õ—É–Ω–∞", "meaning": "–ò–ª–ª—é–∑–∏–∏, —Å—Ç—Ä–∞—Ö, –∏–Ω—Ç—É–∏—Ü–∏—è, –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ, —Ç–∞–π–Ω—ã."},
        "–°–æ–ª–Ω—Ü–µ": {"title": "–°–æ–ª–Ω—Ü–µ", "meaning": "–†–∞–¥–æ—Å—Ç—å, —É—Å–ø–µ—Ö, –∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Å–∏–ª–∞, –æ–ø—Ç–∏–º–∏–∑–º, —è—Å–Ω–æ—Å—Ç—å."},
        "–°—É–¥": {"title": "–°—É–¥", "meaning": "–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ, –∏—Å–∫—É–ø–ª–µ–Ω–∏–µ, –ø—Ä–∏–∑—ã–≤, –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è."},
        "–ú–∏—Ä": {"title": "–ú–∏—Ä", "meaning": "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ, –ø–æ–ª–Ω–æ—Ç–∞, –≥–∞—Ä–º–æ–Ω–∏—è, —É—Å–ø–µ—Ö."},
    }
    
    minor_arcana = {
        "–¢—É–∑ –ú–µ—á–µ–π": {"title": "–¢—É–∑ –ú–µ—á–µ–π", "meaning": "–Ø—Å–Ω–æ—Å—Ç—å —É–º–∞, –ø—Ä–æ—Ä—ã–≤, –Ω–æ–≤—ã–µ –∏–¥–µ–∏, –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–±–µ–¥–∞."},
        "–î–≤–æ–π–∫–∞ –ú–µ—á–µ–π": {"title": "–î–≤–æ–π–∫–∞ –ú–µ—á–µ–π", "meaning": "–¢—É–ø–∏–∫, –Ω–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤—ã–±–æ—Ä, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç."},
        "–¢—Ä–æ–π–∫–∞ –ú–µ—á–µ–π": {"title": "–¢—Ä–æ–π–∫–∞ –ú–µ—á–µ–π", "meaning": "–ì–æ—Ä–µ, –ø–µ—á–∞–ª—å, —Ä–∞–∑–ª—É–∫–∞, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –±–æ–ª—å."},
        "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ú–µ—á–µ–π": {"title": "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ú–µ—á–µ–π", "meaning": "–û—Ç–¥—ã—Ö, –º–µ–¥–∏—Ç–∞—Ü–∏—è, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–¥—ã—à–∫–∞."},
        "–ü—è—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π": {"title": "–ü—è—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π", "meaning": "–ö–æ–Ω—Ñ–ª–∏–∫—Ç, –ø–æ—Ä–∞–∂–µ–Ω–∏–µ, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ä–∞–∑–¥–æ—Ä."},
        "–®–µ—Å—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π": {"title": "–®–µ—Å—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π", "meaning": "–ü–µ—Ä–µ—Ö–æ–¥, –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥, –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ, –∏—Å—Ü–µ–ª–µ–Ω–∏–µ."},
        "–°–µ–º–µ—Ä–∫–∞ –ú–µ—á–µ–π": {"title": "–°–µ–º–µ—Ä–∫–∞ –ú–µ—á–µ–π", "meaning": "–•–∏—Ç—Ä–æ—Å—Ç—å, –æ–±–º–∞–Ω, –ø–æ–±–µ–≥, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å."},
        "–í–æ—Å—å–º–µ—Ä–∫–∞ –ú–µ—á–µ–π": {"title": "–í–æ—Å—å–º–µ—Ä–∫–∞ –ú–µ—á–µ–π", "meaning": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, —Å–∞–º–æ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –±–µ—Å–ø–æ–º–æ—â–Ω–æ—Å—Ç—å, –ª–æ–≤—É—à–∫–∞."},
        "–î–µ–≤—è—Ç–∫–∞ –ú–µ—á–µ–π": {"title": "–î–µ–≤—è—Ç–∫–∞ –ú–µ—á–µ–π", "meaning": "–¢—Ä–µ–≤–æ–≥–∞, –∫–æ—à–º–∞—Ä—ã, —Å—Ç—Ä–∞—Ö, –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ."},
        "–î–µ—Å—è—Ç–∫–∞ –ú–µ—á–µ–π": {"title": "–î–µ—Å—è—Ç–∫–∞ –ú–µ—á–µ–π", "meaning": "–ë–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω–µ—Ü, –ø—Ä–æ–≤–∞–ª, –º—É—á–µ–Ω–∏—á–µ—Å—Ç–≤–æ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ."},
        "–ü–∞–∂ –ú–µ—á–µ–π": {"title": "–ü–∞–∂ –ú–µ—á–µ–π", "meaning": "–ù–æ–≤–æ—Å—Ç—å, –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ, –±–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–æ–æ–±—â–µ–Ω–∏–µ."},
        "–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π": {"title": "–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π", "meaning": "–ê–º–±–∏—Ü–∏–æ–∑–Ω–æ—Å—Ç—å, –¥–µ–π—Å—Ç–≤–∏–µ, –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å, —Å–∫–æ—Ä–æ—Å—Ç—å."},
        "–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–µ–π": {"title": "–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–∏–π", "meaning": "–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –º—É–¥—Ä–æ—Å—Ç—å, –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —è—Å–Ω–æ—Å—Ç—å."},
        "–ö–æ—Ä–æ–ª—å –ú–µ—á–µ–π": {"title": "–ö–æ—Ä–æ–ª—å –ú–µ—á–∏–π", "meaning": "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç, –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å."},
        "–¢—É–∑ –ñ–µ–∑–ª–æ–≤": {"title": "–¢—É–∑ –ñ–µ–∑–ª–æ–≤", "meaning": "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç, —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –∏–º–ø—É–ª—å—Å, —ç–Ω—Ç—É–∑–∏–∞–∑–º, –Ω–∞—á–∞–ª–æ."},
        "–î–≤–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–î–≤–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, –≤—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ."},
        "–¢—Ä–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–¢—Ä–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –±—É–¥—É—â–µ–µ, –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –≤–∏–¥–µ–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å."},
        "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ü—Ä–∞–∑–¥–Ω–∏–∫, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –¥–æ–º–∞—à–Ω–∏–π —É—é—Ç, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ."},
        "–ü—è—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–ü—è—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–°–æ–ø–µ—Ä–Ω–∏—á–µ—Å—Ç–≤–æ, –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –≤—ã–∑–æ–≤."},
        "–®–µ—Å—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–®–µ—Å—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ü–æ–±–µ–¥–∞, —É—Å–ø–µ—Ö, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ, —Ç—Ä–∏—É–º—Ñ."},
        "–°–µ–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–°–µ–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ó–∞—â–∏—Ç–∞, —Ö—Ä–∞–±—Ä–æ—Å—Ç—å, –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å—Ç–æ–π–∫–æ—Å—Ç—å."},
        "–í–æ—Å—å–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–í–æ—Å—å–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–°–∫–æ—Ä–æ—Å—Ç—å, –¥–≤–∏–∂–µ–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å, –±—ã—Å—Ç—Ä—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è."},
        "–î–µ–≤—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–î–µ–≤—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å—Ç–æ–π–∫–æ—Å—Ç—å, –∑–∞—â–∏—Ç–∞, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å."},
        "–î–µ—Å—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–î–µ—Å—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ë—Ä–µ–º—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞, –¥–∞–≤–ª–µ–Ω–∏–µ."},
        "–ü–∞–∂ –ñ–µ–∑–ª–æ–≤": {"title": "–ü–∞–∂ –ñ–µ–∑–ª–æ–≤", "meaning": "–≠–Ω—Ç—É–∑–∏–∞–∑–º, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, –Ω–æ–≤—ã–µ –∏–¥–µ–∏, —Å–æ–æ–±—â–µ–Ω–∏–µ."},
        "–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤": {"title": "–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤", "meaning": "–≠–Ω–µ—Ä–≥–∏—è, —Å—Ç—Ä–∞—Å—Ç—å, –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ, –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å."},
        "–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤": {"title": "–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —Ö–∞—Ä–∏–∑–º–∞, –ª–∏–¥–µ—Ä—Å—Ç–≤–æ, –æ–ø—Ç–∏–º–∏–∑–º."},
        "–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤": {"title": "–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤", "meaning": "–õ–∏–¥–µ—Ä—Å—Ç–≤–æ, –ø—Ä–µ–¥–ø—Ä–∏–∏–º—á–∏–≤–æ—Å—Ç—å, –≤–∏–∑–∏—è, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ."},
        "–¢—É–∑ –ö—É–±–∫–æ–≤": {"title": "–¢—É–∑ –ö—É–±–∫–æ–≤", "meaning": "–õ—é–±–æ–≤—å, —ç–º–æ—Ü–∏–∏, –Ω–æ–≤—ã–µ —á—É–≤—Å—Ç–≤–∞, —Ä–∞–¥–æ—Å—Ç—å, –Ω–∞—á–∞–ª–æ."},
        "–î–≤–æ–π–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–î–≤–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ, –≥–∞—Ä–º–æ–Ω–∏—è, —Å–≤—è–∑—å, –≤–∑–∞–∏–º–Ω–æ—Å—Ç—å."},
        "–¢—Ä–æ–π–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–¢—Ä–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–î—Ä—É–∂–±–∞, —Ä–∞–¥–æ—Å—Ç—å, –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ, –æ–±—â–Ω–æ—Å—Ç—å."},
        "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ê–ø–∞—Ç–∏—è, –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞, —Å–∫—É–∫–∞, —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑."},
        "–ü—è—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–ü—è—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ü–æ—Ç–µ—Ä—è, —Å–æ–∂–∞–ª–µ–Ω–∏–µ, —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ, –≥–æ—Ä–µ."},
        "–®–µ—Å—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–®–µ—Å—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ù–æ—Å—Ç–∞–ª—å–≥–∏—è, –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è, –¥–µ—Ç—Å—Ç–≤–æ, –Ω–µ–≤–∏–Ω–Ω–æ—Å—Ç—å."},
        "–°–µ–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–°–µ–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ò–ª–ª—é–∑–∏–∏, –≤—ã–±–æ—Ä, —Ñ–∞–Ω—Ç–∞–∑–∏–∏, –º–µ—á—Ç—ã."},
        "–í–æ—Å—å–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–í–æ—Å—å–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–û—Ç—Ö–æ–¥, –ø–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞, —É—Ö–æ–¥, –¥—É—Ö–æ–≤–Ω—ã–π –ø–æ–∏—Å–∫."},
        "–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ, –∂–µ–ª–∞–Ω–∏–µ, —Å—á–∞—Å—Ç—å–µ, –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ."},
        "–î–µ—Å—è—Ç–∫–∞ –ö—É–±–∫–æ–≤": {"title": "–î–µ—Å—è—Ç–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ì–∞—Ä–º–æ–Ω–∏—è, —Å–µ–º—å—è, —Å—á–∞—Å—Ç—å–µ, –ø–æ–ª–Ω–æ—Ç–∞."},
        "–ü–∞–∂ –ö—É–±–∫–æ–≤": {"title": "–ü–∞–∂ –ö—É–±–∫–æ–≤", "meaning": "–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∏–Ω—Ç—É–∏—Ü–∏—è, –Ω–æ–≤–æ—Å—Ç–∏, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ."},
        "–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤": {"title": "–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤", "meaning": "–†–æ–º–∞–Ω—Ç–∏–∫–∞, –∏–¥–µ–∞–ª–∏–∑–º, –º–µ—á—Ç—ã, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ."},
        "–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤": {"title": "–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤", "meaning": "–≠–º–ø–∞—Ç–∏—è, –∑–∞–±–æ—Ç–∞, –∏–Ω—Ç—É–∏—Ü–∏—è, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç—å."},
        "–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤": {"title": "–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤", "meaning": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, –∫–æ–Ω—Ç—Ä–æ–ª—å —á—É–≤—Å—Ç–≤."},
        "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ü—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –±–æ–≥–∞—Ç—Å—Ç–≤–æ, –Ω–æ–≤—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—Ç–∞—Ä—Ç."},
        "–î–≤–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–î–≤–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ë–∞–ª–∞–Ω—Å, –∞–¥–∞–ø—Ç–∞—Ü–∏—è, –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å, –≥–∏–±–∫–æ—Å—Ç—å."},
        "–¢—Ä–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–¢—Ä–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ, –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, —Ä–∞–±–æ—Ç–∞, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ."},
        "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ö–æ–Ω—Ç—Ä–æ–ª—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –∂–∞–¥–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å."},
        "–ü—è—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–ü—è—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ù—É–∂–¥–∞, –±–µ–¥–Ω–æ—Å—Ç—å, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏."},
        "–®–µ—Å—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–®–µ—Å—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–©–µ–¥—Ä–æ—Å—Ç—å, –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –±–∞–ª–∞–Ω—Å, –ø–æ–º–æ—â—å."},
        "–°–µ–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–°–µ–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–¢–µ—Ä–ø–µ–Ω–∏–µ, —Ä–æ—Å—Ç, –æ–∂–∏–¥–∞–Ω–∏–µ, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏."},
        "–í–æ—Å—å–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–í–æ—Å—å–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, —Ç—Ä—É–¥, –æ–±—É—á–µ–Ω–∏–µ, —Ä–µ–º–µ—Å–ª–æ."},
        "–î–µ–≤—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–î–µ–≤—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–†–æ—Å–∫–æ—à—å, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, —É—Å–ø–µ—Ö, —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å."},
        "–î–µ—Å—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–î–µ—Å—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ù–∞—Å–ª–µ–¥–∏–µ, —Å–µ–º—å—è, –±–æ–≥–∞—Ç—Å—Ç–≤–æ, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å."},
        "–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, —É—á–µ–±–∞, –∞–º–±–∏—Ü–∏–∏, –Ω–æ–≤–æ—Å—Ç–∏ –æ –¥–µ–Ω—å–≥–∞—Ö."},
        "–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å, —É—Å–µ—Ä–¥–∏–µ, –º–µ—Ç–æ–¥–∏—á–Ω–æ—Å—Ç—å, –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å."},
        "–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ó–∞–±–æ—Ç–∞, –ø—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ, –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å, –∏–∑–æ–±–∏–ª–∏–µ."},
        "–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π": {"title": "–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ë–æ–≥–∞—Ç—Å—Ç–≤–æ, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —É—Å–ø–µ—Ö, —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º—É–¥—Ä–æ—Å—Ç—å."},
    }
    
    return {**major_arcana, **minor_arcana}

def get_all_tarot_cards_list() -> List[str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∫–∞—Ä—Ç –¢–∞—Ä–æ.
    
    Returns:
        –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–∞—Ä—Ç.
    """
    return list(get_tarot_cards().keys())

def generate_tarot_cards(num_cards: int) -> List[str]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä –∫–∞—Ä—Ç –¢–∞—Ä–æ.
    """
    all_cards = get_all_tarot_cards_list()
    
    if num_cards > len(all_cards):
        num_cards = len(all_cards)
    
    selected_cards = random.sample(all_cards, num_cards)
    result = []
    
    for card in selected_cards:
        # 30% chance for reversed card
        if random.random() < 0.3:
            result.append(f"{card} (–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)")
        else:
            result.append(card)
    
    logger.info(f"üîÆ Generated {num_cards} tarot cards")
    return result

def parse_custom_cards(cards_input: str) -> Optional[List[str]]:
    """
    –ü–∞—Ä—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –∫–∞—Ä—Ç.
    """
    all_cards = get_all_tarot_cards_list()
    input_cards = [card.strip() for card in cards_input.split(",")]
    
    if len(input_cards) > MAX_CARDS:
        input_cards = input_cards[:MAX_CARDS]
    
    valid_cards = []
    
    for card in input_cards:
        is_reversed = "(–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)" in card.lower() or "–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è" in card.lower()
        
        # –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
        clean_card = card.lower()
        clean_card = clean_card.replace("(–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)", "")
        clean_card = clean_card.replace("–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è", "")
        clean_card = clean_card.strip()
        
        # –ò—â–µ–º –ø–æ—Ö–æ–∂–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        matches = difflib.get_close_matches(clean_card, [c.lower() for c in all_cards], n=1, cutoff=0.7)
        
        if matches:
            matched_card = next(c for c in all_cards if c.lower() == matches[0])
            if is_reversed:
                valid_cards.append(f"{matched_card} (–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)")
            else:
                valid_cards.append(matched_card)
        else:
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (–¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π)
            valid_cards.append(card)
    
    return valid_cards if valid_cards else None

def get_cards_description(cards: List[str]) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç.
    """
    all_cards_data = get_tarot_cards()
    descriptions = []
    
    for card in cards:
        is_reversed = "(–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)" in card
        clean_card_name = card.replace(" (–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)", "").strip()
        
        if clean_card_name in all_cards_data:
            description = all_cards_data[clean_card_name]["meaning"]
            
            if is_reversed:
                # –î–ª—è –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã—Ö –∫–∞—Ä—Ç –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å
                reversed_meanings = {
                    "–®—É—Ç": "–ù–µ–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å, –±–µ–∑—Ä–∞—Å—Å—É–¥—Å—Ç–≤–æ, –∑–∞–¥–µ—Ä–∂–∫–∞",
                    "–ú–∞–≥": "–ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏, –Ω–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–ª–∞–±–∞—è –≤–æ–ª—è",
                    "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞": "–ü–æ–¥–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ç—É–∏—Ü–∏—è, —Å–µ–∫—Ä–µ—Ç—ã, —Å–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã",
                    "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞": "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –ø—É—Å—Ç–æ—Ç–∞, —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –±–ª–æ–∫",
                    "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä": "–¢–∏—Ä–∞–Ω–∏—è, –∂–µ—Å—Ç–∫–æ—Å—Ç—å, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è",
                    "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç": "–î–æ–≥–º–∞—Ç–∏–∑–º, –Ω–µ—Ç–µ—Ä–ø–∏–º–æ—Å—Ç—å, –¥—É—Ö–æ–≤–Ω—ã–π –∫—Ä–∏–∑–∏—Å",
                    "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ": "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –¥–∏—Å–≥–∞—Ä–º–æ–Ω–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç",
                    "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞": "–ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç—Ä–æ–ª—è, –∑–∞—Å—Ç–æ–π, –Ω–µ—É–¥–∞—á–∞",
                    "–°–∏–ª–∞": "–°–ª–∞–±–æ—Å—Ç—å, –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è",
                    "–û—Ç—à–µ–ª—å–Ω–∏–∫": "–û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ, –∏–∑–æ–ª—è—Ü–∏—è, –æ—Ç–∫–∞–∑ –æ—Ç –ø–æ–º–æ—â–∏",
                    "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã": "–ù–µ—É–¥–∞—á–∞, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–∞–º, –∑–∞—Å—Ç–æ–π",
                    "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å": "–ù–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å, –¥–∏—Å–±–∞–ª–∞–Ω—Å, –±–µ–∑–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
                    "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π": "–ë–µ—Å–ø–æ–ª–µ–∑–Ω–∞—è –∂–µ—Ä—Ç–≤–∞, —Ç—É–ø–∏–∫, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ",
                    "–°–º–µ—Ä—Ç—å": "–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–∞–º, –∑–∞—Å—Ç–æ–π, —Å—Ç—Ä–∞—Ö –ø–æ—Ç–µ—Ä—å",
                    "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": "–î–∏—Å–±–∞–ª–∞–Ω—Å, –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ, –∫—Ä–∞–π–Ω–æ—Å—Ç–∏",
                    "–î—å—è–≤–æ–ª": "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ, –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ",
                    "–ë–∞—à–Ω—è": "–ò–∑–±–µ–≥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω, —Å—Ç—Ä–∞—Ö, –∑–∞—Å—Ç–æ–π",
                    "–ó–≤–µ–∑–¥–∞": "–ü–æ—Ç–µ—Ä—è –Ω–∞–¥–µ–∂–¥—ã, –ø–µ—Å—Å–∏–º–∏–∑–º, —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ",
                    "–õ—É–Ω–∞": "–ü—É—Ç–∞–Ω–∏—Ü–∞, –æ–±–º–∞–Ω, –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏",
                    "–°–æ–ª–Ω—Ü–µ": "–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏, –∑–∞–¥–µ—Ä–∂–∫–∞, –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å",
                    "–°—É–¥": "–°–æ–º–Ω–µ–Ω–∏—è, –æ—Ç–∫–∞–∑ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤–∏–Ω–∞",
                    "–ú–∏—Ä": "–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ—Å—Ç—å, –∑–∞–¥–µ—Ä–∂–∫–∏, –Ω–µ–∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–µ –¥–µ–ª–∞",
                }
                
                reversed_desc = reversed_meanings.get(clean_card_name, 
                    "–û–±—Ä–∞—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏")
                
                descriptions.append(f"üÉè {clean_card_name} (–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è): {description} | {reversed_desc}")
            else:
                descriptions.append(f"üÉè {clean_card_name}: {description}")
        else:
            descriptions.append(f"üÉè {card}: –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞")
    
    return "\n".join(descriptions)

async def send_admin_notification(bot: Bot, message: str) -> None:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
    """
    try:
        await bot.send_message(ADMIN_ID, message, parse_mode='HTML')
        logger.info(f"üîÆ Admin notification sent")
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Failed to send admin notification: {e}")

def format_tarot_response(
    answer: str,
    question: str,
    cards: List[str],
    is_premium: bool,
    reader_name: str = TAROT_READER_NAME
) -> List[str]:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.
    –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –º–µ–Ω—å—à–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤.
    """
    import re
    import random
    
    # 1. –£–¥–∞–ª—è–µ–º –≤—Å–µ HTML-—Ç–µ–≥–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ò–ò
    answer = re.sub(r'<[^>]*>', '', answer)
    
    # 2. –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º –∏ –∫–∞—Ä—Ç–∞–º–∏
    messages = []
    
    message1 = f"üîÆ <b>–¢–≤–æ–π —Ä–∞—Å–∫–ª–∞–¥ –≥–æ—Ç–æ–≤, –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥!</b>\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å (–æ–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π)
    short_question = question[:200] + ("..." if len(question) > 200 else "")
    message1 += f"‚ú® <b>–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å:</b>\n<i>{short_question}</i>\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—ã
    message1 += f"üÉè <b>–í—ã–ø–∞–≤—à–∏–µ –∫–∞—Ä—Ç—ã:</b>\n"
    for card in cards:
        message1 += f"‚Ä¢ {card}\n"
    message1 += "\n" + "‚îÅ" * 25 + "\n\n"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    if len(message1) > 4000:
        # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, —É–ø—Ä–æ—â–∞–µ–º
        message1 = f"üîÆ <b>–¢–≤–æ–π —Ä–∞—Å–∫–ª–∞–¥ –≥–æ—Ç–æ–≤!</b>\n\n"
        message1 += f"‚ú® <b>–í–æ–ø—Ä–æ—Å:</b> {question[:100]}...\n\n"
        message1 += f"üÉè <b>–ö–∞—Ä—Ç—ã:</b> {', '.join(cards[:3])}{'...' if len(cards) > 3 else ''}\n\n"
        message1 += "‚îÅ" * 25 + "\n\n"
    
    messages.append(message1)
    
    # 3. –†–∞–∑–±–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —á–∞—Å—Ç–∏
    MAX_PART_LENGTH = 3800  # –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å
    
    if len(answer) <= MAX_PART_LENGTH:
        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å
        messages.append(answer + "\n\n")
    else:
        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ –∞–±–∑–∞—Ü–∞–º
        paragraphs = [p.strip() for p in answer.split('\n\n') if p.strip()]
        
        current_part = ""
        part_num = 1
        total_parts = (len(answer) // MAX_PART_LENGTH) + 1
        
        for para in paragraphs:
            # –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –∞–±–∑–∞—Ü–∞ —Å–¥–µ–ª–∞–µ—Ç —á–∞—Å—Ç—å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–π
            if len(current_part) + len(para) + 10 > MAX_PART_LENGTH and current_part:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç—å
                if total_parts > 1:
                    messages.append(f"üìÑ <b>–ß–∞—Å—Ç—å {part_num}/{total_parts}</b>\n\n{current_part.strip()}\n\n")
                else:
                    messages.append(current_part.strip() + "\n\n")
                
                current_part = para + "\n\n"
                part_num += 1
            else:
                current_part += para + "\n\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å
        if current_part.strip():
            if total_parts > 1 and part_num <= total_parts:
                messages.append(f"üìÑ <b>–ß–∞—Å—Ç—å {part_num}/{total_parts}</b>\n\n{current_part.strip()}\n\n")
            else:
                messages.append(current_part.strip() + "\n\n")
    
    # 4. –°–æ–∑–¥–∞—ë–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    final_message = "‚îÅ" * 25 + "\n\n"
    
    if is_premium:
        final_message += f"üíé <b>–ü—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥</b> ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –ª–∏—á–Ω—ã–º–∏ –∏–Ω—Å–∞–π—Ç–∞–º–∏\n\n"
    else:
        final_message += f"üÜì <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥</b> ‚Äî –±–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏\n\n"
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    word_count = len(answer.split())
    final_message += f"üìä <i>–†–∞—Å–∫–ª–∞–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç {word_count} —Å–ª–æ–≤ –¥–ª—è —Ç–≤–æ–µ–≥–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è</i>\n\n"
    
    # –ü–æ–¥–ø–∏—Å—å
    closing_phrases = [
        f"–° –ª—é–±–æ–≤—å—é –∏ –≤–µ—Ä–æ–π –≤ —Ç–µ–±—è, {reader_name} üåô",
        f"–ü—É—Å—Ç—å –∑–≤—ë–∑–¥—ã –æ—Å–≤–µ—â–∞—é—Ç —Ç–≤–æ–π –ø—É—Ç—å, –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥ üí´",
        f"–ë–µ—Ä–µ–≥–∏ —Å–µ–±—è –∏ —Å–≤–æ—ë —Å–µ—Ä–¥—Ü–µ, {reader_name} üîÆ",
        f"–° —Ç–µ–ø–ª–æ–º –∏ –º—É–¥—Ä–æ—Å—Ç—å—é –∫–∞—Ä—Ç, {reader_name} ‚ú®",
        f"–í–µ—Ä—å –≤ —Å–µ–±—è –∏ —Å–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è, {reader_name} üåü"
    ]
    
    final_message += f"{random.choice(closing_phrases)}\n\n"
    
    # –°–æ–≤–µ—Ç –¥–Ω—è
    advice = get_random_advice()
    final_message += f"üí° <i>–°–æ–≤–µ—Ç –¥–Ω—è: {advice}</i>"
    
    messages.append(final_message)
    
    return messages

def format_datetime(timestamp_str: Optional[str]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É.
    """
    if not timestamp_str:
        return "–ù–µ –±—ã–ª–æ"
    
    try:
        dt = datetime.strptime(timestamp_str, '%Y-%m-%d %H:%M:%S').replace(tzinfo=timezone(TIMEZONE))
        now = datetime.now(timezone(TIMEZONE))
        
        # –°–µ–≥–æ–¥–Ω—è/–≤—á–µ—Ä–∞
        if dt.date() == now.date():
            return f"–°–µ–≥–æ–¥–Ω—è, {dt.strftime('%H:%M')}"
        elif dt.date() == (now - timedelta(days=1)).date():
            return f"–í—á–µ—Ä–∞, {dt.strftime('%H:%M')}"
        else:
            return dt.strftime('%d.%m.%Y %H:%M')
    except:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

def get_random_advice() -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å–æ–≤–µ—Ç.
    """
    advices = [
        "–î–æ–≤–µ—Ä—è–π —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏ ‚Äî –æ–Ω–∞ –∑–Ω–∞–µ—Ç –¥–æ—Ä–æ–≥—É.",
        "–ö–∞–∂–¥—ã–π —à–∞–≥ –≤–µ–¥—ë—Ç –∫—É–¥–∞-—Ç–æ. –ü—Ä–æ—Å—Ç–æ –∏–¥–∏.",
        "–ò–Ω–æ–≥–¥–∞ –ø–∞—É–∑–∞ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –¥–≤–∏–∂–µ–Ω–∏–µ.",
        "–°–ª—É—à–∞–π –Ω–µ —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞, –Ω–æ –∏ —Ç–∏—à–∏–Ω—É –º–µ–∂–¥—É –Ω–∏–º–∏.",
        "–¢–≤–æ—è —Å–∏–ª–∞ –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Ç–æ–≥–æ, —á—Ç–æ –µ—Å—Ç—å.",
        "–ò–Ω–æ–≥–¥–∞ –æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ—Å—Ç–∞—ë—à—å –∏—Å–∫–∞—Ç—å.",
        "–ë—É–¥—å –º—è–≥–∫–∏–º —Å —Å–æ–±–æ–π. –¢—ã –¥–µ–ª–∞–µ—à—å –≤—Å—ë, —á—Ç–æ –º–æ–∂–µ—à—å.",
        "–ù–µ –±–æ–π—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –æ–Ω–∏ –Ω–µ—Å—É—Ç —Ä–æ—Å—Ç.",
        "–ù–∞–π–¥–∏ –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –¥–µ–π—Å—Ç–≤–∏–µ–º –∏ –æ–∂–∏–¥–∞–Ω–∏–µ–º.",
        "–¢–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî —Ç–≤–æ—è —Å—É–ø–µ—Ä—Å–∏–ª–∞."
    ]
    return random.choice(advices)

def get_random_quote() -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Ü–∏—Ç–∞—Ç—É –æ –¢–∞—Ä–æ.
    """
    quotes = [
        "–ö–∞—Ä—Ç—ã ‚Äî –∑–µ—Ä–∫–∞–ª–æ –¥—É—à–∏. –û–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ, —á—Ç–æ —É–∂–µ –∑–Ω–∞–µ—Ç —Å–µ—Ä–¥—Ü–µ.",
        "–¢–∞—Ä–æ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –±—É–¥—É—â–µ–µ ‚Äî –æ–Ω–æ –æ—Å–≤–µ—â–∞–µ—Ç –ø—É—Ç—å.",
        "–ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —ç—Ç–æ –≤–æ–ø—Ä–æ—Å, –∞ –Ω–µ –æ—Ç–≤–µ—Ç. –û—Ç–≤–µ—Ç –≤—Å–µ–≥–¥–∞ –≤ —Ç–µ–±–µ.",
        "–ö–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –Ω–∞ —è–∑—ã–∫–µ —Å–∏–º–≤–æ–ª–æ–≤. –ù–∞—É—á–∏—Å—å —Å–ª—É—à–∞—Ç—å.",
        "–¢–∞—Ä–æ ‚Äî —ç—Ç–æ –¥–∏–∞–ª–æ–≥ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –º—É–¥—Ä–æ—Å—Ç—å—é.",
        "–ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∞ –Ω–µ —Å—É–¥—å–±—É.",
        "–ù–∞—Å—Ç–æ—è—â–∞—è –º–∞–≥–∏—è ‚Äî –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ —Å–µ–±—è.",
        "–ö–∞—Ä—Ç—ã ‚Äî –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∏, –∞ –Ω–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª–∏.",
        "–¢–∞—Ä–æ —É—á–∏—Ç –≤–∏–¥–µ—Ç—å patterns —Ç–∞–º, –≥–¥–µ –¥—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç —Ö–∞–æ—Å.",
        "–ö–∞–∂–¥—ã–π —Ä–∞—Å–∫–ª–∞–¥ ‚Äî —ç—Ç–æ –≤—Å—Ç—Ä–µ—á–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π."
    ]
    return random.choice(quotes)

def get_referral_link(user_id: int) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.
    """
    return f"https://t.me/{BOT_USERNAME.replace('@', '')}?start={user_id}"

async def check_free_request_interval(user_id: int) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –≤—ã–¥–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å.
    """
    user_data = await db.get_user(user_id)
    
    if not user_data:
        return False
    
    last_request_time = user_data.get("last_free_request_time")
    
    if not last_request_time:
        return True
    
    try:
        last_time = datetime.strptime(last_request_time, '%Y-%m-%d %H:%M:%S').replace(tzinfo=timezone(TIMEZONE))
        now = datetime.now(timezone(TIMEZONE))
        
        return (now - last_time).total_seconds() >= FREE_REQUEST_INTERVAL
    except:
        return True

async def add_free_requests_task(bot: Bot) -> None:
    """
    –ó–∞–¥–∞—á–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º.
    """
    logger.info("üîÆ Starting free requests distribution task with notifications")
    
    try:
        users_affected, requests_added = await db.add_free_requests_to_all()
        
        if users_affected > 0:
            logger.info(f"üîÆ Added free requests to {users_affected} users")
            
            # –†–∞—Å—Å—ã–ª–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            users = await db.get_all_users()
            for user in users:
                user_id = user['user_id']
                try:
                    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    user_data = await db.get_user(user_id)
                    if not user_data: continue
                    
                    text = (
                        f"‚ú® –õ—É–Ω–∞ –ø–æ–¥–∞—Ä–∏–ª–∞ —Ç–µ–±–µ 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å! üÜì\n"
                        f"–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è: üÜì {user_data['requests_left']} / üíé {user_data['premium_requests']}\n\n"
                        f"–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ ‚Äî –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.\n"
                        f"–•–æ—á–µ—à—å —Å–∞–º—ã–µ –≥–ª—É–±–æ–∫–∏–µ, —Ç–æ—á–Ω—ã–µ –∏ —Å—Ç—Ä–∞—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã? –ë–µ—Ä–∏ –ø—Ä–µ–º–∏—É–º üíé ‚Äî –æ–Ω–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –≤—Å—ë üî•\n\n"
                        f"üíã –ê –∑–∞ —Å–∞–º—ã–º–∏ –≥–æ—Ä—è—á–∏–º–∏ —Ä–∞—Å–∫–ª–∞–¥–∞–º–∏ 18+ –∑–∞—Ö–æ–¥–∏ –≤ @EroticMoonBot üî•"
                    )
                    builder = InlineKeyboardBuilder()
                    builder.button(text="üíé –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º", callback_data="buy_premium")
                    
                    await bot.send_message(user_id, text, reply_markup=builder.as_markup())
                    await asyncio.sleep(0.05)  # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–ª—É–¥–∞
                except Exception as e:
                    logger.debug(f"Failed to notify user {user_id}: {e}")
                    
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Error in free requests task: {e}")

async def send_promotional_message(bot: Bot) -> None:
    """
    –†–∞—Å—Å—ã–ª–∫–∞ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (—Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤).
    """
    logger.info("üîÆ Starting 12h promotional task")
    
    try:
        active_users = await db.get_active_users(days=7)
        
        if not active_users:
            logger.info("üîÆ No active users found for promotion")
            return
            
        logger.info(f"üîÆ Sending promotion to {len(active_users)} active users")
        
        text = (
            "üåô –•–æ—á–µ—à—å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ –∏ –≥–æ—Ä—è—á–∏–µ —Ä–∞—Å–∫–ª–∞–¥—ã 18+? –ü–µ—Ä–µ—Ö–æ–¥–∏ –≤ @EroticMoonBot üî•\n"
            "–¢–∞–º –∫–∞—Ä—Ç—ã –Ω–µ —Å—Ç–µ—Å–Ω—è—é—Ç—Å—è!\n\n"
            "–ü–æ–ª—É—á–∏ –±–æ–Ω—É—Å –∑–∞ –ø–µ—Ä–µ—Ö–æ–¥! ‚ú®"
        )
        builder = InlineKeyboardBuilder()
        builder.button(text="üíã –ü–µ—Ä–µ–π—Ç–∏ –≤ –≠—Ä–æ—Ç–∏–∫—É", url="https://t.me/EroticMoonBot")
        
        for user in active_users:
            user_id = user['user_id']
            try:
                await bot.send_message(user_id, text, reply_markup=builder.as_markup())
                await asyncio.sleep(0.05)  # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–ª—É–¥–∞
            except Exception as e:
                logger.debug(f"Failed to send promotion to user {user_id}: {e}")
                
        logger.info("üîÆ Promotional campaign completed")
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Error in promotional task: {e}")

def create_welcome_gif() -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –≥–∏—Ñ–∫–∏ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
    –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –≥–∏—Ñ–∫–∏.
    """
    # –ü—Ä–∏–º–µ—Ä ID –≥–∏—Ñ–∫–∏ (–∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π)
    return "CgACAgQAAxkBAAIBAAFl7rPvAAE6JwK2hHwNlqQwAAE8xjxAAgQDAALWMshTAAE5-OhHD9D5LwQ"

def get_user_level(requests_count: int) -> Tuple[str, str]:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ä–∞—Å–∫–ª–∞–¥–æ–≤.
    """
    if requests_count < 5:
        return "üü¢ –ù–æ–≤–∏—á–æ–∫", "–¢—ã —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—à—å –ø—É—Ç—å!"
    elif requests_count < 20:
        return "üü° –ò—Å–∫–∞—Ç–µ–ª—å", "–¢—ã —É–∂–µ –Ω–∞ –ø—É—Ç–∏ –ø–æ–∑–Ω–∞–Ω–∏—è!"
    elif requests_count < 50:
        return "üîµ –ó–Ω–∞—Ç–æ–∫", "–û–ø—ã—Ç–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å –∫–∞—Ä—Ç!"
    elif requests_count < 100:
        return "üü£ –ú–∞—Å—Ç–µ—Ä", "–ù–∞—Å—Ç–æ—è—â–∏–π –∑–Ω–∞—Ç–æ–∫ –¢–∞—Ä–æ!"
    else:
        return "üü§ –ú—É–¥—Ä–µ—Ü", "–ú—É–¥—Ä–æ—Å—Ç—å –∫–∞—Ä—Ç —Ç–µ–±–µ –æ—Ç–∫—Ä—ã—Ç–∞!"
    
async def get_user_level(user_id: int) -> int:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –£—Ä–æ–≤–µ–Ω—å –æ—Ç 1 –¥–æ 10
    """
    try:
        with sqlite3.connect(str(DB_PATH)) as conn:
            cursor = conn.cursor()
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor.execute("SELECT COUNT(*) FROM history WHERE user_id = ?", (user_id,))
            history_count = cursor.fetchone()[0] or 0
            
            # –£—Ä–æ–≤–µ–Ω—å: 1 —É—Ä–æ–≤–µ–Ω—å –∑–∞ –∫–∞–∂–¥—ã–µ 5 —Ä–∞—Å–∫–ª–∞–¥–æ–≤, –º–∞–∫—Å–∏–º—É–º 10
            level = min(history_count // 5 + 1, 10)
            
            logger.info(f"üîÆ User {user_id} level: {level} (based on {history_count} readings)")
            return level
            
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Error getting user level for {user_id}: {e}")
        return 1

async def get_user_achievements(user_id: int) -> List[str]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    """
    try:
        achievements = []
        
        with sqlite3.connect(str(DB_PATH)) as conn:
            cursor = conn.cursor()
            
            # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤
            cursor.execute("SELECT COUNT(*) FROM history WHERE user_id = ?", (user_id,))
            history_count = cursor.fetchone()[0] or 0
            
            if history_count >= 1:
                achievements.append("üå± –ù–æ–≤–∏—á–æ–∫")
            if history_count >= 5:
                achievements.append("üîÆ –ò—Å–∫–∞—Ç–µ–ª—å")
            if history_count >= 10:
                achievements.append("üåü –ú—É–¥—Ä–µ—Ü")
            if history_count >= 20:
                achievements.append("üí´ –ú–∞–≥")
            if history_count >= 50:
                achievements.append("‚ú® –ú–∞—Å—Ç–µ—Ä")
            if history_count >= 100:
                achievements.append("üëë –í–µ–ª–∏–∫–∏–π –ú–∞–≥")
            
            # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥—ã
            cursor.execute("SELECT COUNT(*) FROM history WHERE user_id = ? AND is_premium = TRUE", (user_id,))
            premium_count = cursor.fetchone()[0] or 0
            
            if premium_count >= 1:
                achievements.append("üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä")
            if premium_count >= 5:
                achievements.append("üíé –≠–ª–∏—Ç–Ω—ã–π")
            if premium_count >= 10:
                achievements.append("üíé –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä")
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
            cursor.execute("SELECT COUNT(*) FROM users WHERE referral_id = ?", (user_id,))
            referrals_count = cursor.fetchone()[0] or 0
            
            if referrals_count >= 1:
                achievements.append("ü§ù –ù–∞—Å—Ç–∞–≤–Ω–∏–∫")
            if referrals_count >= 3:
                achievements.append("üåô –ü—Ä–æ–≤–æ–¥–Ω–∏–∫")
            if referrals_count >= 5:
                achievements.append("ü§ù –ú–∞—Å—Ç–µ—Ä –ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞")
            
            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ä–∞—Å–∫–ª–∞–¥–æ–≤
            cursor.execute("""
                SELECT COUNT(DISTINCT reading_type) 
                FROM history 
                WHERE user_id = ? AND reading_type IS NOT NULL
            """, (user_id,))
            reading_types_count = cursor.fetchone()[0] or 0
            
            if reading_types_count >= 3:
                achievements.append("üìö –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—Å—Ç")
            
            # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º
            cursor.execute("""
                SELECT COUNT(DISTINCT DATE(timestamp)) 
                FROM history 
                WHERE user_id = ? AND timestamp >= datetime('now', '-7 days')
            """, (user_id,))
            active_days = cursor.fetchone()[0] or 0
            
            if active_days >= 7:
                achievements.append("üî• –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–∞–∫—Ç–∏–∫")
            
            logger.info(f"üîÆ User {user_id} achievements: {len(achievements)} achievements")
            
        return achievements
        
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Error getting user achievements for {user_id}: {e}")
        return []

async def get_premium_history_count(user_id: int) -> int:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        with sqlite3.connect(str(DB_PATH)) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT COUNT(*) FROM history WHERE user_id = ? AND is_premium = TRUE", (user_id,))
            return cursor.fetchone()[0] or 0
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Error getting premium history count for {user_id}: {e}")
        return 0

async def get_user_statistics(user_id: int) -> Dict[str, Any]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–º–∏
    """
    try:
        with sqlite3.connect(str(DB_PATH)) as conn:
            cursor = conn.cursor()
            
            stats = {}
            
            # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤
            cursor.execute("SELECT COUNT(*) FROM history WHERE user_id = ?", (user_id,))
            stats["total_readings"] = cursor.fetchone()[0] or 0
            
            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–º–∏—É–º-—Ä–∞—Å–∫–ª–∞–¥–æ–≤
            cursor.execute("SELECT COUNT(*) FROM history WHERE user_id = ? AND is_premium = TRUE", (user_id,))
            stats["premium_readings"] = cursor.fetchone()[0] or 0
            
            # –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç –≤ —Ä–∞—Å–∫–ª–∞–¥–µ
            cursor.execute("SELECT AVG(LENGTH(cards) - LENGTH(REPLACE(cards, ',', '')) + 1) FROM history WHERE user_id = ?", (user_id,))
            stats["avg_cards"] = round(cursor.fetchone()[0] or 0, 1)
            
            # –°–∞–º—ã–π —á–∞—Å—Ç—ã–π —Ç–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞
            cursor.execute("""
                SELECT reading_type, COUNT(*) as count 
                FROM history 
                WHERE user_id = ? AND reading_type IS NOT NULL
                GROUP BY reading_type 
                ORDER BY count DESC 
                LIMIT 1
            """, (user_id,))
            result = cursor.fetchone()
            stats["favorite_type"] = result[0] if result else "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω"
            
            # –î–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            cursor.execute("SELECT COUNT(DISTINCT DATE(timestamp)) FROM history WHERE user_id = ?", (user_id,))
            stats["active_days"] = cursor.fetchone()[0] or 0
            
            # –ü–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å–∫–ª–∞–¥
            cursor.execute("SELECT MIN(timestamp), MAX(timestamp) FROM history WHERE user_id = ?", (user_id,))
            dates = cursor.fetchone()
            stats["first_reading"] = dates[0] if dates[0] else None
            stats["last_reading"] = dates[1] if dates[1] else None
            
            # –£—Ä–æ–≤–µ–Ω—å
            stats["level"] = await get_user_level(user_id)
            
            # –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            stats["achievements"] = await get_user_achievements(user_id)
            stats["achievements_count"] = len(stats["achievements"])
            
            return stats
            
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Error getting user statistics for {user_id}: {e}")
        return {
            "total_readings": 0,
            "premium_readings": 0,
            "avg_cards": 0,
            "favorite_type": "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω",
            "active_days": 0,
            "level": 1,
            "achievements": [],
            "achievements_count": 0
        }